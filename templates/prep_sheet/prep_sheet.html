{% extends 'base_user.html' %}

{% block title %}Prep Sheet - {{ patient.full_name }} - HealthPrep{% endblock %}

{% block extra_css %}
<style>
@media print {
    .no-print { display: none !important; }
    .card { border: 1px solid #000 !important; box-shadow: none !important; }
    .prep-sheet { font-size: 12px; }
}

.prep-sheet-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 8px 8px 0 0;
}

.confidence-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
}

.confidence-high { background-color: #28a745; }
.confidence-medium { background-color: #ffc107; }
.confidence-low { background-color: #dc3545; }

.screening-status-complete { color: #28a745; }
.screening-status-due { color: #007bff; }
.screening-status-due_soon { color: #ffc107; }
.screening-status-overdue { color: #dc3545; }

.document-item {
    border-left: 4px solid #e9ecef;
    padding: 0.5rem 1rem;
    margin-bottom: 0.5rem;
    background-color: rgba(0,0,0,0.02);
}

.document-item.high-confidence { border-left-color: #28a745; }
.document-item.medium-confidence { border-left-color: #ffc107; }
.document-item.low-confidence { border-left-color: #dc3545; }

.prep-section {
    page-break-inside: avoid;
    margin-bottom: 2rem;
}

.checklist-item {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    background-color: #f8f9fa;
}

.signature-box {
    border: 1px solid #000;
    height: 60px;
    margin-top: 1rem;
    padding: 0.5rem;
    background-color: #fff;
}
</style>
{% endblock %}

{% block content %}
<div class="prep-sheet">
    <!-- Header Controls -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h1>
            <i class="fas fa-file-medical me-2 text-primary"></i>
            Medical Preparation Sheet
        </h1>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print me-1"></i>
                Print
            </button>
            <a href="{{ url_for('prep_sheet.regenerate', patient_id=patient.id) }}" class="btn btn-outline-success">
                <i class="fas fa-sync me-1"></i>
                Regenerate
            </a>
            <a href="{{ url_for('main.patient_detail', patient_id=patient.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Back to Patient
            </a>
        </div>
    </div>

    <!-- Patient Header -->
    <div class="card mb-4">
        <div class="prep-sheet-header">
            <div class="row">
                <div class="col-md-8">
                    <h2 class="mb-3">{{ patient.full_name }}</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>MRN:</strong> {{ patient.mrn }}<br>
                            <strong>DOB:</strong> {{ patient.date_of_birth.strftime('%m/%d/%Y') }}<br>
                            <strong>Age:</strong> {{ patient.age }} years
                        </div>
                        <div class="col-md-6">
                            <strong>Gender:</strong> {{ patient.gender }}<br>
                            {% if patient.phone %}
                                <strong>Phone:</strong> {{ patient.phone }}<br>
                            {% endif %}
                            {% if patient.email %}
                                <strong>Email:</strong> {{ patient.email }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="text-white-50">
                        <strong>Prep Sheet Generated:</strong><br>
                        {{ prep_sheet.generated_at.strftime('%m/%d/%Y %I:%M %p') }}
                        <br><br>
                        {% if prep_sheet.appointment_date %}
                            <strong>Appointment Date:</strong><br>
                            {{ prep_sheet.appointment_date.strftime('%m/%d/%Y') }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generation Summary -->
    <div class="row g-4 mb-4 no-print">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-primary">{{ prep_sheet.documents_processed or 0 }}</h4>
                    <small class="text-muted">Documents Processed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-success">{{ prep_sheet.screenings_included or 0 }}</h4>
                    <small class="text-muted">Screenings Reviewed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-info">{{ "%.1f"|format(prep_sheet.generation_time_seconds or 0) }}s</h4>
                    <small class="text-muted">Generation Time</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-warning">
                        <i class="fas fa-shield-alt"></i>
                    </h4>
                    <small class="text-muted">HIPAA Compliant</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Prep Sheet Content -->
    <div class="card">
        <div class="card-body">
            {% if prep_sheet.content %}
                {{ prep_sheet.content|safe }}
            {% else %}
                <!-- Fallback content structure -->
                <div class="prep-section">
                    <h3 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-user-md me-2"></i>
                        Patient Summary
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Active Conditions</h5>
                            {% set conditions = patient.conditions|selectattr('status', 'equalto', 'active')|list %}
                            {% if conditions %}
                                <ul class="list-unstyled">
                                    {% for condition in conditions %}
                                    <li class="mb-2">
                                        <strong>{{ condition.condition_name }}</strong>
                                        {% if condition.icd_code %}
                                            <span class="badge bg-secondary">{{ condition.icd_code }}</span>
                                        {% endif %}
                                        {% if condition.diagnosis_date %}
                                            <br><small class="text-muted">Diagnosed: {{ condition.diagnosis_date.strftime('%m/%d/%Y') }}</small>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <p class="text-muted">No active conditions recorded</p>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h5>Contact Information</h5>
                            {% if patient.emergency_contact %}
                                <p><strong>Emergency Contact:</strong> {{ patient.emergency_contact }}</p>
                            {% endif %}
                            {% if patient.address %}
                                <p><strong>Address:</strong><br>{{ patient.address }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="prep-section">
                    <h3 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Screening Status
                    </h3>
                    
                    {% set screenings = patient.screenings %}
                    {% if screenings %}
                        <div class="row">
                            {% for screening in screenings %}
                            <div class="col-md-6 mb-3">
                                <div class="card border-start border-4 border-{% if screening.status == 'complete' %}success{% elif screening.status == 'due_soon' %}warning{% elif screening.status == 'overdue' %}danger{% else %}primary{% endif %}">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ screening.screening_type.name }}</h6>
                                        <p class="card-text">
                                            <span class="badge bg-{% if screening.status == 'complete' %}success{% elif screening.status == 'due_soon' %}warning{% elif screening.status == 'overdue' %}danger{% else %}primary{% endif %}">
                                                {{ screening.status.replace('_', ' ').title() }}
                                            </span>
                                        </p>
                                        {% if screening.last_completed_date %}
                                            <small class="text-muted">Last completed: {{ screening.last_completed_date.strftime('%m/%d/%Y') }}</small>
                                        {% else %}
                                            <small class="text-muted">Never completed</small>
                                        {% endif %}
                                        {% if screening.next_due_date %}
                                            <br><small class="text-muted">Next due: {{ screening.next_due_date.strftime('%m/%d/%Y') }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No screenings configured for this patient</p>
                    {% endif %}
                </div>

                <div class="prep-section">
                    <h3 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-file-medical me-2"></i>
                        Recent Medical Documents
                    </h3>
                    
                    {% set recent_documents = patient.documents|sort(attribute='document_date', reverse=true)|list %}
                    {% if recent_documents %}
                        {% for doc in recent_documents[:10] %}
                        <div class="document-item {{ 'high-confidence' if doc.ocr_confidence and doc.ocr_confidence >= 0.8 else 'medium-confidence' if doc.ocr_confidence and doc.ocr_confidence >= 0.6 else 'low-confidence' }}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ doc.original_filename or doc.filename }}</strong>
                                    <span class="badge bg-secondary">{{ doc.document_type.title() if doc.document_type else 'Unknown' }}</span>
                                    {% if doc.ocr_confidence %}
                                        <span class="confidence-indicator {{ 'confidence-high' if doc.ocr_confidence >= 0.8 else 'confidence-medium' if doc.ocr_confidence >= 0.6 else 'confidence-low' }}"></span>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    {% if doc.document_date %}
                                        <small class="text-muted">{{ doc.document_date.strftime('%m/%d/%Y') }}</small>
                                    {% else %}
                                        <small class="text-muted">{{ doc.upload_date.strftime('%m/%d/%Y') }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if recent_documents|length > 10 %}
                            <p class="text-muted text-center mt-3">
                                ... and {{ recent_documents|length - 10 }} more documents
                            </p>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">No medical documents available</p>
                    {% endif %}
                </div>

                <div class="prep-section">
                    <h3 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-tasks me-2"></i>
                        Pre-Visit Checklist
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="checklist-item">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="vitals">
                                    <label class="form-check-label" for="vitals">
                                        Obtain vital signs (weight, height, BP, temp)
                                    </label>
                                </div>
                            </div>
                            
                            <div class="checklist-item">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="medications">
                                    <label class="form-check-label" for="medications">
                                        Review current medications and allergies
                                    </label>
                                </div>
                            </div>
                            
                            <div class="checklist-item">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="insurance">
                                    <label class="form-check-label" for="insurance">
                                        Verify insurance and contact information
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="checklist-item">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="screening-review">
                                    <label class="form-check-label" for="screening-review">
                                        Review screening recommendations
                                    </label>
                                </div>
                            </div>
                            
                            <div class="checklist-item">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="lab-review">
                                    <label class="form-check-label" for="lab-review">
                                        Review recent lab results and imaging
                                    </label>
                                </div>
                            </div>
                            
                            <div class="checklist-item">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="concerns">
                                    <label class="form-check-label" for="concerns">
                                        Address patient questions and concerns
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Signature Section -->
                <div class="prep-section">
                    <h3 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-signature me-2"></i>
                        Provider Notes & Signature
                    </h3>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Additional Notes:</strong></label>
                        <div class="signature-box">
                            <!-- Space for handwritten notes -->
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Provider Signature:</strong></label>
                            <div class="signature-box">
                                <!-- Space for signature -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Date:</strong></label>
                            <div class="signature-box">
                                <!-- Space for date -->
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-4 text-muted">
        <small>
            Generated by HealthPrep HIPAA-Compliant Preparation System | 
            Generated on {{ prep_sheet.generated_at.strftime('%m/%d/%Y at %I:%M %p') }}
        </small>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Print functionality
window.addEventListener('beforeprint', function() {
    document.title = `PrepSheet_${document.querySelector('.prep-sheet-header h2').textContent.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}`;
});

// Auto-save checklist state
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.form-check-input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
        // Load saved state
        const saved = localStorage.getItem(`checklist_${checkbox.id}`);
        if (saved === 'true') {
            checkbox.checked = true;
        }
        
        // Save state on change
        checkbox.addEventListener('change', function() {
            localStorage.setItem(`checklist_${this.id}`, this.checked);
        });
    });
});
</script>
{% endblock %}

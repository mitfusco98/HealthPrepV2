{% extends 'base_user.html' %}

{% block title %}Prep Sheet - {{ patient.full_name }} - HealthPrep{% endblock %}

{% block extra_css %}
<style>
@media print {
    .no-print { display: none !important; }
    .card { border: 1px solid #000 !important; box-shadow: none !important; }
    .prep-sheet { font-size: 12px; }
}

.prep-sheet-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 8px 8px 0 0;
}

.confidence-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 5px;
}

.confidence-high { background-color: #28a745; }
.confidence-medium { background-color: #ffc107; }
.confidence-low { background-color: #dc3545; }

.screening-status-complete { color: #28a745; }
.screening-status-due { color: #007bff; }
.screening-status-due_soon { color: #ffc107; }
.screening-status-overdue { color: #dc3545; }

.document-item {
    border-left: 4px solid #e9ecef;
    padding: 0.5rem 1rem;
    margin-bottom: 0.5rem;
    background-color: rgba(0,0,0,0.02);
}

.document-item.high-confidence { border-left-color: #28a745; }
.document-item.medium-confidence { border-left-color: #ffc107; }
.document-item.low-confidence { border-left-color: #dc3545; }

.prep-section {
    page-break-inside: avoid;
    margin-bottom: 2rem;
}

.checklist-item {
    padding: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    background-color: #f8f9fa;
}

.signature-box {
    border: 1px solid #000;
    height: 60px;
    margin-top: 1rem;
    padding: 0.5rem;
    background-color: #fff;
}
</style>
{% endblock %}

{% block content %}
<div class="prep-sheet">
    <!-- Header Controls -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h1>
            <i class="fas fa-file-medical me-2 text-primary"></i>
            Medical Preparation Sheet
        </h1>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-primary" onclick="window.print()">
                <i class="fas fa-print me-1"></i>
                Print
            </button>
            <a href="{{ url_for('prep_sheet.regenerate', patient_id=patient.id) }}" class="btn btn-outline-success">
                <i class="fas fa-sync me-1"></i>
                Regenerate
            </a>
            <a href="{{ url_for('main.patient_detail', patient_id=patient.id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Back to Patient
            </a>
        </div>
    </div>

    <!-- Patient Header -->
    <div class="card mb-4">
        <div class="prep-sheet-header">
            <div class="row">
                <div class="col-md-8">
                    <h2 class="mb-3">{{ patient.full_name }}</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>MRN:</strong> {{ patient.mrn }}<br>
                            <strong>DOB:</strong> {{ patient.date_of_birth.strftime('%m/%d/%Y') }}<br>
                            <strong>Age:</strong> {{ patient.age }} years
                        </div>
                        <div class="col-md-6">
                            <strong>Gender:</strong> {{ patient.gender }}<br>
                            {% if patient.phone %}
                                <strong>Phone:</strong> {{ patient.phone }}<br>
                            {% endif %}
                            {% if patient.email %}
                                <strong>Email:</strong> {{ patient.email }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="text-white-50">
                        <strong>Prep Sheet Generated:</strong><br>
                        {{ prep_sheet.generated_at.strftime('%m/%d/%Y %I:%M %p') }}
                        <br><br>
                        {% if prep_sheet.appointment_date %}
                            <strong>Appointment Date:</strong><br>
                            {{ prep_sheet.appointment_date.strftime('%m/%d/%Y') }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generation Summary -->
    <div class="row g-4 mb-4 no-print">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-primary">{{ prep_sheet.documents_processed or 0 }}</h4>
                    <small class="text-muted">Documents Processed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-success">{{ prep_sheet.screenings_included or 0 }}</h4>
                    <small class="text-muted">Screenings Reviewed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-info">{{ "%.1f"|format(prep_sheet.generation_time_seconds or 0) }}s</h4>
                    <small class="text-muted">Generation Time</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h4 class="text-warning">
                        <i class="fas fa-shield-alt"></i>
                    </h4>
                    <small class="text-muted">HIPAA Compliant</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Prep Sheet Content -->
    <div class="card">
        <div class="card-body">
            {% if prep_sheet.content %}
                {{ prep_sheet.content|safe }}
            {% else %}
                <!-- Fallback content structure -->
                <div class="prep-section">
                    <h3 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-user-md me-2"></i>
                        Patient Summary
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Recent Visit History</h5>
                            {% if prep_sheet.content and 'summary' in prep_sheet.content and prep_sheet.content.summary.recent_appointments %}
                                {% set recent_appointments = prep_sheet.content.summary.recent_appointments %}
                                {% if recent_appointments %}
                                    <ul class="list-unstyled">
                                        {% for appointment in recent_appointments[:5] %}
                                        <li class="mb-2">
                                            <strong>{{ appointment.appointment_date.strftime('%m/%d/%Y') }}</strong>
                                            {% if appointment.appointment_type %}
                                                - {{ appointment.appointment_type }}
                                            {% endif %}
                                            {% if appointment.provider %}
                                                <br><small class="text-muted">Provider: {{ appointment.provider }}</small>
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted">No recent appointments on record</p>
                                {% endif %}
                            {% else %}
                                <p class="text-muted">Visit history not available</p>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <h5>Active Medical Conditions</h5>
                            {% if prep_sheet.content and 'summary' in prep_sheet.content and prep_sheet.content.summary.active_conditions %}
                                {% set conditions = prep_sheet.content.summary.active_conditions %}
                                {% if conditions %}
                                    <ul class="list-unstyled">
                                        {% for condition in conditions %}
                                        <li class="mb-2">
                                            <strong>{{ condition.condition_name }}</strong>
                                            {% if condition.icd_code %}
                                                <span class="badge bg-secondary">{{ condition.icd_code }}</span>
                                            {% endif %}
                                            {% if condition.diagnosis_date %}
                                                <br><small class="text-muted">Diagnosed: {{ condition.diagnosis_date.strftime('%m/%d/%Y') }}</small>
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted">No active conditions recorded</p>
                                {% endif %}
                            {% else %}
                                <p class="text-muted">Condition information not available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="prep-section">
                    <h3 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Quality Checklist - Screening Status
                    </h3>
                    
                    {% if prep_sheet.content and 'quality_checklist' in prep_sheet.content %}
                        {% set checklist_items = prep_sheet.content.quality_checklist %}
                    {% else %}
                        {% set checklist_items = patient.screenings %}
                    {% endif %}

                    {% if checklist_items %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Screening</th>
                                        <th>Last Completed</th>
                                        <th>Frequency</th>
                                        <th>Status</th>
                                        <th>Matched Documents</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in checklist_items %}
                                    {% if item.screening_type %}
                                        {% set screening = item %}
                                        {% set screening_name = screening.screening_type.display_name %}
                                        {% set frequency = screening.screening_type.frequency_display %}
                                        {% set status = screening.status %}
                                        {% set last_completed = screening.last_completed %}
                                        {% set matched_docs = screening.matched_documents_list %}
                                    {% else %}
                                        {% set screening_name = item.screening_name %}
                                        {% set frequency = item.frequency %}
                                        {% set status = item.status %}
                                        {% set last_completed = item.last_completed %}
                                        {% set matched_docs = item.matched_documents %}
                                    {% endif %}
                                    <tr>
                                        <td>
                                            <strong>{{ screening_name }}</strong>
                                            {% if screening.screening_type and screening.screening_type.variant_name %}
                                                <br><small class="text-muted">{{ screening.screening_type.variant_name }} variant</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if last_completed %}
                                                {{ last_completed.strftime('%m/%d/%Y') }}
                                            {% else %}
                                                <span class="text-muted">Never</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ frequency }}</span>
                                        </td>
                                        <td>
                                            {% if status == 'Complete' %}
                                                <span class="badge bg-success">{{ status }}</span>
                                            {% elif status == 'Due Soon' %}
                                                <span class="badge bg-warning text-dark">{{ status }}</span>
                                            {% elif status == 'Due' %}
                                                <span class="badge bg-primary">{{ status }}</span>
                                            {% elif status == 'Overdue' %}
                                                <span class="badge bg-danger">{{ status }}</span>
                                            {% else %}
                                                <span class="badge bg-light text-dark">{{ status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if matched_docs and matched_docs|length > 0 %}
                                                {% for doc in matched_docs[:3] %}
                                                    <a href="{{ url_for('document.view_document', document_id=doc.id) }}" 
                                                       target="_blank" 
                                                       class="btn btn-sm btn-outline-primary mb-1 me-1"
                                                       title="View {{ doc.filename }}">
                                                        <i class="fas fa-file-medical me-1"></i>
                                                        {{ doc.filename[:15] }}...
                                                        {% if doc.ocr_confidence %}
                                                            <span class="confidence-indicator {{ 'confidence-high' if doc.ocr_confidence >= 0.8 else 'confidence-medium' if doc.ocr_confidence >= 0.6 else 'confidence-low' }}"></span>
                                                        {% endif %}
                                                    </a>
                                                {% endfor %}
                                                {% if matched_docs|length > 3 %}
                                                    <br><small class="text-muted">+{{ matched_docs|length - 3 }} more documents</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">No matching documents</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No screenings configured for this patient. 
                            <a href="{{ url_for('screening.screening_types') }}" target="_blank">Configure screening types</a> 
                            to enable quality checklist generation.
                        </div>
                    {% endif %}
                </div>

                <!-- Recent Medical Data Sections -->
                {% if prep_sheet.content and 'medical_data' in prep_sheet.content %}
                    {% set medical_data = prep_sheet.content.medical_data %}
                    {% set cutoff_dates = medical_data.cutoff_dates %}
                    
                    <!-- Recent Lab Results -->
                    <div class="prep-section">
                        <h3 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-flask me-2"></i>
                            Recent Lab Results
                            <small class="text-muted">
                                ({{ cutoff_dates.labs.strftime('%m/%d/%Y') if cutoff_dates and cutoff_dates.labs else 'last 12 months' }})
                            </small>
                        </h3>
                        
                        {% if medical_data.lab_results and medical_data.lab_results|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Date</th>
                                            <th>Results</th>
                                            <th>Reference Range</th>
                                            <th>Status</th>
                                            <th>Document</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for doc in medical_data.lab_results %}
                                        <tr>
                                            <td>{{ doc.test_name or doc.filename }}</td>
                                            <td>{{ doc.document_date.strftime('%m/%d/%Y') if doc.document_date else 'N/A' }}</td>
                                            <td>{{ doc.result_value or 'See document' }}</td>
                                            <td>{{ doc.reference_range or 'N/A' }}</td>
                                            <td>
                                                {% if doc.result_status == 'normal' %}
                                                    <span class="badge bg-success">Normal</span>
                                                {% elif doc.result_status == 'abnormal' %}
                                                    <span class="badge bg-warning text-dark">Abnormal</span>
                                                {% elif doc.result_status == 'critical' %}
                                                    <span class="badge bg-danger">Critical</span>
                                                {% else %}
                                                    <span class="badge bg-light text-dark">Pending</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('document.view_document', document_id=doc.id) }}" 
                                                   target="_blank" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">No recent lab results available</p>
                        {% endif %}
                    </div>

                    <!-- Recent Imaging Studies -->
                    <div class="prep-section">
                        <h3 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-x-ray me-2"></i>
                            Recent Imaging Studies
                            <small class="text-muted">
                                ({{ cutoff_dates.imaging.strftime('%m/%d/%Y') if cutoff_dates and cutoff_dates.imaging else 'last 12 months' }})
                            </small>
                        </h3>
                        
                        {% if medical_data.imaging_studies and medical_data.imaging_studies|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Study Type</th>
                                            <th>Body Site</th>
                                            <th>Date</th>
                                            <th>Impression</th>
                                            <th>Document</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for doc in medical_data.imaging_studies %}
                                        <tr>
                                            <td>{{ doc.study_type or doc.filename }}</td>
                                            <td>{{ doc.body_site or 'N/A' }}</td>
                                            <td>{{ doc.document_date.strftime('%m/%d/%Y') if doc.document_date else 'N/A' }}</td>
                                            <td>{{ doc.impression or 'See document' }}</td>
                                            <td>
                                                <a href="{{ url_for('document.view_document', document_id=doc.id) }}" 
                                                   target="_blank" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">No recent imaging studies available</p>
                        {% endif %}
                    </div>

                    <!-- Recent Specialist Consults -->
                    <div class="prep-section">
                        <h3 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-user-md me-2"></i>
                            Recent Specialist Consults
                            <small class="text-muted">
                                ({{ cutoff_dates.consults.strftime('%m/%d/%Y') if cutoff_dates and cutoff_dates.consults else 'last 12 months' }})
                            </small>
                        </h3>
                        
                        {% if medical_data.specialist_consults and medical_data.specialist_consults|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Specialty</th>
                                            <th>Specialist</th>
                                            <th>Date</th>
                                            <th>Recommendations</th>
                                            <th>Document</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for doc in medical_data.specialist_consults %}
                                        <tr>
                                            <td>{{ doc.specialty or 'Unknown' }}</td>
                                            <td>{{ doc.specialist_name or 'See document' }}</td>
                                            <td>{{ doc.document_date.strftime('%m/%d/%Y') if doc.document_date else 'N/A' }}</td>
                                            <td>{{ doc.recommendations or 'See document' }}</td>
                                            <td>
                                                <a href="{{ url_for('document.view_document', document_id=doc.id) }}" 
                                                   target="_blank" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">No recent specialist consults available</p>
                        {% endif %}
                    </div>

                    <!-- Recent Hospital Stays -->
                    <div class="prep-section">
                        <h3 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-hospital me-2"></i>
                            Recent Hospital Stays
                            <small class="text-muted">
                                ({{ cutoff_dates.hospital.strftime('%m/%d/%Y') if cutoff_dates and cutoff_dates.hospital else 'last 12 months' }})
                            </small>
                        </h3>
                        
                        {% if medical_data.hospital_stays and medical_data.hospital_stays|length > 0 %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Hospital</th>
                                            <th>Admission Date</th>
                                            <th>Discharge Date</th>
                                            <th>Diagnosis</th>
                                            <th>Document</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for doc in medical_data.hospital_stays %}
                                        <tr>
                                            <td>{{ doc.hospital_name or 'See document' }}</td>
                                            <td>{{ doc.admission_date.strftime('%m/%d/%Y') if doc.admission_date else 'N/A' }}</td>
                                            <td>{{ doc.discharge_date.strftime('%m/%d/%Y') if doc.discharge_date else 'N/A' }}</td>
                                            <td>{{ doc.discharge_diagnosis or 'See document' }}</td>
                                            <td>
                                                <a href="{{ url_for('document.view_document', document_id=doc.id) }}" 
                                                   target="_blank" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="text-muted">No recent hospital stays available</p>
                        {% endif %}
                    </div>
                {% else %}
                    <!-- Fallback Recent Documents Section -->
                    <div class="prep-section">
                        <h3 class="border-bottom pb-2 mb-3">
                            <i class="fas fa-file-medical me-2"></i>
                            Recent Medical Documents
                        </h3>
                        
                        {% set recent_documents = patient.documents|sort(attribute='document_date', reverse=true)|list %}
                        {% if recent_documents %}
                            {% for doc in recent_documents[:10] %}
                            <div class="document-item {{ 'high-confidence' if doc.ocr_confidence and doc.ocr_confidence >= 0.8 else 'medium-confidence' if doc.ocr_confidence and doc.ocr_confidence >= 0.6 else 'low-confidence' }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <a href="{{ url_for('document.view_document', document_id=doc.id) }}" 
                                           target="_blank" 
                                           class="text-decoration-none">
                                            <strong>{{ doc.original_filename or doc.filename }}</strong>
                                        </a>
                                        <span class="badge bg-secondary">{{ doc.document_type.title() if doc.document_type else 'Unknown' }}</span>
                                        {% if doc.ocr_confidence %}
                                            <span class="confidence-indicator {{ 'confidence-high' if doc.ocr_confidence >= 0.8 else 'confidence-medium' if doc.ocr_confidence >= 0.6 else 'confidence-low' }}"></span>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        {% if doc.document_date %}
                                            <small class="text-muted">{{ doc.document_date.strftime('%m/%d/%Y') }}</small>
                                        {% else %}
                                            <small class="text-muted">{{ doc.upload_date.strftime('%m/%d/%Y') }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            
                            {% if recent_documents|length > 10 %}
                                <p class="text-muted text-center mt-3">
                                    ... and {{ recent_documents|length - 10 }} more documents
                                </p>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No medical documents available</p>
                        {% endif %}
                    </div>
                {% endif %}

                <div class="prep-section">
                    <h3 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-tasks me-2"></i>
                        Pre-Visit Checklist
                    </h3>
                    
                    {% if prep_sheet.content and 'enhanced_data' in prep_sheet.content and prep_sheet.content.enhanced_data.checklist_items %}
                        {% set checklist_items = prep_sheet.content.enhanced_data.checklist_items %}
                        <div class="row">
                            {% for item in checklist_items %}
                            <div class="col-md-6 mb-2">
                                <div class="checklist-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="checklist-{{ loop.index }}">
                                        <label class="form-check-label" for="checklist-{{ loop.index }}">
                                            {{ item }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Default checklist items -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="checklist-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="vitals">
                                        <label class="form-check-label" for="vitals">
                                            Obtain vital signs (weight, height, BP, temp)
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="checklist-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="medications">
                                        <label class="form-check-label" for="medications">
                                            Review current medications and allergies
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="checklist-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="insurance">
                                        <label class="form-check-label" for="insurance">
                                            Verify insurance and contact information
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="checklist-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="screening-review">
                                        <label class="form-check-label" for="screening-review">
                                            Review screening recommendations
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="checklist-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="document-review">
                                        <label class="form-check-label" for="document-review">
                                            Review recent lab/imaging results
                                        </label>
                                    </div>
                                </div>
                                
                                <div class="checklist-item">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="update-plan">
                                        <label class="form-check-label" for="update-plan">
                                            Update care plan and next steps
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                            
                            <div class="checklist-item">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="lab-review">
                                    <label class="form-check-label" for="lab-review">
                                        Review recent lab results and imaging
                                    </label>
                                </div>
                            </div>
                            
                            <div class="checklist-item">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="concerns">
                                    <label class="form-check-label" for="concerns">
                                        Address patient questions and concerns
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Signature Section -->
                <div class="prep-section">
                    <h3 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-signature me-2"></i>
                        Provider Notes & Signature
                    </h3>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Additional Notes:</strong></label>
                        <div class="signature-box">
                            <!-- Space for handwritten notes -->
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label"><strong>Provider Signature:</strong></label>
                            <div class="signature-box">
                                <!-- Space for signature -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"><strong>Date:</strong></label>
                            <div class="signature-box">
                                <!-- Space for date -->
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer -->
    <div class="text-center mt-4 text-muted">
        <small>
            Generated by HealthPrep HIPAA-Compliant Preparation System | 
            Generated on {{ prep_sheet.generated_at.strftime('%m/%d/%Y at %I:%M %p') }}
        </small>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Print functionality
window.addEventListener('beforeprint', function() {
    document.title = `PrepSheet_${document.querySelector('.prep-sheet-header h2').textContent.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}`;
});

// Auto-save checklist state
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.form-check-input[type="checkbox"]');
    
    checkboxes.forEach(checkbox => {
        // Load saved state
        const saved = localStorage.getItem(`checklist_${checkbox.id}`);
        if (saved === 'true') {
            checkbox.checked = true;
        }
        
        // Save state on change
        checkbox.addEventListener('change', function() {
            localStorage.setItem(`checklist_${this.id}`, this.checked);
        });
    });
});
</script>
{% endblock %}

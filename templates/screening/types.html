{% extends 'base_user.html' %}

{% block title %}{% if mode == 'add' %}Add{% else %}Edit{% endif %} Screening Type - HealthPrep{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-{% if mode == 'add' %}plus{% else %}edit{% endif %} me-2"></i>
                    {% if mode == 'add' %}Add New{% else %}Edit{% endif %} Screening Type
                </h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="name" class="form-label">
                                    <i class="fas fa-tag me-1"></i>Screening Name *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="name" 
                                       name="name" 
                                       value="{{ form.name.data or '' }}" 
                                       required 
                                       placeholder="e.g., Mammogram, Colonoscopy">
                                {% if form.name.errors %}
                                    <div class="text-danger small">{{ form.name.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-toggle-on me-1"></i>Status
                                </label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="is_active" 
                                           name="is_active" 
                                           checked>
                                    <label class="form-check-label" for="is_active">
                                        Active
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">
                            <i class="fas fa-align-left me-1"></i>Description
                        </label>
                        <textarea class="form-control" 
                                  id="description" 
                                  name="description" 
                                  rows="3" 
                                  placeholder="Brief description of this screening type">{{ form.description.data or '' }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="keywords" class="form-label">
                            <i class="fas fa-search me-1"></i>Keywords (comma-separated)
                        </label>
                        <textarea class="form-control" 
                                  id="keywords" 
                                  name="keywords" 
                                  rows="2" 
                                  placeholder="e.g., mammogram, mammography, breast imaging">{{ form.keywords.data or '' }}</textarea>
                        <div class="form-text">
                            These keywords will be used to match documents to this screening type.
                            Use medical terminology and common variations.
                        </div>
                    </div>
                    
                    <!-- Eligibility Criteria -->
                    <h5 class="mt-4 mb-3">
                        <i class="fas fa-users me-2"></i>Eligibility Criteria
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="min_age" class="form-label">Minimum Age</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="min_age" 
                                       name="min_age" 
                                       min="0" 
                                       max="120" 
                                       value="{{ form.min_age.data or '' }}" 
                                       placeholder="e.g., 40">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="max_age" class="form-label">Maximum Age</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="max_age" 
                                       name="max_age" 
                                       min="0" 
                                       max="120" 
                                       value="{{ form.max_age.data or '' }}" 
                                       placeholder="e.g., 74">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="gender_restriction" class="form-label">Gender</label>
                                <select class="form-select" id="gender_restriction" name="gender_restriction">
                                    <option value="any" {% if form.gender_restriction.data == 'any' %}selected{% endif %}>Any</option>
                                    <option value="male" {% if form.gender_restriction.data == 'male' %}selected{% endif %}>Male</option>
                                    <option value="female" {% if form.gender_restriction.data == 'female' %}selected{% endif %}>Female</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Frequency Settings -->
                    <h5 class="mt-4 mb-3">
                        <i class="fas fa-clock me-2"></i>Frequency Settings
                    </h5>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="frequency_value" class="form-label">Frequency Value *</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="frequency_value" 
                                       name="frequency_value" 
                                       min="1" 
                                       value="{{ form.frequency_value.data or '' }}" 
                                       required 
                                       placeholder="e.g., 1, 2, 6">
                                {% if form.frequency_value.errors %}
                                    <div class="text-danger small">{{ form.frequency_value.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="frequency_unit" class="form-label">Frequency Unit *</label>
                                <select class="form-select" id="frequency_unit" name="frequency_unit" required>
                                    <option value="months" {% if form.frequency_unit.data == 'months' %}selected{% endif %}>Months</option>
                                    <option value="years" {% if form.frequency_unit.data == 'years' %}selected{% endif %}>Years</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="trigger_conditions" class="form-label">
                            <i class="fas fa-stethoscope me-1"></i>Trigger Conditions (comma-separated)
                        </label>
                        <textarea class="form-control" 
                                  id="trigger_conditions" 
                                  name="trigger_conditions" 
                                  rows="2" 
                                  placeholder="e.g., diabetes, hypertension">{{ form.trigger_conditions.data or '' }}</textarea>
                        <div class="form-text">
                            Leave empty if no specific conditions are required. 
                            These conditions will trigger this screening for eligible patients.
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('screening_list', tab='types') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            {% if mode == 'add' %}Create{% else %}Update{% endif %} Screening Type
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Help Card -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-question-circle me-2"></i>Help & Examples
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Common Keyword Examples:</h6>
                        <ul class="list-unstyled small">
                            <li><strong>Mammogram:</strong> mammogram, mammography, breast imaging, breast screening</li>
                            <li><strong>Colonoscopy:</strong> colonoscopy, colon screening, colorectal screening</li>
                            <li><strong>A1C:</strong> a1c, hemoglobin a1c, hba1c, glycohemoglobin</li>
                            <li><strong>Bone Density:</strong> dexa, dxa, bone density, bone scan</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Frequency Guidelines:</h6>
                        <ul class="list-unstyled small">
                            <li><strong>Annual screenings:</strong> 1 year</li>
                            <li><strong>Biennial screenings:</strong> 2 years</li>
                            <li><strong>Quarterly monitoring:</strong> 3 months</li>
                            <li><strong>Colonoscopy:</strong> 10 years (normal risk)</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Trigger Conditions:</h6>
                    <p class="small text-muted">
                        Use medical condition names that might appear in patient records. 
                        The system uses fuzzy matching to recognize variations like "diabetes" matching "diabetes mellitus" or "DM".
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-suggest keywords based on screening name
    const nameInput = document.getElementById('name');
    const keywordsInput = document.getElementById('keywords');
    
    const keywordSuggestions = {
        'mammogram': 'mammogram, mammography, breast imaging, breast screening',
        'colonoscopy': 'colonoscopy, colon screening, colorectal screening, colo screening',
        'pap': 'pap smear, pap test, cervical screening, cytology',
        'a1c': 'a1c, hemoglobin a1c, hba1c, glycohemoglobin',
        'cholesterol': 'cholesterol, lipid panel, lipids, lipid profile',
        'bone density': 'dexa, dxa, bone density, bone scan, osteoporosis screening',
        'blood pressure': 'blood pressure, bp check, hypertension screening',
        'eye exam': 'eye exam, ophthalmology, vision screening, eye screening'
    };
    
    nameInput.addEventListener('blur', function() {
        const name = this.value.toLowerCase();
        if (!keywordsInput.value) {
            for (const [key, suggestions] of Object.entries(keywordSuggestions)) {
                if (name.includes(key)) {
                    keywordsInput.value = suggestions;
                    break;
                }
            }
        }
    });
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const minAge = parseInt(document.getElementById('min_age').value);
        const maxAge = parseInt(document.getElementById('max_age').value);
        
        if (minAge && maxAge && minAge >= maxAge) {
            e.preventDefault();
            alert('Maximum age must be greater than minimum age.');
            return false;
        }
    });
});
</script>
{% endblock %}

{% extends 'base_user.html' %}

{% block title %}Screening Settings - HealthPrep{% endblock %}

{% block content %}
<!-- Screening Management Navigation -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-stethoscope me-2 text-primary"></i>
        Screening Management
    </h1>
</div>

<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-4" id="screeningTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link" href="{{ url_for('screening.screening_list') }}" role="tab">
            <i class="fas fa-list me-1"></i>
            Screening List
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link" href="{{ url_for('screening.screening_types') }}" role="tab">
            <i class="fas fa-tags me-1"></i>
            Screening Types
        </a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link active" href="{{ url_for('screening.screening_settings') }}" role="tab">
            <i class="fas fa-cog me-1"></i>
            Settings
        </a>
    </li>
</ul>

<!-- Settings Content -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Prep Sheet Data Cutoff Configuration
                </h5>
            </div>
            <div class="card-body">
                <!-- Quick Preset Buttons -->
                <div class="mb-4">
                    <h6 class="mb-3">Quick Presets</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="applyPreset('conservative')">
                            <i class="fas fa-shield-alt me-1"></i>Conservative (3 months)
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="applyPreset('standard')">
                            <i class="fas fa-balance-scale me-1"></i>Standard (6 months)
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="applyPreset('extended')">
                            <i class="fas fa-clock me-1"></i>Extended (12 months)
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="applyPreset('last_appointment')">
                            <i class="fas fa-user-clock me-1"></i>To Last Appointment
                        </button>
                    </div>
                    <div class="form-text mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        Quick presets apply the same cutoff to all data types. You can customize individual settings below.
                    </div>
                </div>

                <form method="POST" id="settingsForm">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.labs_cutoff_months.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.labs_cutoff_months(class="form-control") }}
                                    <span class="input-group-text">months</span>
                                </div>
                                <div class="form-text">
                                    <span class="cutoff-description" id="labs-description">{{ settings.get_cutoff_description('labs') if settings else '12 months' }}</span>
                                    <br><small class="text-muted">Lab results, blood work, urine tests</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.imaging_cutoff_months.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.imaging_cutoff_months(class="form-control") }}
                                    <span class="input-group-text">months</span>
                                </div>
                                <div class="form-text">
                                    <span class="cutoff-description" id="imaging-description">{{ settings.get_cutoff_description('imaging') if settings else '12 months' }}</span>
                                    <br><small class="text-muted">X-rays, CT scans, MRI, ultrasounds</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.consults_cutoff_months.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.consults_cutoff_months(class="form-control") }}
                                    <span class="input-group-text">months</span>
                                </div>
                                <div class="form-text">
                                    <span class="cutoff-description" id="consults-description">{{ settings.get_cutoff_description('consults') if settings else '12 months' }}</span>
                                    <br><small class="text-muted">Specialist notes, referral reports</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.hospital_cutoff_months.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.hospital_cutoff_months(class="form-control") }}
                                    <span class="input-group-text">months</span>
                                </div>
                                <div class="form-text">
                                    <span class="cutoff-description" id="hospital-description">{{ settings.get_cutoff_description('hospital') if settings else '12 months' }}</span>
                                    <br><small class="text-muted">Admission records, discharge summaries</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">
                    <h6 class="mb-3">
                        <i class="fas fa-filter me-2"></i>
                        Document Keyword Filtering
                    </h6>
                    <p class="text-muted small mb-3">
                        Documents must contain at least one of these keywords (comma-separated) to be included in the prep sheet for each category.
                    </p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.consults_keywords.label(class="form-label") }}
                                {{ form.consults_keywords(class="form-control") }}
                                <div class="form-text">
                                    <small class="text-muted">Keywords to identify consult documents (e.g., consult, referral, specialist)</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.hospital_keywords.label(class="form-label") }}
                                {{ form.hospital_keywords(class="form-control") }}
                                <div class="form-text">
                                    <small class="text-muted">Keywords to identify hospital records (e.g., hospital, admission, discharge)</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            Save Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                            <i class="fas fa-undo me-1"></i>
                            Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Current Settings Summary
                </h6>
            </div>
            <div class="card-body">
                {% if settings %}
                    <dl class="row">
                        <dt class="col-sm-5">Laboratory:</dt>
                        <dd class="col-sm-7">
                            <span class="badge bg-{{ 'warning' if settings.labs_cutoff_months == 0 else 'primary' }}">
                                {{ settings.get_cutoff_description('labs') }}
                            </span>
                        </dd>
                        
                        <dt class="col-sm-5">Imaging:</dt>
                        <dd class="col-sm-7">
                            <span class="badge bg-{{ 'warning' if settings.imaging_cutoff_months == 0 else 'primary' }}">
                                {{ settings.get_cutoff_description('imaging') }}
                            </span>
                        </dd>
                        
                        <dt class="col-sm-5">Consults:</dt>
                        <dd class="col-sm-7">
                            <span class="badge bg-{{ 'warning' if settings.consults_cutoff_months == 0 else 'primary' }}">
                                {{ settings.get_cutoff_description('consults') }}
                            </span>
                        </dd>
                        
                        <dt class="col-sm-5">Hospital:</dt>
                        <dd class="col-sm-7">
                            <span class="badge bg-{{ 'warning' if settings.hospital_cutoff_months == 0 else 'primary' }}">
                                {{ settings.get_cutoff_description('hospital') }}
                            </span>
                        </dd>
                    </dl>
                    
                    {% if settings.updated_at %}
                        <small class="text-muted">
                            Last updated: {{ settings.updated_at.strftime('%m/%d/%Y %H:%M') }}
                        </small>
                    {% endif %}
                {% else %}
                    <p class="text-muted">No settings configured yet.</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Best Practices
                </h6>
            </div>
            <div class="card-body">
                <h6 class="mb-3">Recommended Practices</h6>
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-flask text-primary me-2"></i>
                        <strong>Labs:</strong> 3-6 months for chronic conditions, 12+ months for routine
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-x-ray text-info me-2"></i>
                        <strong>Imaging:</strong> 6-12 months for follow-ups, 24+ months for screening
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-user-md text-success me-2"></i>
                        <strong>Consults:</strong> 3-6 months for active care, 12+ months for stable conditions
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-hospital text-danger me-2"></i>
                        <strong>Hospital:</strong> 6-12 months for recent admissions
                    </li>
                </ul>
                
                <h6 class="mb-3 mt-4">Cutoff Logic</h6>
                <p class="mb-2">The system applies cutoffs in this hierarchy:</p>
                <ol class="mb-2">
                    <li><strong>Data type-specific cutoffs</strong> - Individual values set above</li>
                    <li><strong>"To Last Appointment" fallback</strong> - When set to 0, uses patient's last appointment date</li>
                    <li><strong>Default fallback</strong> - 6 months ago if no past appointments found</li>
                </ol>
                <p class="mb-0">
                    <strong>Note:</strong> Setting any cutoff to <code>0</code> enables "To Last Appointment" mode for that data type.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function applyPreset(presetName) {
    const presets = {
        'conservative': {labs: 3, imaging: 3, consults: 3, hospital: 3},
        'standard': {labs: 6, imaging: 6, consults: 6, hospital: 6},
        'extended': {labs: 12, imaging: 12, consults: 12, hospital: 12},
        'last_appointment': {labs: 0, imaging: 0, consults: 0, hospital: 0}
    };
    
    if (presets[presetName]) {
        const preset = presets[presetName];
        document.getElementById('labs_cutoff_months').value = preset.labs;
        document.getElementById('imaging_cutoff_months').value = preset.imaging;
        document.getElementById('consults_cutoff_months').value = preset.consults;
        document.getElementById('hospital_cutoff_months').value = preset.hospital;
        
        // Update descriptions
        updateAllDescriptions();
        
        // Visual feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Applied!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-info', 'btn-outline-primary', 'btn-outline-success', 'btn-outline-warning');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add(btn.textContent.includes('Conservative') ? 'btn-outline-info' : 
                             btn.textContent.includes('Standard') ? 'btn-outline-primary' :
                             btn.textContent.includes('Extended') ? 'btn-outline-success' : 'btn-outline-warning');
        }, 1500);
    }
}

function updateDescription(fieldName) {
    const value = document.getElementById(fieldName + '_cutoff_months').value;
    const description = document.getElementById(fieldName + '-description');
    
    if (value == 0) {
        description.textContent = 'To Last Appointment';
        description.parentElement.classList.add('text-warning');
        description.parentElement.classList.remove('text-muted');
    } else if (value == 1) {
        description.textContent = '1 month';
        description.parentElement.classList.remove('text-warning');
        description.parentElement.classList.add('text-muted');
    } else {
        description.textContent = value + ' months';
        description.parentElement.classList.remove('text-warning');
        description.parentElement.classList.add('text-muted');
    }
}

function updateAllDescriptions() {
    ['labs', 'imaging', 'consults', 'hospital'].forEach(fieldName => {
        updateDescription(fieldName);
    });
}

function resetForm() {
    document.getElementById('settingsForm').reset();
    updateAllDescriptions();
}

// Add event listeners for real-time updates
document.addEventListener('DOMContentLoaded', function() {
    ['labs', 'imaging', 'consults', 'hospital'].forEach(fieldName => {
        const field = document.getElementById(fieldName + '_cutoff_months');
        if (field) {
            field.addEventListener('input', () => updateDescription(fieldName));
            // Initial update
            updateDescription(fieldName);
        }
    });
});
</script>
{% endblock %}
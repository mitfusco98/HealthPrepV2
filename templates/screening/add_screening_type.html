{% extends 'base_user.html' %}

{% block title %}HealthPrep - Add Screening Type{% endblock %}

{% block extra_css %}
<style>
.screening-form .form-group {
    margin-bottom: 1.5rem;
}

.keywords-help {
    background-color: rgba(13, 110, 253, 0.1);
    border-left: 4px solid #0d6efd;
    padding: 1rem;
    margin-top: 0.5rem;
}

.medical-variants {
    background-color: rgba(25, 135, 84, 0.1);
    border-left: 4px solid #198754;
    padding: 1rem;
    margin-top: 1rem;
}

.frequency-preview {
    background-color: rgba(255, 193, 7, 0.1);
    border-left: 4px solid #ffc107;
    padding: 0.75rem;
    margin-top: 0.5rem;
}

.form-floating textarea {
    min-height: 120px;
}

.btn-preview {
    background: linear-gradient(135deg, #6f42c1, #5a379b);
    border: none;
    color: white;
}

.btn-preview:hover {
    background: linear-gradient(135deg, #5a379b, #4a2c7d);
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-plus-circle me-2"></i>Add Screening Type
    </h2>
    <a href="{{ url_for('screening.screening_list') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>Back to Screenings
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-1"></i>Screening Type Configuration
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" class="screening-form" novalidate>
                    {{ form.hidden_tag() }}

                    <!-- Basic Information -->
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-floating mb-3">
                                {{ form.name(class="form-control", placeholder="Screening Name") }}
                                <label for="name">
                                    <i class="fas fa-tag me-1"></i>Screening Name *
                                </label>
                                {% if form.name.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.name.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                {{ form.is_active(class="form-check-input", style="width: 3rem; height: 1.5rem;") }}
                                <label for="is_active" class="form-check-label ms-2">
                                    Active Status
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating mb-3">
                        {{ form.description(class="form-control", placeholder="Description") }}
                        <label for="description">
                            <i class="fas fa-align-left me-1"></i>Description
                        </label>
                        {% if form.description.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.description.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Keywords Configuration -->
                    <div class="form-floating mb-3">
                        {{ form.keywords(class="form-control", placeholder="Keywords", rows="6") }}
                        <label for="keywords">
                            <i class="fas fa-key me-1"></i>Keywords for Document Matching
                        </label>
                        {% if form.keywords.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.keywords.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="keywords-help">
                            <h6><i class="fas fa-lightbulb me-1"></i>Keyword Matching Tips:</h6>
                            <ul class="mb-0">
                                <li>Enter one keyword per line</li>
                                <li>Use medical terminology and common abbreviations</li>
                                <li>System automatically handles fuzzy matching</li>
                                <li>Keywords match both filenames and document content</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Eligibility Criteria -->
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-users me-1"></i>Eligibility Criteria
                    </h6>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                {{ form.gender_filter(class="form-select") }}
                                <label for="gender_filter">
                                    <i class="fas fa-venus-mars me-1"></i>Gender Filter
                                </label>
                                {% if form.gender_filter.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.gender_filter.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                {{ form.min_age(class="form-control", placeholder="Minimum Age") }}
                                <label for="min_age">
                                    <i class="fas fa-calendar-minus me-1"></i>Minimum Age
                                </label>
                                {% if form.min_age.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.min_age.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-floating mb-3">
                                {{ form.max_age(class="form-control", placeholder="Maximum Age") }}
                                <label for="max_age">
                                    <i class="fas fa-calendar-plus me-1"></i>Maximum Age
                                </label>
                                {% if form.max_age.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.max_age.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Frequency Configuration -->
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-clock me-1"></i>Screening Frequency
                    </h6>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                {{ form.frequency_value(class="form-control", placeholder="Frequency Value") }}
                                <label for="frequency_value">
                                    <i class="fas fa-hashtag me-1"></i>Frequency Value *
                                </label>
                                {% if form.frequency_value.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.frequency_value.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating mb-3">
                                {{ form.frequency_unit(class="form-select") }}
                                <label for="frequency_unit">
                                    <i class="fas fa-calendar-alt me-1"></i>Frequency Unit *
                                </label>
                                {% if form.frequency_unit.errors %}
                                    <div class="text-danger small mt-1">
                                        {% for error in form.frequency_unit.errors %}
                                            <div>{{ error }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="frequency-preview" id="frequencyPreview">
                        <strong>Frequency Preview:</strong>
                        <span id="frequencyText">Configure frequency above</span>
                    </div>

                    <!-- Trigger Conditions -->
                    <div class="form-floating mb-3 mt-4">
                        {{ form.trigger_conditions(class="form-control", placeholder="Trigger Conditions", rows="4") }}
                        <label for="trigger_conditions">
                            <i class="fas fa-heartbeat me-1"></i>Trigger Conditions (Optional)
                        </label>
                        {% if form.trigger_conditions.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.trigger_conditions.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="text-muted">Enter medical conditions that trigger this screening (one per line)</small>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex gap-2 pt-3">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-1"></i>Create Screening Type
                        </button>
                        <button type="button" class="btn btn-preview" onclick="previewScreeningType()">
                            <i class="fas fa-eye me-1"></i>Preview
                        </button>
                        <a href="{{ url_for('screening.screening_list') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Sidebar -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-question-circle me-1"></i>Screening Type Help
                </h6>
            </div>
            <div class="card-body">
                <h6>Common Screening Examples:</h6>
                <div class="accordion" id="examplesAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mammogramExample">
                                Mammogram
                            </button>
                        </h2>
                        <div id="mammogramExample" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <strong>Keywords:</strong> mammogram, mammography, breast imaging, mammo<br>
                                <strong>Gender:</strong> Female Only<br>
                                <strong>Age:</strong> 40-75<br>
                                <strong>Frequency:</strong> Every 1 year
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#colonoscopyExample">
                                Colonoscopy
                            </button>
                        </h2>
                        <div id="colonoscopyExample" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <strong>Keywords:</strong> colonoscopy, colon screening, colon<br>
                                <strong>Gender:</strong> All Genders<br>
                                <strong>Age:</strong> 45-75<br>
                                <strong>Frequency:</strong> Every 10 years
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#boneExample">
                                Bone Density
                            </button>
                        </h2>
                        <div id="boneExample" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <strong>Keywords:</strong> dexa, dxa, bone density, bone scan<br>
                                <strong>Gender:</strong> Female Only<br>
                                <strong>Age:</strong> 65+<br>
                                <strong>Frequency:</strong> Every 2 years
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="medical-variants mt-3">
            <h6><i class="fas fa-robot me-1"></i>Fuzzy Matching</h6>
            <p class="mb-2">The system automatically recognizes medical term variations:</p>
            <ul class="small mb-0">
                <li><strong>dexa</strong> matches: dxa, bone density, bone scan</li>
                <li><strong>a1c</strong> matches: hba1c, hemoglobin a1c</li>
                <li><strong>mammogram</strong> matches: mammo, mammography</li>
                <li><strong>ecg</strong> matches: ekg, electrocardiogram</li>
            </ul>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-1"></i>Screening Type Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="previewContent">
                <!-- Preview content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update frequency preview
    function updateFrequencyPreview() {
        const value = document.getElementById('frequency_value').value;
        const unit = document.getElementById('frequency_unit').value;
        const preview = document.getElementById('frequencyText');
        
        if (value && unit) {
            const singular = {
                'days': 'day',
                'months': 'month', 
                'years': 'year'
            };
            
            if (value == 1) {
                preview.textContent = `Every ${singular[unit] || unit}`;
            } else {
                preview.textContent = `Every ${value} ${unit}`;
            }
        } else {
            preview.textContent = 'Configure frequency above';
        }
    }
    
    // Attach event listeners
    document.getElementById('frequency_value').addEventListener('input', updateFrequencyPreview);
    document.getElementById('frequency_unit').addEventListener('change', updateFrequencyPreview);
    
    // Initial preview update
    updateFrequencyPreview();
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();
        const frequencyValue = document.getElementById('frequency_value').value;
        const frequencyUnit = document.getElementById('frequency_unit').value;
        
        if (!name) {
            e.preventDefault();
            alert('Please enter a screening name');
            document.getElementById('name').focus();
            return;
        }
        
        if (!frequencyValue || !frequencyUnit) {
            e.preventDefault();
            alert('Please configure the screening frequency');
            return;
        }
        
        // Show loading state
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
        
        // Re-enable if form submission fails
        setTimeout(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }, 5000);
    });
});

function previewScreeningType() {
    const formData = new FormData(document.querySelector('form'));
    const preview = document.getElementById('previewContent');
    
    // Build preview HTML
    let html = '<div class="row">';
    
    // Basic Info
    html += '<div class="col-md-6">';
    html += '<h6>Basic Information</h6>';
    html += `<p><strong>Name:</strong> ${formData.get('name') || 'Not specified'}</p>`;
    html += `<p><strong>Description:</strong> ${formData.get('description') || 'Not specified'}</p>`;
    html += `<p><strong>Status:</strong> ${formData.get('is_active') ? 'Active' : 'Inactive'}</p>`;
    html += '</div>';
    
    // Eligibility
    html += '<div class="col-md-6">';
    html += '<h6>Eligibility Criteria</h6>';
    html += `<p><strong>Gender:</strong> ${formData.get('gender_filter') || 'All Genders'}</p>`;
    html += `<p><strong>Age Range:</strong> `;
    
    const minAge = formData.get('min_age');
    const maxAge = formData.get('max_age');
    if (minAge && maxAge) {
        html += `${minAge}-${maxAge} years`;
    } else if (minAge) {
        html += `${minAge}+ years`;
    } else if (maxAge) {
        html += `Up to ${maxAge} years`;
    } else {
        html += 'All ages';
    }
    html += '</p>';
    
    const frequencyValue = formData.get('frequency_value');
    const frequencyUnit = formData.get('frequency_unit');
    if (frequencyValue && frequencyUnit) {
        html += `<p><strong>Frequency:</strong> Every ${frequencyValue} ${frequencyUnit}</p>`;
    }
    html += '</div>';
    
    html += '</div>';
    
    // Keywords
    const keywords = formData.get('keywords');
    if (keywords) {
        html += '<h6 class="mt-3">Keywords</h6>';
        const keywordList = keywords.split('\n').filter(k => k.trim());
        html += '<div>';
        keywordList.forEach(keyword => {
            html += `<span class="badge bg-primary me-1 mb-1">${keyword.trim()}</span>`;
        });
        html += '</div>';
    }
    
    // Trigger Conditions
    const conditions = formData.get('trigger_conditions');
    if (conditions) {
        html += '<h6 class="mt-3">Trigger Conditions</h6>';
        const conditionList = conditions.split('\n').filter(c => c.trim());
        html += '<ul>';
        conditionList.forEach(condition => {
            html += `<li>${condition.trim()}</li>`;
        });
        html += '</ul>';
    }
    
    preview.innerHTML = html;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}
</script>
{% endblock %}


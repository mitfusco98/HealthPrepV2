{% extends 'base_demo.html' %}

{% block title %}{% if editing %}Edit{% else %}Add{% endif %} Screening Type - HealthPrep{% endblock %}

{% block extra_css %}
<style>
.form-help {
    font-size: 0.875rem;
    color: #6c757d;
}

.keyword-tag {
    display: inline-block;
    background-color: #e9ecef;
    color: #495057;
    padding: 0.25rem 0.5rem;
    margin: 0.125rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
}

.preview-section {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-top: 1rem;
}

.frequency-preview {
    font-weight: 600;
    color: #0d6efd;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Page Header -->
            <div class="d-flex align-items-center mb-4">
                <a href="{{ url_for('screening.screening_list') }}" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-{% if editing %}edit{% else %}plus{% endif %} me-2"></i>
                        {% if editing %}Edit{% else %}Add{% endif %} Screening Type
                    </h1>
                    <p class="text-muted mb-0">
                        {% if editing %}
                            Update screening type configuration
                        {% else %}
                            Configure a new screening type for automated processing
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Form Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Screening Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="screeningTypeForm">
                        {{ form.hidden_tag() }}
                        
                        <!-- Basic Information -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-1"></i>Basic Information
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.name.label(class="form-label") }}
                                    {{ form.name(class="form-control" ~ (" is-invalid" if form.name.errors else "")) }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.name.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-help">
                                        Enter a clear, descriptive name for this screening type (e.g., "Mammogram", "Colonoscopy")
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.gender_eligibility.label(class="form-label") }}
                                    {{ form.gender_eligibility(class="form-select" ~ (" is-invalid" if form.gender_eligibility.errors else "")) }}
                                    {% if form.gender_eligibility.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.gender_eligibility.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.description.label(class="form-label") }}
                                    {{ form.description(class="form-control", rows="3") }}
                                    <div class="form-help">
                                        Provide a brief description of this screening type and its purpose
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Eligibility Criteria -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-users me-1"></i>Eligibility Criteria
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.min_age.label(class="form-label") }}
                                    {{ form.min_age(class="form-control" ~ (" is-invalid" if form.min_age.errors else ""), placeholder="e.g., 40") }}
                                    {% if form.min_age.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.min_age.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-help">Leave blank for no minimum age requirement</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.max_age.label(class="form-label") }}
                                    {{ form.max_age(class="form-control" ~ (" is-invalid" if form.max_age.errors else ""), placeholder="e.g., 75") }}
                                    {% if form.max_age.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.max_age.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    <div class="form-help">Leave blank for no maximum age requirement</div>
                                </div>
                            </div>
                        </div>

                        <!-- Frequency Settings -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-clock me-1"></i>Frequency Settings
                                </h6>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.frequency_value.label(class="form-label") }}
                                    {{ form.frequency_value(class="form-control" ~ (" is-invalid" if form.frequency_value.errors else ""), placeholder="e.g., 12") }}
                                    {% if form.frequency_value.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.frequency_value.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.frequency_unit.label(class="form-label") }}
                                    {{ form.frequency_unit(class="form-select" ~ (" is-invalid" if form.frequency_unit.errors else "")) }}
                                    {% if form.frequency_unit.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.frequency_unit.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="preview-section">
                                    <small class="text-muted">Frequency Preview:</small>
                                    <div class="frequency-preview" id="frequencyPreview">
                                        Every 12 months
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Keywords -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-tags me-1"></i>Document Matching Keywords
                                </h6>
                                
                                <div class="mb-3">
                                    {{ form.keywords.label(class="form-label") }}
                                    {{ form.keywords(class="form-control", rows="3", placeholder="mammogram, mammography, breast imaging, breast screening") }}
                                    <div class="form-help">
                                        Enter keywords that identify documents for this screening type. 
                                        Separate multiple keywords with commas. The system will use fuzzy matching to find related terms.
                                    </div>
                                </div>
                                
                                <div id="keywordPreview" class="mt-2">
                                    <!-- Keywords will be displayed here as tags -->
                                </div>
                            </div>
                        </div>

                        <!-- Trigger Conditions -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-exclamation-triangle me-1"></i>Trigger Conditions (Optional)
                                </h6>
                                
                                <div class="mb-3">
                                    {{ form.trigger_conditions.label(class="form-label") }}
                                    {{ form.trigger_conditions(class="form-control", rows="2", placeholder="diabetes, heart disease, family history") }}
                                    <div class="form-help">
                                        Enter medical conditions that modify screening requirements for this type.
                                        Leave blank if no special conditions apply. Separate multiple conditions with commas.
                                    </div>
                                </div>
                                
                                <div id="conditionPreview" class="mt-2">
                                    <!-- Conditions will be displayed here as tags -->
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('screening.screening_list') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                {% if editing %}Update{% else %}Create{% endif %} Screening Type
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const frequencyValue = document.getElementById('frequency_value');
    const frequencyUnit = document.getElementById('frequency_unit');
    const frequencyPreview = document.getElementById('frequencyPreview');
    const keywordsField = document.getElementById('keywords');
    const keywordPreview = document.getElementById('keywordPreview');
    const conditionsField = document.getElementById('trigger_conditions');
    const conditionPreview = document.getElementById('conditionPreview');

    // Update frequency preview
    function updateFrequencyPreview() {
        const value = frequencyValue.value || '1';
        const unit = frequencyUnit.value || 'months';
        const unitText = value === '1' ? unit.slice(0, -1) : unit; // Remove 's' for singular
        frequencyPreview.textContent = `Every ${value} ${unitText}`;
    }

    // Update keyword preview
    function updateKeywordPreview() {
        const keywords = keywordsField.value.split(',').map(k => k.trim()).filter(k => k);
        keywordPreview.innerHTML = '';
        
        if (keywords.length > 0) {
            keywords.forEach(keyword => {
                const tag = document.createElement('span');
                tag.className = 'keyword-tag';
                tag.textContent = keyword;
                keywordPreview.appendChild(tag);
            });
        }
    }

    // Update condition preview
    function updateConditionPreview() {
        const conditions = conditionsField.value.split(',').map(c => c.trim()).filter(c => c);
        conditionPreview.innerHTML = '';
        
        if (conditions.length > 0) {
            conditions.forEach(condition => {
                const tag = document.createElement('span');
                tag.className = 'keyword-tag';
                tag.style.backgroundColor = '#fff3cd';
                tag.style.color = '#856404';
                tag.textContent = condition;
                conditionPreview.appendChild(tag);
            });
        }
    }

    // Event listeners
    frequencyValue.addEventListener('input', updateFrequencyPreview);
    frequencyUnit.addEventListener('change', updateFrequencyPreview);
    keywordsField.addEventListener('input', updateKeywordPreview);
    conditionsField.addEventListener('input', updateConditionPreview);

    // Initial previews
    updateFrequencyPreview();
    updateKeywordPreview();
    updateConditionPreview();

    // Form validation
    document.getElementById('screeningTypeForm').addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();
        const freqValue = document.getElementById('frequency_value').value;
        
        if (!name) {
            e.preventDefault();
            alert('Please enter a screening type name.');
            document.getElementById('name').focus();
            return false;
        }
        
        if (!freqValue || freqValue < 1) {
            e.preventDefault();
            alert('Please enter a valid frequency value (1 or greater).');
            document.getElementById('frequency_value').focus();
            return false;
        }
        
        return true;
    });
});
</script>
{% endblock %}


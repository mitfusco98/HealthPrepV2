{% extends 'base_user.html' %}

{% block title %}HealthPrep - Screening List{% endblock %}

{% block extra_css %}
<style>
/* Confidence-based color coding for document links */
.confidence-high {
    color: #155724 !important;
    background-color: #d4edda !important;
    border: 1px solid #c3e6cb !important;
}

.confidence-medium {
    color: #856404 !important;
    background-color: #fff3cd !important;
    border: 1px solid #ffeaa7 !important;
}

.confidence-low {
    color: #721c24 !important;
    background-color: #f8d7da !important;
    border: 1px solid #f5c6cb !important;
}

.confidence-high:hover, .confidence-medium:hover, .confidence-low:hover {
    opacity: 0.8;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

/* Document confidence legend */
.confidence-legend {
    font-size: 0.85em;
    margin-bottom: 10px;
}

.confidence-legend .badge {
    margin-right: 8px;
}

/* Screening status badges */
.status-complete { background-color: #28a745 !important; }
.status-due-soon { background-color: #ffc107 !important; color: #000 !important; }
.status-due { background-color: #dc3545 !important; }

/* Modal styling */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1050;
    width: 100%;
    height: 100%;
    overflow: hidden;
    outline: 0;
}

.keywords-list {
    min-height: 60px;
}

.min-height-100 {
    min-height: 100px;
}

.keywords-badges-container {
    line-height: 1.5;
}

.keywords-badges-container .badge {
    font-size: 0.75rem;
    margin-bottom: 2px;
}

/* Tab navigation styling */
.nav-tabs .nav-link {
    color: #6c757d;
    border: 1px solid transparent;
}

.nav-tabs .nav-link.active {
    color: #fff;
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* Filter section */
.filter-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

/* Screening card styling */
.screening-card {
    background: linear-gradient(135deg, #343a40 0%, #495057 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    transition: transform 0.2s ease;
}

.screening-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-list-check me-2 text-primary"></i>
                        Patient Screenings
                    </h1>
                    <p class="text-muted">Manage patient screening schedules and compliance tracking</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshScreenings(event, 'list')">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="screeningTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" href="{{ url_for('screening.screening_list') }}" role="tab">
                <i class="fas fa-list me-1"></i>
                Screening List
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('screening.screening_types') }}" role="tab">
                <i class="fas fa-tags me-1"></i>
                Screening Types
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('screening.screening_settings') }}" role="tab">
                <i class="fas fa-cog me-1"></i>
                Settings
            </a>
        </li>
    </ul>

    <!-- Screening List Content -->
            <!-- Filters -->
            <div class="filter-section">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="patient" class="form-label">Patient Search</label>
                        <input type="text" class="form-control" id="patient" name="patient" 
                               value="{{ request.args.get('patient', '') }}" 
                               placeholder="Name or MRN">
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Statuses</option>
                            <option value="Due" {{ 'selected' if request.args.get('status') == 'Due' }}>Due</option>
                            <option value="Due Soon" {{ 'selected' if request.args.get('status') == 'Due Soon' }}>Due Soon</option>
                            <option value="Complete" {{ 'selected' if request.args.get('status') == 'Complete' }}>Complete</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="screening_type" class="form-label">Screening Type</label>
                        <select class="form-select" id="screening_type" name="screening_type">
                            <option value="">All Types</option>
                            {% for group in screening_type_groups %}
                            <option value="{{ group.name }}" 
                                    {{ 'selected' if request.args.get('screening_type') == group.name }}>
                                {{ group.display_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-outline-primary">
                                <i class="fas fa-filter me-1"></i>
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Document Confidence Legend -->
            <div class="confidence-legend mb-3">
                <strong>Document Confidence:</strong>
                <span class="badge confidence-high">High</span>
                <span class="badge confidence-medium">Medium</span>
                <span class="badge confidence-low">Low</span>
            </div>

            <!-- Screening Results -->
            {% if screenings %}
            <div class="row">
                {% for screening in screenings %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="screening-card card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">{{ screening.patient.full_name }}</h6>
                            <span class="badge status-{{ screening.status.lower().replace(' ', '-') }}">
                                {{ screening.status }}
                            </span>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">{{ screening.screening_type.display_name }}</h6>
                            <div class="row text-sm">
                                <div class="col-6">
                                    <strong>MRN:</strong> {{ screening.patient.mrn }}
                                </div>
                                <div class="col-6">
                                    <strong>Age:</strong> {{ screening.patient.age }}
                                </div>
                            </div>
                            <hr>
                            <div class="mb-2">
                                <strong>Last Completed:</strong> 
                                {{ screening.last_completed.strftime('%m/%d/%Y') if screening.last_completed else 'Never' }}
                            </div>
                            <div class="mb-2">
                                <strong>Frequency:</strong> 
                                Every {{ screening.screening_type.frequency_number }} {{ screening.screening_type.frequency_unit }}
                            </div>
                            {% if screening.next_due %}
                            <div class="mb-3">
                                <strong>Next Due:</strong> 
                                {{ screening.next_due.strftime('%m/%d/%Y') }}
                            </div>
                            {% endif %}
                            
                            <!-- Matched Documents -->
                            {% if screening.document_matches %}
                            <div class="mb-3">
                                <strong>Matched Documents:</strong>
                                <div class="mt-1">
                                    {% for match in screening.document_matches[:3] %}
                                    <span class="badge confidence-{{ match.document.confidence_level }} me-1 mb-1" 
                                          title="Confidence: {{ (match.match_confidence * 100)|round(1) }}%">
                                        {{ match.document.filename[:20] }}{% if match.document.filename|length > 20 %}...{% endif %}
                                    </span>
                                    {% endfor %}
                                    {% if screening.document_matches|length > 3 %}
                                    <span class="text-muted small">+{{ screening.document_matches|length - 3 }} more</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="card-footer">
                            <a href="#" class="btn btn-sm btn-primary" onclick="alert('Prep sheet temporarily disabled')">
                                <i class="fas fa-file-medical me-1"></i>
                                Generate Prep Sheet
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Screenings Found</h5>
                <p class="text-muted">
                    {% if request.args.get('patient') or request.args.get('status') or request.args.get('screening_type') %}
                    No screenings match your current filters. Try adjusting your search criteria.
                    {% else %}
                    No patient screenings are currently configured. Add screening types to begin tracking.
                    {% endif %}
                </p>
                {% if current_user.role in ['admin', 'clinician'] %}
                <a href="{{ url_for('main.screening_types') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>
                    Configure Screening Types
                </a>
                {% endif %}
            </div>
            {% endif %}

</div>

<!-- Include screening modals JavaScript -->
<script src="{{ url_for('static', filename='js/screening_modals.js') }}"></script>
<!-- Include performance optimization JavaScript -->
<script src="{{ url_for('static', filename='js/screening_performance.js') }}"></script>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced refresh functionality that works across all tabs
function refreshScreenings(event, tab) {
    // Prevent default link behavior
    event.preventDefault();
    
    const button = event.target.closest('button') || event.target.closest('a');
    const originalText = button.innerHTML;
    const confirmMessage = tab === 'types' 
        ? 'Discover and sync automated screenings from Epic EMR using the current parsing rules? This will find Epic patients, import them, and update document matches.'
        : 'Discover and sync patient data from Epic EMR? This will automatically find Epic patients, import them locally, fetch their medical records, conditions, documents, and update all screening statuses.';

    if (confirm(confirmMessage)) {
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Discovering and syncing from EMR...';
        button.disabled = true;

        // Make refresh request
        fetch('/api/refresh-screenings', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrf_token(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    Patient discovery and EMR sync completed successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const container = document.querySelector('.container-fluid');
                container.insertBefore(alertDiv, container.firstChild);
                
                // Reload page after short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error refreshing screenings:', error);
            
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error discovering and syncing EMR data: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

// Tab switching with URL updates
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const targetTab = e.target.getAttribute('data-bs-target').replace('#', '').replace('-content', '');
            const url = new URL(window.location);
            url.searchParams.set('tab', targetTab);
            window.history.replaceState({}, '', url);
        });
    });
    
    // Load tab from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab');
    if (activeTab) {
        const tabElement = document.querySelector(`#${activeTab}-tab`);
        if (tabElement) {
            const tab = new bootstrap.Tab(tabElement);
            tab.show();
        }
    }
});

// Auto-refresh status indicators every 5 minutes
setInterval(function() {
    const statusBadges = document.querySelectorAll('.badge[class*="status-"]');
    if (statusBadges.length > 0) {
        // Subtle visual indication of auto-refresh
        statusBadges.forEach(badge => {
            badge.style.opacity = '0.7';
            setTimeout(() => badge.style.opacity = '1', 500);
        });
    }
}, 5 * 60 * 1000);
</script>
{% endblock %}

{% extends 'base_user.html' %}

{% block title %}HealthPrep - Screening List{% endblock %}

{% block extra_css %}
<style>
/* Confidence-based color coding for document links */
.confidence-high {
    color: #155724 !important;
    background-color: #d4edda !important;
    border: 1px solid #c3e6cb !important;
}

.confidence-medium {
    color: #856404 !important;
    background-color: #fff3cd !important;
    border: 1px solid #ffeaa7 !important;
}

.confidence-low {
    color: #721c24 !important;
    background-color: #f8d7da !important;
    border: 1px solid #f5c6cb !important;
}

.confidence-high:hover, .confidence-medium:hover, .confidence-low:hover {
    opacity: 0.8;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

/* Document confidence legend */
.confidence-legend {
    font-size: 0.85em;
    margin-bottom: 10px;
}

.confidence-legend .badge {
    margin-right: 8px;
}

/* Screening status badges */
.status-complete { background-color: #28a745 !important; color: #fff !important; }
.status-due-soon { background-color: #fd7e14 !important; color: #fff !important; }
.status-due { background-color: #dc3545 !important; color: #fff !important; }

/* Modal styling */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1050;
    width: 100%;
    height: 100%;
    overflow: hidden;
    outline: 0;
}

.keywords-list {
    min-height: 60px;
}

.min-height-100 {
    min-height: 100px;
}

.keywords-badges-container {
    line-height: 1.5;
}

.keywords-badges-container .badge {
    font-size: 0.75rem;
    margin-bottom: 2px;
}

/* Tab navigation styling */
.nav-tabs .nav-link {
    color: #6c757d;
    border: 1px solid transparent;
}

.nav-tabs .nav-link.active {
    color: #fff;
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* Filter section */
.filter-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

/* IMPROVEMENT 1: Reduced font size & optimized spacing for compact layout */
.screening-table-compact {
    font-size: 0.85rem;
}

/* IMPROVEMENT 2: Sticky/Fixed column headers */
.table-dark thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: var(--hp-primary) !important;
    color: white !important;
    font-weight: 600;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    white-space: nowrap;
    padding: 0.5rem 0.75rem; /* Reduced padding */
}

.table-dark {
    --bs-table-bg: #212529;
    --bs-table-color: #fff;
}

.table-dark td {
    vertical-align: middle;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff;
    padding: 0.5rem 0.75rem; /* Reduced padding */
}

.table-dark tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

/* IMPROVEMENT 3: Optimized column widths */
.col-patient {
    width: 180px;
    min-width: 180px;
    max-width: 180px;
}

.col-screening-type {
    width: 160px;
    min-width: 160px;
    max-width: 160px;
}

.col-status {
    width: 85px;
    min-width: 85px;
    max-width: 85px;
}

.col-last-completed {
    width: 100px;
    min-width: 100px;
    max-width: 100px;
}

.col-frequency {
    width: 90px;
    min-width: 90px;
    max-width: 90px;
}

.col-documents {
    width: auto;
    min-width: 500px;
}

.patient-info {
    width: 100%;
}

.patient-info .patient-name {
    font-weight: 600;
    color: #fff !important;
    font-size: 0.9rem;
    line-height: 1.2;
    margin-bottom: 0.25rem;
}

.patient-info .patient-details {
    font-size: 0.75rem;
    color: #adb5bd !important;
    line-height: 1.1;
}

/* IMPROVEMENT 4: Enhanced document badges with better truncation and stacking */
.document-badges {
    width: 100%;
}

.documents-list {
    flex-grow: 1;
    line-height: 1.3;
}

.documents-list .badge {
    font-size: 0.7rem;
    margin: 2px 3px 2px 0;
    padding: 0.3rem 0.5rem;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: inline-block;
    vertical-align: top;
}

.documents-list .badge:hover {
    max-width: none;
    white-space: normal;
    position: relative;
    z-index: 5;
}

.document-count-more {
    font-size: 0.7rem;
    color: #adb5bd;
    font-style: italic;
    margin-top: 2px;
}

/* Prep sheet button optimization */
.prep-sheet-btn {
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
    line-height: 1;
}

/* Apply column widths to table body cells */
.screening-table-compact td:nth-child(1) { width: 180px; max-width: 180px; }
.screening-table-compact td:nth-child(2) { width: 160px; max-width: 160px; }
.screening-table-compact td:nth-child(3) { width: 85px; max-width: 85px; }
.screening-table-compact td:nth-child(4) { width: 100px; max-width: 100px; }
.screening-table-compact td:nth-child(5) { width: 90px; max-width: 90px; }
.screening-table-compact td:nth-child(6) { width: auto; min-width: 500px; }

/* Ensure table layout respects column widths */
.screening-table-compact {
    table-layout: fixed;
    width: 100%;
}

/* Responsive design for mobile - keep all columns visible */
@media (max-width: 768px) {
    .screening-table-compact {
        font-size: 0.75em;
    }
    
    .patient-info {
        min-width: 120px;
    }
    
    .patient-info .patient-name {
        font-size: 0.9em;
    }
    
    .patient-info .patient-details {
        font-size: 0.8em;
    }
    
    .document-badges {
        max-width: 150px;
    }
    
    .document-badges .badge {
        font-size: 0.6em;
    }
    
    .btn-sm {
        padding: 0.1rem 0.3rem;
        font-size: 0.7em;
    }
}

@media (max-width: 576px) {
    .screening-table-compact {
        font-size: 0.7em;
    }
    
    .patient-info {
        min-width: 100px;
    }
    
    .document-badges {
        max-width: 120px;
    }
    
    .documents-list .badge {
        display: block;
        margin-bottom: 1px;
    }
}

/* Sortable table headers */
.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
}

.sortable:hover {
    background-color: #e9ecef !important;
}

.sortable::after {
    content: '\f0dc';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    position: absolute;
    right: 8px;
    opacity: 0.5;
    font-size: 0.8em;
}

.sortable.asc::after {
    content: '\f0de';
    opacity: 1;
}

.sortable.desc::after {
    content: '\f0dd';
    opacity: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-list-check me-2 text-primary"></i>
                        Patient Screenings
                    </h1>
                    <p class="text-muted">Manage patient screening schedules and compliance tracking</p>
                </div>
                <div>
                    <button class="btn btn-medical-primary" onclick="refreshScreenings(event, 'list')">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="screeningTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" href="{{ url_for('screening.screening_list') }}" role="tab">
                <i class="fas fa-list me-1"></i>
                Screening List
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('screening.screening_types') }}" role="tab">
                <i class="fas fa-tags me-1"></i>
                Screening Types
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('screening.screening_settings') }}" role="tab">
                <i class="fas fa-cog me-1"></i>
                Settings
            </a>
        </li>
    </ul>

    <!-- Screening List Content -->
            <!-- Filters -->
            <div class="medical-card filter-section">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="patient" class="form-label">Patient Search</label>
                        <input type="text" class="form-control" id="patient" name="patient" 
                               value="{{ request.args.get('patient', '') }}" 
                               placeholder="Name or MRN">
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Statuses</option>
                            <option value="Due" {{ 'selected' if request.args.get('status') == 'Due' }}>Due</option>
                            <option value="Due Soon" {{ 'selected' if request.args.get('status') == 'Due Soon' }}>Due Soon</option>
                            <option value="Complete" {{ 'selected' if request.args.get('status') == 'Complete' }}>Complete</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="screening_type" class="form-label">Screening Type</label>
                        <select class="form-select" id="screening_type" name="screening_type">
                            <option value="">All Types</option>
                            {% for group in screening_type_groups %}
                            <option value="{{ group.name }}" 
                                    {{ 'selected' if request.args.get('screening_type') == group.name }}>
                                {{ group.display_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-medical-primary">
                                <i class="fas fa-filter me-1"></i>
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Appointment Prioritization Info with Bulk Prep Generation -->
            {% if appointment_prioritization.enabled %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="alert alert-info mb-0 py-2 px-3 flex-grow-1" style="font-size: 0.85rem;">
                    <i class="fas fa-calendar-check me-2"></i>
                    <strong>Appointment Prioritization Active:</strong> 
                    Showing patients with appointments in next {{ appointment_prioritization.window_days }} days first
                    {% if appointment_prioritization.priority_count_on_page > 0 %}
                    ({{ appointment_prioritization.priority_count_on_page }} on this page)
                    {% endif %}
                </div>
                <button type="button" class="btn btn-success ms-3" onclick="bulkGeneratePrepSheetsToEpic()" id="bulkPrepBtn">
                    <i class="fas fa-file-medical me-2"></i>
                    Generate Prep Sheets for Window
                </button>
            </div>
            {% endif %}
            
            <!-- Document Confidence Legend -->
            <div class="confidence-legend mb-3">
                <strong>Document Confidence:</strong>
                <span class="badge confidence-high">High</span>
                <span class="badge confidence-medium">Medium</span>
                <span class="badge confidence-low">Low</span>
            </div>
            
            {% if pagination and pagination.total_screenings > 0 %}
            <div class="mb-2 text-muted" style="font-size: 0.9rem;">
                Showing {{ pagination.start_idx }}-{{ pagination.end_idx }} of {{ pagination.total_screenings }} screenings
            </div>
            {% endif %}

            <!-- Screening Results -->
            {% if screenings %}
            <div class="table-responsive">
                <table class="table table-dark table-hover screening-table-compact">
                    <thead class="table-primary">
                        <tr>
                            <th scope="col" class="col-patient sortable text-white" data-column="patient">Patient</th>
                            <th scope="col" class="col-screening-type sortable text-white" data-column="screening_type">Screening Type</th>
                            <th scope="col" class="col-status sortable text-white" data-column="status">Status</th>
                            <th scope="col" class="col-last-completed sortable text-white" data-column="last_completed">Last Completed</th>
                            <th scope="col" class="col-frequency sortable text-white" data-column="frequency">Frequency</th>
                            <th scope="col" class="col-documents text-white">Matched Documents</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for screening in screenings %}
                        <tr {% if appointment_prioritization.enabled and screening.patient_id in appointment_prioritization.priority_patient_ids %}style="background-color: rgba(13, 110, 253, 0.15) !important;"{% endif %}>
                            <!-- Patient Information -->
                            <td class="patient-info">
                                <div class="patient-name">
                                    {% if appointment_prioritization.enabled and screening.patient_id in appointment_prioritization.priority_patient_ids %}
                                    <i class="fas fa-star text-warning me-1" title="Has upcoming appointment"></i>
                                    {% endif %}
                                    {{ screening.patient.full_name }}
                                </div>
                                <div class="patient-details">
                                    MRN: {{ screening.patient.mrn }}<br>
                                    Age: {{ screening.patient.age }}
                                </div>
                            </td>
                            
                            <!-- Screening Type -->
                            <td>{{ screening.screening_type.display_name }}</td>
                            
                            <!-- Status -->
                            <td>
                                {% if screening.status == 'complete' %}
                                    <span class="badge status-complete">
                                        <i class="fas fa-check-circle me-1"></i>Complete
                                    </span>
                                {% elif screening.status == 'due_soon' %}
                                    <span class="badge status-due-soon">
                                        <i class="fas fa-clock me-1"></i>Due Soon
                                    </span>
                                {% elif screening.status == 'due' %}
                                    <span class="badge status-due">
                                        <i class="fas fa-exclamation-circle me-1"></i>Due
                                    </span>
                                {% else %}
                                    <span class="badge status-due">
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ screening.status }}
                                    </span>
                                {% endif %}
                            </td>
                            
                            <!-- Last Completed -->
                            <td>
                                {{ screening.last_completed.strftime('%m/%d/%Y') if screening.last_completed else 'Never' }}
                            </td>
                            
                            <!-- Frequency -->
                            <td>
                                {{ screening.screening_type.frequency_display }}
                            </td>
                            
                            <!-- Matched Documents -->
                            <td class="document-badges">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="documents-list">
                                        {% set active_matches = screening.get_active_document_matches() %}
                                        {% set active_fhir_docs = screening.get_active_fhir_documents() %}
                                        {% set total_docs = (active_matches|length) + (active_fhir_docs|length) %}
                                        {% if total_docs > 0 %}
                                            {# Show local documents #}
                                            {% for match in active_matches[:3] %}
                                            <span class="badge confidence-{{ match.document.confidence_level if match.document.confidence_level else 'medium' }}" 
                                                  title="{{ match.document.filename }} - Confidence: {{ (match.match_confidence * 100)|round(1) }}%">
                                                {{ match.document.filename[:25] }}{% if match.document.filename|length > 25 %}...{% endif %}
                                            </span>
                                            {% endfor %}
                                            
                                            {# Show FHIR documents #}
                                            {% for fhir_doc in active_fhir_docs[:(5 - (active_matches[:3]|length))] %}
                                            <span class="badge confidence-high" 
                                                  title="{{ fhir_doc.title or fhir_doc.document_type_display }} (Epic) - Date: {{ fhir_doc.document_date.strftime('%m/%d/%Y') if fhir_doc.document_date else 'N/A' }}">
                                                {{ (fhir_doc.title or fhir_doc.document_type_display)[:25] }}{% if (fhir_doc.title or fhir_doc.document_type_display)|length > 25 %}...{% endif %} 
                                                <i class="fas fa-cloud text-white-50" style="font-size: 0.7em;" title="From Epic"></i>
                                            </span>
                                            {% endfor %}
                                            
                                            {% if total_docs > 5 %}
                                            <div class="document-count-more">+{{ total_docs - 5 }} more documents</div>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted small">No matches</span>
                                        {% endif %}
                                    </div>
                                    <button type="button" class="btn prep-sheet-btn btn-medical-primary ms-2" 
                                            onclick="generatePrepSheetToEpic({{ screening.patient_id }})" 
                                            title="Generate Prep Sheet to Epic"
                                            data-patient-id="{{ screening.patient_id }}"
                                            data-patient-name="{{ screening.patient.full_name }}">
                                        <i class="fas fa-file-medical"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination Controls -->
            {% if pagination and pagination.total_pages > 1 %}
            <nav aria-label="Screening list pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    <!-- Previous Button -->
                    <li class="page-item {% if pagination.page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ pagination.page - 1 }}{% if filters.patient %}&patient={{ filters.patient }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.screening_type %}&screening_type={{ filters.screening_type }}{% endif %}" 
                           {% if pagination.page == 1 %}tabindex="-1"{% endif %}>
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                    
                    <!-- Page Numbers -->
                    {% set start_page = [1, pagination.page - 2]|max %}
                    {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}
                    
                    {% if start_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if filters.patient %}&patient={{ filters.patient }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.screening_type %}&screening_type={{ filters.screening_type }}{% endif %}">1</a>
                    </li>
                    {% if start_page > 2 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                    {% endif %}
                    
                    {% for page_num in range(start_page, end_page + 1) %}
                    <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                        <a class="page-link" href="?page={{ page_num }}{% if filters.patient %}&patient={{ filters.patient }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.screening_type %}&screening_type={{ filters.screening_type }}{% endif %}">
                            {{ page_num }}
                        </a>
                    </li>
                    {% endfor %}
                    
                    {% if end_page < pagination.total_pages %}
                    {% if end_page < pagination.total_pages - 1 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ pagination.total_pages }}{% if filters.patient %}&patient={{ filters.patient }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.screening_type %}&screening_type={{ filters.screening_type }}{% endif %}">{{ pagination.total_pages }}</a>
                    </li>
                    {% endif %}
                    
                    <!-- Next Button -->
                    <li class="page-item {% if pagination.page == pagination.total_pages %}disabled{% endif %}">
                        <a class="page-link" href="?page={{ pagination.page + 1 }}{% if filters.patient %}&patient={{ filters.patient }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}{% if filters.screening_type %}&screening_type={{ filters.screening_type }}{% endif %}"
                           {% if pagination.page == pagination.total_pages %}tabindex="-1"{% endif %}>
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Screenings Found</h5>
                <p class="text-muted">
                    {% if request.args.get('patient') or request.args.get('status') or request.args.get('screening_type') %}
                    No screenings match your current filters. Try adjusting your search criteria.
                    {% else %}
                    No patient screenings are currently configured. Add screening types to begin tracking.
                    {% endif %}
                </p>
                {% if current_user.role in ['admin', 'clinician'] %}
                <a href="{{ url_for('main.screening_types') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>
                    Configure Screening Types
                </a>
                {% endif %}
            </div>
            {% endif %}

</div>

<!-- Include screening modals JavaScript -->
<script src="{{ url_for('static', filename='js/screening_modals.js') }}"></script>
<!-- Include performance optimization JavaScript -->
<script src="{{ url_for('static', filename='js/screening_performance.js') }}"></script>
{% endblock %}

{% block extra_js %}
<script>
// Table sorting functionality
function sortTable(column) {
    const table = document.querySelector('.screening-table-compact tbody');
    const rows = Array.from(table.querySelectorAll('tr'));
    const header = document.querySelector(`[data-column="${column}"]`);
    const isAsc = header.classList.contains('asc');
    
    // Clear all sort indicators
    document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
    });
    
    // Set new sort indicator
    header.classList.add(isAsc ? 'desc' : 'asc');
    
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch(column) {
            case 'patient':
                aValue = a.querySelector('.patient-name').textContent.trim();
                bValue = b.querySelector('.patient-name').textContent.trim();
                break;
            case 'screening_type':
                aValue = a.cells[1].textContent.trim();
                bValue = b.cells[1].textContent.trim();
                break;
            case 'status':
                aValue = a.cells[2].textContent.trim();
                bValue = b.cells[2].textContent.trim();
                break;
            case 'last_completed':
                aValue = a.cells[3].textContent.trim();
                bValue = b.cells[3].textContent.trim();
                // Handle "Never" value
                if (aValue === 'Never') aValue = '01/01/1900';
                if (bValue === 'Never') bValue = '01/01/1900';
                aValue = new Date(aValue);
                bValue = new Date(bValue);
                break;
            case 'frequency':
                aValue = a.cells[4].textContent.trim();
                bValue = b.cells[4].textContent.trim();
                break;
        }
        
        if (aValue < bValue) return isAsc ? 1 : -1;
        if (aValue > bValue) return isAsc ? -1 : 1;
        return 0;
    });
    
    // Rebuild table
    rows.forEach(row => table.appendChild(row));
}

// Add click listeners to sortable headers
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            sortTable(this.dataset.column);
        });
    });
});
// Enhanced refresh functionality that works across all tabs
function refreshScreenings(event, tab) {
    // Prevent default link behavior
    event.preventDefault();
    
    const button = event.target.closest('button') || event.target.closest('a');
    const originalText = button.innerHTML;
    const confirmMessage = tab === 'types' 
        ? 'Refresh screening matches using current criteria? This will reprocess existing documents with updated keywords and rules to update screening statuses.'
        : 'Refresh screening data using existing documents? This will reprocess your local documents with current screening criteria and update all screening statuses based on the latest rules.';

    if (confirm(confirmMessage)) {
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing screening data...';
        button.disabled = true;

        // Make refresh request with force_refresh to recalculate all statuses
        const csrfToken = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
        fetch('/screening/refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({force_refresh: 'true'})
        })
        .then(response => {
            if (response.ok) {
                // Redirect successful - reload the page
                window.location.reload();
            } else {
                throw new Error('Refresh request failed');
            }
        })
        .catch(error => {
            console.error('Error refreshing screenings:', error);
            
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error refreshing screening data: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

// Tab switching with URL updates
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const targetTab = e.target.getAttribute('data-bs-target').replace('#', '').replace('-content', '');
            const url = new URL(window.location);
            url.searchParams.set('tab', targetTab);
            window.history.replaceState({}, '', url);
        });
    });
    
    // Load tab from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab');
    if (activeTab) {
        const tabElement = document.querySelector(`#${activeTab}-tab`);
        if (tabElement) {
            const tab = new bootstrap.Tab(tabElement);
            tab.show();
        }
    }
});

// Auto-refresh status indicators every 5 minutes
setInterval(function() {
    const statusBadges = document.querySelectorAll('.badge[class*="status-"]');
    if (statusBadges.length > 0) {
        // Subtle visual indication of auto-refresh
        statusBadges.forEach(badge => {
            badge.style.opacity = '0.7';
            setTimeout(() => badge.style.opacity = '1', 500);
        });
    }
}, 5 * 60 * 1000);

// Generate prep sheet to Epic for individual patient
function generatePrepSheetToEpic(patientId) {
    const button = event.target.closest('button');
    const patientName = button.dataset.patientName;
    const originalHtml = button.innerHTML;
    
    if (!confirm(`Generate prep sheet to Epic for ${patientName}?`)) {
        return;
    }
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    fetch(`/prep-sheet/generate-to-epic/${patientId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message with timestamp
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                Prep sheet successfully written to Epic for ${patientName}
                <br><small>Filename: ${data.filename} | Epic Document ID: ${data.epic_document_id}</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => alertDiv.remove(), 5000);
        } else {
            // Handle connection error specially
            if (data.connection_error) {
                alert(`Epic Connection Error: ${data.error}\n\nPlease verify your Epic OAuth connection is valid and refresh the tokens if needed.`);
            } else {
                alert(`Error: ${data.error}`);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while generating prep sheet');
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}

// Bulk generate prep sheets for appointment window
function bulkGeneratePrepSheetsToEpic() {
    const button = document.getElementById('bulkPrepBtn');
    const originalHtml = button.innerHTML;
    
    if (!confirm('Generate prep sheets to Epic for all patients in the appointment window?\n\nThis will create timestamped PDF prep sheets in Epic for each patient.')) {
        return;
    }
    
    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    button.disabled = true;
    
    fetch('/prep-sheet/bulk-generate-to-epic', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show detailed results
            const resultsHtml = `
                <div class="alert alert-success alert-dismissible fade show">
                    <h5><i class="fas fa-check-circle me-2"></i>Bulk Prep Sheet Generation Complete</h5>
                    <hr>
                    <p class="mb-2">
                        <strong>Total Patients:</strong> ${data.total}<br>
                        <strong>Successful:</strong> ${data.success_count}<br>
                        <strong>Failed:</strong> ${data.failed_count}
                    </p>
                    ${data.failed_count > 0 ? `
                        <p class="mb-0"><small>Check console for detailed error information.</small></p>
                    ` : ''}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertBefore(document.createRange().createContextualFragment(resultsHtml), container.firstChild);
            
            // Log detailed results to console
            console.log('Bulk prep sheet generation results:', data.results);
        } else {
            alert(`Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred during bulk prep sheet generation');
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}
</script>
{% endblock %}

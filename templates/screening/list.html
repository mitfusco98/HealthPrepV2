{% extends 'base_user.html' %}

{% block title %}HealthPrep - Screening List{% endblock %}

{% block extra_css %}
<style>
/* Confidence-based color coding for document links */
.confidence-high {
    color: #155724 !important;
    background-color: #d4edda !important;
    border: 1px solid #c3e6cb !important;
}

.confidence-medium {
    color: #856404 !important;
    background-color: #fff3cd !important;
    border: 1px solid #ffeaa7 !important;
}

.confidence-low {
    color: #721c24 !important;
    background-color: #f8d7da !important;
    border: 1px solid #f5c6cb !important;
}

.confidence-high:hover, .confidence-medium:hover, .confidence-low:hover {
    opacity: 0.8;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

/* Document confidence legend */
.confidence-legend {
    font-size: 0.85em;
    margin-bottom: 10px;
}

.confidence-legend .badge {
    margin-right: 8px;
}

/* Screening status badges */
.status-complete { background-color: #28a745 !important; color: #fff !important; }
.status-due-soon { background-color: #fd7e14 !important; color: #fff !important; }
.status-due { background-color: #dc3545 !important; color: #fff !important; }

/* Modal styling */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1050;
    width: 100%;
    height: 100%;
    overflow: hidden;
    outline: 0;
}

.keywords-list {
    min-height: 60px;
}

.min-height-100 {
    min-height: 100px;
}

.keywords-badges-container {
    line-height: 1.5;
}

.keywords-badges-container .badge {
    font-size: 0.75rem;
    margin-bottom: 2px;
}

/* Tab navigation styling */
.nav-tabs .nav-link {
    color: #6c757d;
    border: 1px solid transparent;
}

.nav-tabs .nav-link.active {
    color: #fff;
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* Filter section */
.filter-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

/* Screening table styling */
.table-dark {
    --bs-table-bg: #212529;
    --bs-table-color: #fff;
}

.table-dark th {
    background-color: var(--hp-primary) !important;
    color: white !important;
    font-weight: 600;
    border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    white-space: nowrap;
    padding: 0.75rem;
}

.table-dark td {
    vertical-align: middle;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: #fff;
    padding: 0.75rem;
}

.table-dark tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.patient-info {
    min-width: 180px;
}

.patient-info .patient-name {
    font-weight: 600;
    color: #fff !important;
}

.patient-info .patient-details {
    font-size: 0.85em;
    color: #adb5bd !important;
}

.document-badges {
    max-width: 250px;
}

.documents-list {
    flex-grow: 1;
}

.documents-list .badge {
    margin-right: 2px;
    margin-bottom: 2px;
}

.document-badges .badge {
    font-size: 0.7em;
    margin-right: 2px;
    margin-bottom: 2px;
}

/* Responsive design for mobile - keep all columns visible */
@media (max-width: 768px) {
    .screening-table {
        font-size: 0.75em;
    }
    
    .patient-info {
        min-width: 120px;
    }
    
    .patient-info .patient-name {
        font-size: 0.9em;
    }
    
    .patient-info .patient-details {
        font-size: 0.8em;
    }
    
    .document-badges {
        max-width: 150px;
    }
    
    .document-badges .badge {
        font-size: 0.6em;
    }
    
    .btn-sm {
        padding: 0.1rem 0.3rem;
        font-size: 0.7em;
    }
}

@media (max-width: 576px) {
    .screening-table {
        font-size: 0.7em;
    }
    
    .patient-info {
        min-width: 100px;
    }
    
    .document-badges {
        max-width: 120px;
    }
    
    .documents-list .badge {
        display: block;
        margin-bottom: 1px;
    }
}

/* Sortable table headers */
.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
}

.sortable:hover {
    background-color: #e9ecef !important;
}

.sortable::after {
    content: '\f0dc';
    font-family: 'Font Awesome 5 Free';
    font-weight: 900;
    position: absolute;
    right: 8px;
    opacity: 0.5;
    font-size: 0.8em;
}

.sortable.asc::after {
    content: '\f0de';
    opacity: 1;
}

.sortable.desc::after {
    content: '\f0dd';
    opacity: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">
                        <i class="fas fa-list-check me-2 text-primary"></i>
                        Patient Screenings
                    </h1>
                    <p class="text-muted">Manage patient screening schedules and compliance tracking</p>
                </div>
                <div>
                    <button class="btn btn-medical-primary" onclick="refreshScreenings(event, 'list')">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="screeningTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" href="{{ url_for('screening.screening_list') }}" role="tab">
                <i class="fas fa-list me-1"></i>
                Screening List
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('screening.screening_types') }}" role="tab">
                <i class="fas fa-tags me-1"></i>
                Screening Types
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('screening.screening_settings') }}" role="tab">
                <i class="fas fa-cog me-1"></i>
                Settings
            </a>
        </li>
    </ul>

    <!-- Screening List Content -->
            <!-- Filters -->
            <div class="medical-card filter-section">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <label for="patient" class="form-label">Patient Search</label>
                        <input type="text" class="form-control" id="patient" name="patient" 
                               value="{{ request.args.get('patient', '') }}" 
                               placeholder="Name or MRN">
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Statuses</option>
                            <option value="Due" {{ 'selected' if request.args.get('status') == 'Due' }}>Due</option>
                            <option value="Due Soon" {{ 'selected' if request.args.get('status') == 'Due Soon' }}>Due Soon</option>
                            <option value="Complete" {{ 'selected' if request.args.get('status') == 'Complete' }}>Complete</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="screening_type" class="form-label">Screening Type</label>
                        <select class="form-select" id="screening_type" name="screening_type">
                            <option value="">All Types</option>
                            {% for group in screening_type_groups %}
                            <option value="{{ group.name }}" 
                                    {{ 'selected' if request.args.get('screening_type') == group.name }}>
                                {{ group.display_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-medical-primary">
                                <i class="fas fa-filter me-1"></i>
                                Apply Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Document Confidence Legend -->
            <div class="confidence-legend mb-3">
                <strong>Document Confidence:</strong>
                <span class="badge confidence-high">High</span>
                <span class="badge confidence-medium">Medium</span>
                <span class="badge confidence-low">Low</span>
            </div>

            <!-- Screening Results -->
            {% if screenings %}
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th scope="col" class="sortable text-white" data-column="patient">Patient</th>
                            <th scope="col" class="sortable text-white" data-column="screening_type">Screening Type</th>
                            <th scope="col" class="sortable text-white" data-column="status">Status</th>
                            <th scope="col" class="sortable text-white" data-column="last_completed">Last Completed</th>
                            <th scope="col" class="sortable text-white" data-column="frequency">Frequency</th>
                            <th scope="col" class="text-white">Matched Documents</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for screening in screenings %}
                        <tr>
                            <!-- Patient Information -->
                            <td class="patient-info">
                                <div class="patient-name">{{ screening.patient.full_name }}</div>
                                <div class="patient-details">
                                    MRN: {{ screening.patient.mrn }}<br>
                                    Age: {{ screening.patient.age }}
                                </div>
                            </td>
                            
                            <!-- Screening Type -->
                            <td>{{ screening.screening_type.display_name }}</td>
                            
                            <!-- Status -->
                            <td>
                                {% if screening.status == 'Complete' %}
                                    <span class="badge status-complete">
                                        <i class="fas fa-check-circle me-1"></i>{{ screening.status }}
                                    </span>
                                {% elif screening.status == 'Due Soon' %}
                                    <span class="badge status-due-soon">
                                        <i class="fas fa-clock me-1"></i>{{ screening.status }}
                                    </span>
                                {% elif screening.status == 'Due' %}
                                    <span class="badge status-due">
                                        <i class="fas fa-exclamation-circle me-1"></i>{{ screening.status }}
                                    </span>
                                {% else %}
                                    <span class="badge status-due">
                                        <i class="fas fa-exclamation-triangle me-1"></i>{{ screening.status }}
                                    </span>
                                {% endif %}
                            </td>
                            
                            <!-- Last Completed -->
                            <td>
                                {{ screening.last_completed.strftime('%m/%d/%Y') if screening.last_completed else 'Never' }}
                            </td>
                            
                            <!-- Frequency -->
                            <td>
                                {{ screening.screening_type.frequency_display }}
                            </td>
                            
                            <!-- Matched Documents -->
                            <td class="document-badges">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="documents-list">
                                        {% if screening.document_matches %}
                                            {% for match in screening.document_matches[:3] %}
                                            <span class="badge confidence-{{ match.document.confidence_level }}" 
                                                  title="Confidence: {{ (match.match_confidence * 100)|round(1) }}%">
                                                {{ match.document.filename[:20] }}{% if match.document.filename|length > 20 %}...{% endif %}
                                            </span>
                                            {% endfor %}
                                            {% if screening.document_matches|length > 3 %}
                                            <div class="text-muted small">+{{ screening.document_matches|length - 3 }} more</div>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">No matches</span>
                                        {% endif %}
                                    </div>
                                    <a href="#" class="btn btn-sm btn-medical-primary ms-2" onclick="alert('Prep sheet temporarily disabled')" title="Generate Prep Sheet">
                                        <i class="fas fa-file-medical"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Screenings Found</h5>
                <p class="text-muted">
                    {% if request.args.get('patient') or request.args.get('status') or request.args.get('screening_type') %}
                    No screenings match your current filters. Try adjusting your search criteria.
                    {% else %}
                    No patient screenings are currently configured. Add screening types to begin tracking.
                    {% endif %}
                </p>
                {% if current_user.role in ['admin', 'clinician'] %}
                <a href="{{ url_for('main.screening_types') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>
                    Configure Screening Types
                </a>
                {% endif %}
            </div>
            {% endif %}

</div>

<!-- Include screening modals JavaScript -->
<script src="{{ url_for('static', filename='js/screening_modals.js') }}"></script>
<!-- Include performance optimization JavaScript -->
<script src="{{ url_for('static', filename='js/screening_performance.js') }}"></script>
{% endblock %}

{% block extra_js %}
<script>
// Table sorting functionality
function sortTable(column) {
    const table = document.querySelector('.screening-table tbody');
    const rows = Array.from(table.querySelectorAll('tr'));
    const header = document.querySelector(`[data-column="${column}"]`);
    const isAsc = header.classList.contains('asc');
    
    // Clear all sort indicators
    document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('asc', 'desc');
    });
    
    // Set new sort indicator
    header.classList.add(isAsc ? 'desc' : 'asc');
    
    rows.sort((a, b) => {
        let aValue, bValue;
        
        switch(column) {
            case 'patient':
                aValue = a.querySelector('.patient-name').textContent.trim();
                bValue = b.querySelector('.patient-name').textContent.trim();
                break;
            case 'screening_type':
                aValue = a.cells[1].textContent.trim();
                bValue = b.cells[1].textContent.trim();
                break;
            case 'status':
                aValue = a.cells[2].textContent.trim();
                bValue = b.cells[2].textContent.trim();
                break;
            case 'last_completed':
                aValue = a.cells[3].textContent.trim();
                bValue = b.cells[3].textContent.trim();
                // Handle "Never" value
                if (aValue === 'Never') aValue = '01/01/1900';
                if (bValue === 'Never') bValue = '01/01/1900';
                aValue = new Date(aValue);
                bValue = new Date(bValue);
                break;
            case 'frequency':
                aValue = a.cells[4].textContent.trim();
                bValue = b.cells[4].textContent.trim();
                break;
        }
        
        if (aValue < bValue) return isAsc ? 1 : -1;
        if (aValue > bValue) return isAsc ? -1 : 1;
        return 0;
    });
    
    // Rebuild table
    rows.forEach(row => table.appendChild(row));
}

// Add click listeners to sortable headers
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            sortTable(this.dataset.column);
        });
    });
});
// Enhanced refresh functionality that works across all tabs
function refreshScreenings(event, tab) {
    // Prevent default link behavior
    event.preventDefault();
    
    const button = event.target.closest('button') || event.target.closest('a');
    const originalText = button.innerHTML;
    const confirmMessage = tab === 'types' 
        ? 'Discover and sync automated screenings from Epic EMR using the current parsing rules? This will find Epic patients, import them, and update document matches.'
        : 'Discover and sync patient data from Epic EMR? This will automatically find Epic patients, import them locally, fetch their medical records, conditions, documents, and update all screening statuses.';

    if (confirm(confirmMessage)) {
        // Show loading state
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Discovering and syncing from EMR...';
        button.disabled = true;

        // Make refresh request
        fetch('/api/refresh-screenings', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrf_token(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    Patient discovery and EMR sync completed successfully!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const container = document.querySelector('.container-fluid');
                container.insertBefore(alertDiv, container.firstChild);
                
                // Reload page after short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                throw new Error(data.error || 'Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error refreshing screenings:', error);
            
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error discovering and syncing EMR data: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

// Tab switching with URL updates
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const targetTab = e.target.getAttribute('data-bs-target').replace('#', '').replace('-content', '');
            const url = new URL(window.location);
            url.searchParams.set('tab', targetTab);
            window.history.replaceState({}, '', url);
        });
    });
    
    // Load tab from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab');
    if (activeTab) {
        const tabElement = document.querySelector(`#${activeTab}-tab`);
        if (tabElement) {
            const tab = new bootstrap.Tab(tabElement);
            tab.show();
        }
    }
});

// Auto-refresh status indicators every 5 minutes
setInterval(function() {
    const statusBadges = document.querySelectorAll('.badge[class*="status-"]');
    if (statusBadges.length > 0) {
        // Subtle visual indication of auto-refresh
        statusBadges.forEach(badge => {
            badge.style.opacity = '0.7';
            setTimeout(() => badge.style.opacity = '1', 500);
        });
    }
}, 5 * 60 * 1000);
</script>
{% endblock %}

{% extends 'base_user.html' %}

{% block title %}HealthPrep - Checklist Settings{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-cog me-2"></i>Prep Sheet Settings</h1>
        <a href="{{ url_for('screening_list') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Back to Screenings
        </a>
    </div>

    <div class="alert alert-info mb-4">
        <i class="fas fa-info-circle me-2"></i>
        <strong>About Prep Sheet Settings:</strong> These settings control how far back in time the system looks 
        for medical data when generating prep sheets. Longer timeframes provide more comprehensive history but may 
        include outdated information.
    </div>

    <form method="POST" action="{{ url_for('checklist_settings') }}">
        <div class="row">
            <!-- Data Cutoff Settings -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Medical Data Cutoff Settings
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            Configure how far back to look for different types of medical data when generating prep sheets.
                        </p>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="labs_cutoff_months" class="form-label">
                                    <i class="fas fa-vial me-1"></i>
                                    Laboratory Results
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="labs_cutoff_months" 
                                           name="labs_cutoff_months" value="{{ settings.labs_cutoff_months }}" 
                                           min="1" max="60" required>
                                    <span class="input-group-text">months</span>
                                </div>
                                <div class="form-text">
                                    Current: {{ settings.labs_cutoff_months }} months 
                                    ({{ (settings.labs_cutoff_months / 12)|round(1) }} years)
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="imaging_cutoff_months" class="form-label">
                                    <i class="fas fa-x-ray me-1"></i>
                                    Imaging Studies
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="imaging_cutoff_months" 
                                           name="imaging_cutoff_months" value="{{ settings.imaging_cutoff_months }}" 
                                           min="1" max="60" required>
                                    <span class="input-group-text">months</span>
                                </div>
                                <div class="form-text">
                                    Current: {{ settings.imaging_cutoff_months }} months 
                                    ({{ (settings.imaging_cutoff_months / 12)|round(1) }} years)
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="consults_cutoff_months" class="form-label">
                                    <i class="fas fa-user-md me-1"></i>
                                    Specialist Consults
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="consults_cutoff_months" 
                                           name="consults_cutoff_months" value="{{ settings.consults_cutoff_months }}" 
                                           min="1" max="60" required>
                                    <span class="input-group-text">months</span>
                                </div>
                                <div class="form-text">
                                    Current: {{ settings.consults_cutoff_months }} months 
                                    ({{ (settings.consults_cutoff_months / 12)|round(1) }} years)
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="hospital_cutoff_months" class="form-label">
                                    <i class="fas fa-hospital me-1"></i>
                                    Hospital Visits
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="hospital_cutoff_months" 
                                           name="hospital_cutoff_months" value="{{ settings.hospital_cutoff_months }}" 
                                           min="1" max="60" required>
                                    <span class="input-group-text">months</span>
                                </div>
                                <div class="form-text">
                                    Current: {{ settings.hospital_cutoff_months }} months 
                                    ({{ (settings.hospital_cutoff_months / 12)|round(1) }} years)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Options -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-tags me-2"></i>
                            Custom Status Options
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Define custom status options that can be used in prep sheets.
                        </p>

                        <div class="mb-3">
                            <label for="status_input" class="form-label">Add Status Option</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="status_input" 
                                       placeholder="Enter status option (e.g., Pending Review)">
                                <button type="button" class="btn btn-outline-primary" onclick="addStatusOption()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div id="status_options_display">
                            {% if settings.status_options %}
                                {% for status in settings.status_options %}
                                    <span class="badge bg-secondary me-2 mb-2">
                                        {{ status }}
                                        <button type="button" class="btn-close btn-close-white ms-1" 
                                                onclick="removeStatusOption('{{ status }}')"></button>
                                    </span>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No custom status options defined.</p>
                            {% endif %}
                        </div>

                        <input type="hidden" id="status_options" name="status_options" 
                               value="{{ settings.status_options|tojson if settings.status_options else '[]' }}">
                    </div>
                </div>

                <!-- Default Items -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list-check me-2"></i>
                            Default Checklist Items
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Define default items that always appear on prep sheet checklists.
                        </p>

                        <div class="mb-3">
                            <label for="item_input" class="form-label">Add Default Item</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="item_input" 
                                       placeholder="Enter checklist item (e.g., Verify insurance information)">
                                <button type="button" class="btn btn-outline-primary" onclick="addDefaultItem()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div id="default_items_display">
                            {% if settings.default_items %}
                                {% for item in settings.default_items %}
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span class="flex-grow-1">{{ item }}</span>
                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                onclick="removeDefaultItem('{{ item }}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No default checklist items defined.</p>
                            {% endif %}
                        </div>

                        <input type="hidden" id="default_items" name="default_items" 
                               value="{{ settings.default_items|tojson if settings.default_items else '[]' }}">
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Recommendations -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-lightbulb me-2"></i>
                            Recommended Settings
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Laboratory Results:</strong>
                            <p class="small text-muted mb-1">12-18 months for routine monitoring</p>
                            <p class="small text-muted">6-12 months for chronic conditions</p>
                        </div>

                        <div class="mb-3">
                            <strong>Imaging Studies:</strong>
                            <p class="small text-muted mb-1">24-36 months for screening</p>
                            <p class="small text-muted">12-24 months for surveillance</p>
                        </div>

                        <div class="mb-3">
                            <strong>Specialist Consults:</strong>
                            <p class="small text-muted mb-1">12-24 months typical</p>
                            <p class="small text-muted">6-12 months for complex cases</p>
                        </div>

                        <div class="mb-0">
                            <strong>Hospital Visits:</strong>
                            <p class="small text-muted mb-1">12-24 months for context</p>
                            <p class="small text-muted">Recent admissions are most relevant</p>
                        </div>
                    </div>
                </div>

                <!-- Current Summary -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-pie me-2"></i>
                            Current Settings Summary
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-2">
                                <div class="text-primary h4">{{ settings.labs_cutoff_months }}</div>
                                <small class="text-muted">Labs (mo)</small>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="text-info h4">{{ settings.imaging_cutoff_months }}</div>
                                <small class="text-muted">Imaging (mo)</small>
                            </div>
                            <div class="col-6">
                                <div class="text-success h4">{{ settings.consults_cutoff_months }}</div>
                                <small class="text-muted">Consults (mo)</small>
                            </div>
                            <div class="col-6">
                                <div class="text-warning h4">{{ settings.hospital_cutoff_months }}</div>
                                <small class="text-muted">Hospital (mo)</small>
                            </div>
                        </div>

                        <hr>

                        <div class="text-center">
                            <div class="h5">{{ settings.default_items|length if settings.default_items else 0 }}</div>
                            <small class="text-muted">Default Items</small>
                        </div>

                        <div class="text-center mt-2">
                            <div class="h5">{{ settings.status_options|length if settings.status_options else 0 }}</div>
                            <small class="text-muted">Status Options</small>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="card">
                    <div class="card-body">
                        <button type="submit" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-save me-1"></i>Save Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="resetToDefaults()">
                            <i class="fas fa-undo me-1"></i>Reset to Defaults
                        </button>
                        
                        {% if settings.updated_at %}
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                Last updated: {{ settings.updated_at.strftime('%m/%d/%Y %H:%M') }}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
let statusOptions = {{ settings.status_options|tojson if settings.status_options else '[]' }};
let defaultItems = {{ settings.default_items|tojson if settings.default_items else '[]' }};

function addStatusOption() {
    const input = document.getElementById('status_input');
    const value = input.value.trim();
    
    if (value && !statusOptions.includes(value)) {
        statusOptions.push(value);
        updateStatusOptionsDisplay();
        input.value = '';
    }
}

function removeStatusOption(option) {
    statusOptions = statusOptions.filter(s => s !== option);
    updateStatusOptionsDisplay();
}

function updateStatusOptionsDisplay() {
    const display = document.getElementById('status_options_display');
    const hiddenInput = document.getElementById('status_options');
    
    if (statusOptions.length > 0) {
        display.innerHTML = statusOptions.map(option => 
            `<span class="badge bg-secondary me-2 mb-2">
                ${option}
                <button type="button" class="btn-close btn-close-white ms-1" 
                        onclick="removeStatusOption('${option}')"></button>
            </span>`
        ).join('');
    } else {
        display.innerHTML = '<p class="text-muted">No custom status options defined.</p>';
    }
    
    hiddenInput.value = JSON.stringify(statusOptions);
}

function addDefaultItem() {
    const input = document.getElementById('item_input');
    const value = input.value.trim();
    
    if (value && !defaultItems.includes(value)) {
        defaultItems.push(value);
        updateDefaultItemsDisplay();
        input.value = '';
    }
}

function removeDefaultItem(item) {
    defaultItems = defaultItems.filter(i => i !== item);
    updateDefaultItemsDisplay();
}

function updateDefaultItemsDisplay() {
    const display = document.getElementById('default_items_display');
    const hiddenInput = document.getElementById('default_items');
    
    if (defaultItems.length > 0) {
        display.innerHTML = defaultItems.map(item => 
            `<div class="d-flex align-items-center mb-2">
                <i class="fas fa-check-circle text-success me-2"></i>
                <span class="flex-grow-1">${item}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        onclick="removeDefaultItem('${item}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>`
        ).join('');
    } else {
        display.innerHTML = '<p class="text-muted">No default checklist items defined.</p>';
    }
    
    hiddenInput.value = JSON.stringify(defaultItems);
}

function resetToDefaults() {
    if (confirm('Reset all settings to recommended defaults? This will overwrite your current configuration.')) {
        document.getElementById('labs_cutoff_months').value = 12;
        document.getElementById('imaging_cutoff_months').value = 24;
        document.getElementById('consults_cutoff_months').value = 12;
        document.getElementById('hospital_cutoff_months').value = 12;
        
        statusOptions = [];
        defaultItems = [
            'Verify patient insurance information',
            'Review medication list for accuracy',
            'Confirm allergies and adverse reactions',
            'Check emergency contact information'
        ];
        
        updateStatusOptionsDisplay();
        updateDefaultItemsDisplay();
    }
}

// Handle Enter key for inputs
document.getElementById('status_input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addStatusOption();
    }
});

document.getElementById('item_input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addDefaultItem();
    }
});
</script>
{% endblock %}

{% extends 'base_admin.html' %}

{% block title %}HealthPrep Admin - OCR Monitor{% endblock %}

{% block content %}
<div class="admin-header text-center">
    <h1><i class="fas fa-file-medical me-3"></i>OCR Processing Monitor</h1>
    <p class="lead mb-0">Document processing quality and performance monitoring</p>
</div>

<!-- OCR Statistics Overview -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-file-alt fa-2x mb-3"></i>
                <h3>{{ stats.total_documents or 0 }}</h3>
                <p class="mb-0">Total Documents</p>
                <small>{{ stats.ocr_processed or 0 }} processed</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-percentage fa-2x mb-3"></i>
                <h3>{{ "%.1f"|format((stats.success_rate or 0)) }}%</h3>
                <p class="mb-0">Success Rate</p>
                <small>Processing accuracy</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-star fa-2x mb-3"></i>
                <h3>{{ "%.1f"|format((stats.average_confidence or 0) * 100) }}%</h3>
                <p class="mb-0">Avg Confidence</p>
                <small>Text extraction quality</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card stat-card">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-3"></i>
                <h3>{{ stats.recent_processed or 0 }}</h3>
                <p class="mb-0">Recent (7 days)</p>
                <small>Documents processed</small>
            </div>
        </div>
    </div>
</div>

<!-- Processing Quality Charts -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="card admin-table">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie me-2"></i>Confidence Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="confidenceDistributionChart" height="200"></canvas>
                
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="confidence-indicator confidence-high"></div>
                            <strong>{{ stats.confidence_distribution.high or 0 }}</strong>
                            <br><small>High (â‰¥80%)</small>
                        </div>
                        <div class="col-4">
                            <div class="confidence-indicator confidence-medium"></div>
                            <strong>{{ stats.confidence_distribution.medium or 0 }}</strong>
                            <br><small>Medium (60-79%)</small>
                        </div>
                        <div class="col-4">
                            <div class="confidence-indicator confidence-low"></div>
                            <strong>{{ stats.confidence_distribution.low or 0 }}</strong>
                            <br><small>Low (<60%)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="card admin-table">
            <div class="card-header">
                <h5><i class="fas fa-file-medical me-2"></i>Document Types</h5>
            </div>
            <div class="card-body">
                <canvas id="documentTypesChart" height="200"></canvas>
                
                <div class="mt-3">
                    {% for doc_type, count in stats.document_types.items() %}
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-capitalize">
                            {% if doc_type == 'lab' %}
                                <i class="fas fa-vial me-1"></i>Laboratory
                            {% elif doc_type == 'imaging' %}
                                <i class="fas fa-x-ray me-1"></i>Imaging
                            {% elif doc_type == 'consult' %}
                                <i class="fas fa-user-md me-1"></i>Consults
                            {% elif doc_type == 'hospital' %}
                                <i class="fas fa-hospital me-1"></i>Hospital
                            {% else %}
                                <i class="fas fa-file me-1"></i>{{ doc_type or 'Other' }}
                            {% endif %}
                        </span>
                        <span class="badge bg-primary">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Processing Queue and Status -->
<div class="row mb-4">
    <div class="col-lg-8 mb-4">
        <div class="card admin-table">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list me-2"></i>Recent Processing Activity</h5>
                <span class="badge bg-info">Last 20 documents</span>
            </div>
            <div class="card-body">
                {% if recent_docs %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th>Patient</th>
                                    <th>Type</th>
                                    <th>Upload Date</th>
                                    <th>Confidence</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in recent_docs %}
                                <tr>
                                    <td>
                                        <i class="fas fa-file-medical me-1"></i>
                                        <small>{{ doc.filename[:30] }}{% if doc.filename|length > 30 %}...{% endif %}</small>
                                    </td>
                                    <td>
                                        {% if doc.patient %}
                                            <small>{{ doc.patient.full_name }}</small>
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if doc.document_type %}
                                            <span class="badge bg-secondary">{{ doc.document_type.title() }}</span>
                                        {% else %}
                                            <span class="badge bg-dark">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ doc.upload_date.strftime('%m/%d/%Y %H:%M') if doc.upload_date else 'N/A' }}</small>
                                    </td>
                                    <td>
                                        {% if doc.ocr_confidence is not none %}
                                            <div class="d-flex align-items-center">
                                                <div class="confidence-indicator confidence-{{ doc.confidence_level }} me-2"></div>
                                                <small>{{ "%.1f"|format(doc.ocr_confidence * 100) }}%</small>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if doc.ocr_confidence is not none %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Processed
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i>Pending
                                            </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>No recent documents to display</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card admin-table">
            <div class="card-header">
                <h5><i class="fas fa-tachometer-alt me-2"></i>Processing Status</h5>
            </div>
            <div class="card-body">
                <!-- Processing Queue Status -->
                <div class="mb-4">
                    <h6><i class="fas fa-hourglass-half me-2"></i>Queue Status</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Pending Processing</span>
                        <span class="badge bg-warning text-dark">{{ stats.pending_processing or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Successfully Processed</span>
                        <span class="badge bg-success">{{ stats.ocr_processed or 0 }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>PHI Filtered</span>
                        <span class="badge bg-info">{{ stats.phi_filtered_count or 0 }}</span>
                    </div>
                </div>
                
                <!-- Performance Metrics -->
                <div class="mb-4">
                    <h6><i class="fas fa-chart-line me-2"></i>Performance</h6>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Processing Rate</span>
                        <span class="badge bg-primary">{{ "%.1f"|format(stats.success_rate or 0) }}%</span>
                    </div>
                    <div class="progress mb-3">
                        <div class="progress-bar bg-primary" 
                             style="width: {{ stats.success_rate or 0 }}%"></div>
                    </div>
                </div>
                
                <!-- System Health -->
                <div>
                    <h6><i class="fas fa-heartbeat me-2"></i>System Health</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-circle text-success me-1"></i>
                            <small>OCR Service: Online</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-circle text-success me-1"></i>
                            <small>Tesseract: Active</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-circle text-success me-1"></i>
                            <small>PHI Filter: Enabled</small>
                        </li>
                        <li>
                            <i class="fas fa-circle text-success me-1"></i>
                            <small>Queue: Processing</small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Low Confidence Documents Alert -->
{% set low_confidence_count = stats.confidence_distribution.low or 0 %}
{% if low_confidence_count > 0 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert admin-alert" role="alert">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>Low Confidence Documents
                    </h5>
                    <p class="mb-0">
                        {{ low_confidence_count }} documents have low OCR confidence scores and may require manual review.
                    </p>
                </div>
                <button type="button" class="btn btn-warning" onclick="showLowConfidenceDetails()">
                    <i class="fas fa-eye me-1"></i>Review
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- OCR Settings Quick Access -->
<div class="row">
    <div class="col-12">
        <div class="card admin-table">
            <div class="card-header">
                <h5><i class="fas fa-cogs me-2"></i>OCR Management</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-grid">
                            <a href="{{ url_for('admin.phi_settings') }}" class="btn btn-outline-warning">
                                <i class="fas fa-shield-alt me-2"></i>PHI Settings
                            </a>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-info" onclick="refreshOCRStats()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh Stats
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-success" onclick="testOCRSystem()">
                                <i class="fas fa-vial me-2"></i>Test OCR
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button type="button" class="btn btn-outline-primary" onclick="exportOCRReport()">
                                <i class="fas fa-download me-2"></i>Export Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Confidence Distribution Chart
    const confCtx = document.getElementById('confidenceDistributionChart').getContext('2d');
    new Chart(confCtx, {
        type: 'doughnut',
        data: {
            labels: ['High Confidence', 'Medium Confidence', 'Low Confidence'],
            datasets: [{
                data: [
                    {{ stats.confidence_distribution.high or 0 }},
                    {{ stats.confidence_distribution.medium or 0 }},
                    {{ stats.confidence_distribution.low or 0 }}
                ],
                backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                borderWidth: 2,
                borderColor: '#495057'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#ffffff',
                        padding: 20
                    }
                }
            }
        }
    });
    
    // Document Types Chart
    const typesCtx = document.getElementById('documentTypesChart').getContext('2d');
    const documentTypes = {{ stats.document_types.keys()|list|tojson }};
    const documentCounts = {{ stats.document_types.values()|list|tojson }};
    
    new Chart(typesCtx, {
        type: 'bar',
        data: {
            labels: documentTypes.map(type => type.charAt(0).toUpperCase() + type.slice(1)),
            datasets: [{
                label: 'Documents',
                data: documentCounts,
                backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1'],
                borderColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#ffffff'
                    },
                    grid: {
                        color: '#495057'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    },
                    grid: {
                        color: '#495057'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
});

// OCR Management Functions
function refreshOCRStats() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
    button.disabled = true;
    
    // Reload the page to refresh stats
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function testOCRSystem() {
    if (confirm('Run OCR system test? This will process a sample document to verify system functionality.')) {
        const button = event.target;
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
        button.disabled = true;
        
        // Simulate test (in real implementation, this would call a test endpoint)
        setTimeout(() => {
            alert('OCR system test completed successfully!');
            button.innerHTML = originalText;
            button.disabled = false;
        }, 3000);
    }
}

function exportOCRReport() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exporting...';
    button.disabled = true;
    
    // Create download link
    const reportData = {
        timestamp: new Date().toISOString(),
        stats: {{ stats|tojson }},
        summary: {
            total_documents: {{ stats.total_documents or 0 }},
            success_rate: {{ stats.success_rate or 0 }},
            avg_confidence: {{ stats.average_confidence or 0 }}
        }
    };
    
    const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ocr_report_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    button.innerHTML = originalText;
    button.disabled = false;
}

function showLowConfidenceDetails() {
    alert('Low confidence documents require manual review. This feature will show detailed document analysis in a future update.');
}

// Auto-refresh every 30 seconds
setInterval(function() {
    if (document.visibilityState === 'visible') {
        location.reload();
    }
}, 30000);
</script>
{% endblock %}

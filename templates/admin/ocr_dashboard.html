{% extends "base_admin.html" %}

{% block title %}OCR Dashboard - HealthPrep Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-scan me-2"></i>
        OCR Processing Dashboard
    </h2>
    <div>
        <button class="btn btn-outline-primary me-2" onclick="refreshOCRData()">
            <i class="fas fa-sync me-1"></i>Refresh Data
        </button>
        <button class="btn btn-outline-info" onclick="showOCRSettings()">
            <i class="fas fa-cog me-1"></i>Settings
        </button>
    </div>
</div>

<!-- Processing Statistics Row -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ data.statistics.total_documents or 0 }}</div>
                <div class="h6 mb-0">Total Documents</div>
                <small class="opacity-75">processed</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ "%.1f"|format(data.statistics.average_confidence or 0) }}%</div>
                <div class="h6 mb-0">Avg Confidence</div>
                <small class="opacity-75">OCR accuracy</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ data.statistics.processing_success_rate or 0 }}%</div>
                <div class="h6 mb-0">Success Rate</div>
                <small class="opacity-75">processing</small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card">
            <div class="card-body text-center">
                <div class="metric-value">{{ data.queue_status.pending_documents or 0 }}</div>
                <div class="h6 mb-0">Queue Size</div>
                <small class="opacity-75">pending</small>
            </div>
        </div>
    </div>
</div>

<!-- Processing Queue and Confidence Analysis -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card admin-card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Processing Queue Status
                </h5>
            </div>
            <div class="card-body">
                {% if data.queue_status %}
                    <div class="row text-center mb-4">
                        <div class="col-6">
                            <div class="h4 mb-1 text-warning">{{ data.queue_status.pending_documents or 0 }}</div>
                            <small class="text-muted">Pending Documents</small>
                        </div>
                        <div class="col-6">
                            <div class="h4 mb-1 text-success">{{ data.queue_status.recently_processed or 0 }}</div>
                            <small class="text-muted">Last Hour</small>
                        </div>
                    </div>
                    
                    <div class="alert {{ 'alert-warning' if data.queue_status.queue_status == 'busy' else 'alert-success' }} mb-3">
                        <i class="fas fa-{{ 'exclamation-triangle' if data.queue_status.queue_status == 'busy' else 'check-circle' }} me-2"></i>
                        Queue Status: <strong>{{ data.queue_status.queue_status.title() }}</strong>
                    </div>
                    
                    {% if data.queue_status.queue_status == 'busy' %}
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                 role="progressbar" style="width: 75%">
                                Processing...
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-hourglass-half fa-2x mb-3"></i>
                        <p>Queue status unavailable</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card admin-card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Confidence Distribution
                </h5>
            </div>
            <div class="card-body">
                {% if data.statistics.confidence_distribution %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-success">High Confidence (85%+)</span>
                            <span>{{ data.statistics.confidence_distribution.high.count or 0 }} documents</span>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar bg-success" 
                                 style="width: {{ data.statistics.confidence_distribution.high.percentage or 0 }}%">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-warning">Medium Confidence (60-84%)</span>
                            <span>{{ data.statistics.confidence_distribution.medium.count or 0 }} documents</span>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar bg-warning" 
                                 style="width: {{ data.statistics.confidence_distribution.medium.percentage or 0 }}%">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-danger">Low Confidence (<60%)</span>
                            <span>{{ data.statistics.confidence_distribution.low.count or 0 }} documents</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" 
                                 style="width: {{ data.statistics.confidence_distribution.low.percentage or 0 }}%">
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-pie fa-2x mb-3"></i>
                        <p>No confidence data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Document Type Analysis and Low Confidence Documents -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card admin-card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Low Confidence Documents Requiring Review
                </h5>
            </div>
            <div class="card-body">
                {% if data.low_confidence_documents %}
                    <div class="table-responsive">
                        <table class="table admin-table mb-0">
                            <thead>
                                <tr>
                                    <th>Document</th>
                                    <th>Patient</th>
                                    <th>Type</th>
                                    <th>Confidence</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in data.low_confidence_documents %}
                                    <tr>
                                        <td>
                                            <div>
                                                <strong>{{ doc.filename[:30] }}{% if doc.filename|length > 30 %}...{% endif %}</strong>
                                                <br>
                                                <small class="text-muted">{{ doc.text_length or 0 }} characters</small>
                                            </div>
                                        </td>
                                        <td>
                                            <small>ID: {{ doc.patient_id }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ (doc.document_type or 'unknown').title() }}</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-{{ 'danger' if doc.confidence < 40 else 'warning' }} me-2">
                                                    {{ "%.1f"|format(doc.confidence or 0) }}%
                                                </span>
                                                <span class="badge bg-light text-dark">{{ doc.quality_flag.title() }}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <small>{{ doc.created_at.strftime('%m/%d/%Y') if doc.created_at else 'Unknown' }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" 
                                                        onclick="viewDocument({{ doc.id }})" title="View Document">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" 
                                                        onclick="flagForReview({{ doc.id }})" title="Flag for Review">
                                                    <i class="fas fa-flag"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if data.low_confidence_documents|length >= 20 %}
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary" onclick="loadMoreLowConfidence()">
                                <i class="fas fa-chevron-down me-1"></i>Load More
                            </button>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-2x mb-3 text-success"></i>
                        <h5>No Low Confidence Documents</h5>
                        <p>All recent documents have acceptable confidence levels.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card admin-card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    Document Types
                </h5>
            </div>
            <div class="card-body">
                {% if data.statistics.document_types %}
                    {% for doc_type, stats in data.statistics.document_types.items() %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong>{{ doc_type.title() }}</strong>
                                <br>
                                <small class="text-muted">{{ stats.count }} documents</small>
                            </div>
                            <div class="text-end">
                                <div class="badge bg-{{ 'success' if stats.avg_confidence >= 85 else 'warning' if stats.avg_confidence >= 60 else 'danger' }}">
                                    {{ "%.1f"|format(stats.avg_confidence or 0) }}%
                                </div>
                            </div>
                        </div>
                        <div class="progress mb-3" style="height: 4px;">
                            <div class="progress-bar bg-{{ 'success' if stats.avg_confidence >= 85 else 'warning' if stats.avg_confidence >= 60 else 'danger' }}" 
                                 style="width: {{ stats.avg_confidence or 0 }}%">
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-file fa-2x mb-3"></i>
                        <p>No document type data</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Confidence Trend Chart -->
<div class="row">
    <div class="col-12">
        <div class="card admin-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Confidence Trend (Last 30 Days)
                </h5>
            </div>
            <div class="card-body">
                {% if data.confidence_trend %}
                    <canvas id="confidenceTrendChart" style="height: 300px;"></canvas>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-chart-line fa-2x mb-3"></i>
                        <p>Insufficient data for trend analysis</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- OCR Settings Modal -->
<div class="modal fade" id="ocrSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>OCR Processing Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Processing Configuration</h6>
                        <div class="mb-3">
                            <label class="form-label">Confidence Threshold</label>
                            <input type="range" class="form-range" min="40" max="90" value="60" id="confidenceThreshold">
                            <div class="d-flex justify-content-between">
                                <small>40%</small>
                                <small>90%</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Processing Timeout (seconds)</label>
                            <input type="number" class="form-control" value="300" min="60" max="600">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Quality Settings</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" checked id="enablePreprocessing">
                            <label class="form-check-label" for="enablePreprocessing">
                                Enable image preprocessing
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" checked id="enableEnhancement">
                            <label class="form-check-label" for="enableEnhancement">
                                Enable text enhancement
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" checked id="enableMedicalTerms">
                            <label class="form-check-label" for="enableMedicalTerms">
                                Medical terminology optimization
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveOCRSettings()">
                    <i class="fas fa-save me-2"></i>Save Settings
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Refresh OCR data
function refreshOCRData() {
    showLoading('Refreshing OCR data...');
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// Show OCR settings modal
function showOCRSettings() {
    const modal = new bootstrap.Modal(document.getElementById('ocrSettingsModal'));
    modal.show();
}

// Save OCR settings
function saveOCRSettings() {
    showLoading('Saving OCR settings...');
    
    // In a real implementation, this would send settings to server
    setTimeout(() => {
        hideLoading();
        const modal = bootstrap.Modal.getInstance(document.getElementById('ocrSettingsModal'));
        modal.hide();
        
        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            <i class="fas fa-check me-2"></i>OCR settings saved successfully
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid > div').prepend(alert);
        
        setTimeout(() => alert.remove(), 3000);
    }, 1000);
}

// View document details
function viewDocument(docId) {
    // In a real implementation, this would open document viewer
    alert(`View document ${docId} - This would open the document viewer`);
}

// Flag document for review
function flagForReview(docId) {
    if (confirm('Flag this document for manual review?')) {
        showLoading('Flagging document...');
        
        setTimeout(() => {
            hideLoading();
            alert('Document flagged for review');
        }, 500);
    }
}

// Load more low confidence documents
function loadMoreLowConfidence() {
    showLoading('Loading more documents...');
    
    setTimeout(() => {
        hideLoading();
        // In real implementation, this would load more documents via AJAX
        alert('More documents would be loaded here');
    }, 1000);
}

// Initialize confidence trend chart
document.addEventListener('DOMContentLoaded', function() {
    {% if data.confidence_trend %}
        const trendData = {{ data.confidence_trend|tojson }};
        
        if (trendData.length > 0 && typeof Chart !== 'undefined') {
            const ctx = document.getElementById('confidenceTrendChart');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(d => d.date),
                    datasets: [{
                        label: 'Average Confidence',
                        data: trendData.map(d => d.average_confidence),
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Document Count',
                        data: trendData.map(d => d.document_count),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Confidence %'
                            },
                            min: 0,
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Document Count'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.datasetIndex === 0) {
                                        label += context.parsed.y.toFixed(1) + '%';
                                    } else {
                                        label += context.parsed.y + ' documents';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    {% endif %}
    
    // Update confidence threshold display
    const thresholdSlider = document.getElementById('confidenceThreshold');
    if (thresholdSlider) {
        thresholdSlider.addEventListener('input', function() {
            // Update display of current threshold value
            console.log('Confidence threshold:', this.value + '%');
        });
    }
});

// Auto-refresh every 2 minutes
setInterval(function() {
    console.log('Auto-refreshing OCR data...');
    // Uncomment for actual auto-refresh
    // refreshOCRData();
}, 120000);
</script>
{% endblock %}

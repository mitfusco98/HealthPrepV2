{% extends 'base_admin.html' %}

{% block title %}OCR Dashboard - HealthPrep Admin{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>
            <i class="fas fa-eye me-2"></i>
            OCR Processing Dashboard
        </h2>
        <p class="text-muted mb-0">Document processing monitoring and quality assessment</p>
    </div>
    <div>
        <button class="btn btn-primary" onclick="refreshOCRStats()">
            <i class="fas fa-sync-alt me-1"></i>
            Refresh Stats
        </button>
    </div>
</div>

<!-- OCR Overview Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card card">
            <div class="card-body text-center">
                <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                <h4 class="mb-1" id="totalDocs">{{ stats.overview.total_documents if stats else 0 }}</h4>
                <p class="text-muted mb-0">Total Documents</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card card">
            <div class="card-body text-center">
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h4 class="mb-1" id="processedDocs">{{ stats.overview.processed_documents if stats else 0 }}</h4>
                <p class="text-muted mb-0">Processed</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card card">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                <h4 class="mb-1" id="pendingDocs">{{ stats.overview.pending_documents if stats else 0 }}</h4>
                <p class="text-muted mb-0">Pending</p>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="metric-card card">
            <div class="card-body text-center">
                <i class="fas fa-percentage fa-2x text-info mb-2"></i>
                <h4 class="mb-1" id="processingRate">{{ stats.overview.processing_rate|round(1) if stats else 0 }}%</h4>
                <p class="text-muted mb-0">Processing Rate</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Confidence Distribution -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Confidence Distribution
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="confidenceChart"></canvas>
                </div>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="badge bg-success mb-1">Excellent</div>
                            <div class="small">{{ stats.quality_distribution.excellent if stats else 0 }}</div>
                        </div>
                        <div class="col-3">
                            <div class="badge bg-info mb-1">Good</div>
                            <div class="small">{{ stats.quality_distribution.good if stats else 0 }}</div>
                        </div>
                        <div class="col-3">
                            <div class="badge bg-warning mb-1">Fair</div>
                            <div class="small">{{ stats.quality_distribution.fair if stats else 0 }}</div>
                        </div>
                        <div class="col-3">
                            <div class="badge bg-danger mb-1">Poor</div>
                            <div class="small">{{ stats.quality_distribution.poor if stats else 0 }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Processing Activity -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Processing Activity (7 days)
                </h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OCR Quality and Performance -->
<div class="row mb-4">
    <!-- Quality Metrics -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-star me-2"></i>
                    Quality Metrics
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Average Confidence</span>
                        <span class="badge bg-primary">{{ stats.confidence_stats.average|round(1) if stats else 0 }}%</span>
                    </div>
                    <div class="progress mt-1" style="height: 6px;">
                        <div class="progress-bar" 
                             style="width: {{ stats.confidence_stats.average if stats else 0 }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Median Confidence</span>
                        <span class="badge bg-info">{{ stats.confidence_stats.median|round(1) if stats else 0 }}%</span>
                    </div>
                    <div class="progress mt-1" style="height: 6px;">
                        <div class="progress-bar bg-info" 
                             style="width: {{ stats.confidence_stats.median if stats else 0 }}%"></div>
                    </div>
                </div>
                
                <hr>
                
                <div class="small text-muted">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Min Confidence:</span>
                        <span>{{ stats.confidence_stats.min|round(1) if stats else 0 }}%</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>Max Confidence:</span>
                        <span>{{ stats.confidence_stats.max|round(1) if stats else 0 }}%</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Documents Analyzed:</span>
                        <span>{{ stats.confidence_stats.count if stats else 0 }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Processing Times -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-stopwatch me-2"></i>
                    Processing Times
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Current Queue:</strong>
                    <div class="mt-1">
                        <div class="d-flex justify-content-between small">
                            <span>PDF Documents:</span>
                            <span>{{ stats.processing_times.pending_breakdown.pdf_documents if stats else 0 }}</span>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span>Image Documents:</span>
                            <span>{{ stats.processing_times.pending_breakdown.image_documents if stats else 0 }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>Estimated Completion:</strong>
                    <div class="badge bg-warning text-dark">
                        {{ stats.processing_times.estimated_total_time if stats else 'Unknown' }}
                    </div>
                </div>
                
                <hr>
                
                <div class="small">
                    <strong>Estimated Processing Times:</strong>
                    <ul class="mb-0 mt-1">
                        <li>Single Page PDF: 15-30 sec</li>
                        <li>Multi-page PDF: 1-3 min</li>
                        <li>High-res Image: 30-60 sec</li>
                        <li>Low-res Image: 10-20 sec</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- PHI Filtering Status -->
    <div class="col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    PHI Filtering Status
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>PHI Filtered Docs</span>
                        <span class="badge bg-success">{{ stats.overview.phi_filtered_documents if stats else 0 }}</span>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Filtering Rate</span>
                        <span class="badge bg-info">
                            {{ ((stats.overview.phi_filtered_documents / stats.overview.total_documents * 100)|round(1) if stats and stats.overview.total_documents > 0 else 0) }}%
                        </span>
                    </div>
                    <div class="progress mt-1" style="height: 6px;">
                        <div class="progress-bar bg-info" 
                             style="width: {{ ((stats.overview.phi_filtered_documents / stats.overview.total_documents * 100) if stats and stats.overview.total_documents > 0 else 0) }}%"></div>
                    </div>
                </div>
                
                <div class="alert alert-success small mb-0">
                    <i class="fas fa-check-circle me-2"></i>
                    HIPAA compliance active
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Processing Activity -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Recent Processing Activity
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="showProcessingQueue()">
                        <i class="fas fa-clock me-1"></i>
                        Queue
                    </button>
                    <button class="btn btn-outline-warning" onclick="showLowConfidenceDocs()">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Low Confidence
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="activityContent">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Loading recent activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Confidence Distribution Chart
const confidenceCtx = document.getElementById('confidenceChart').getContext('2d');
const confidenceChart = new Chart(confidenceCtx, {
    type: 'doughnut',
    data: {
        labels: ['Excellent (80-100%)', 'Good (60-80%)', 'Fair (40-60%)', 'Poor (0-40%)'],
        datasets: [{
            data: [
                {{ stats.quality_distribution.excellent if stats else 0 }},
                {{ stats.quality_distribution.good if stats else 0 }},
                {{ stats.quality_distribution.fair if stats else 0 }},
                {{ stats.quality_distribution.poor if stats else 0 }}
            ],
            backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
            borderWidth: 2,
            borderColor: '#343a40'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    color: '#fff',
                    padding: 10
                }
            }
        }
    }
});

// Activity Chart
const activityCtx = document.getElementById('activityChart').getContext('2d');
const activityChart = new Chart(activityCtx, {
    type: 'bar',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Documents Processed',
            data: [42, 38, 51, 47, 53, 35, 28],
            backgroundColor: 'rgba(13, 110, 253, 0.7)',
            borderColor: '#0d6efd',
            borderWidth: 1
        }, {
            label: 'Queue Size',
            data: [8, 12, 6, 9, 4, 15, 18],
            backgroundColor: 'rgba(255, 193, 7, 0.7)',
            borderColor: '#ffc107',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: '#fff'
                }
            }
        },
        scales: {
            x: {
                ticks: { color: '#fff' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
            },
            y: {
                ticks: { color: '#fff' },
                grid: { color: 'rgba(255, 255, 255, 0.1)' }
            }
        }
    }
});

// Functions
function refreshOCRStats() {
    showLoadingToast('Refreshing OCR statistics...');
    
    fetch('/admin/api/ocr-stats', {
        method: 'GET',
        headers: {
            'X-CSRFToken': window.csrf_token
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateOCRDashboard(data.stats);
            showToast('OCR statistics refreshed successfully', 'success');
        } else {
            showToast('Error refreshing stats: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showToast('Network error occurred', 'error');
        console.error('Error:', error);
    });
}

function updateOCRDashboard(stats) {
    // Update metric cards
    document.getElementById('totalDocs').textContent = stats.overview.total_documents;
    document.getElementById('processedDocs').textContent = stats.overview.processed_documents;
    document.getElementById('pendingDocs').textContent = stats.overview.pending_documents;
    document.getElementById('processingRate').textContent = stats.overview.processing_rate.toFixed(1) + '%';
    
    // Update charts
    confidenceChart.data.datasets[0].data = [
        stats.quality_distribution.excellent,
        stats.quality_distribution.good,
        stats.quality_distribution.fair,
        stats.quality_distribution.poor
    ];
    confidenceChart.update();
}

function showProcessingQueue() {
    const content = document.getElementById('activityContent');
    content.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading processing queue...</p>
        </div>
    `;
    
    // Simulate loading queue data
    setTimeout(() => {
        content.innerHTML = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Document</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Uploaded</th>
                            <th>Est. Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge bg-primary">1</span></td>
                            <td>patient_report_001.pdf</td>
                            <td>PDF</td>
                            <td>2.3 MB</td>
                            <td>2 min ago</td>
                            <td>1-2 min</td>
                        </tr>
                        <tr>
                            <td><span class="badge bg-primary">2</span></td>
                            <td>lab_results_scan.jpg</td>
                            <td>Image</td>
                            <td>1.8 MB</td>
                            <td>5 min ago</td>
                            <td>30-45 sec</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="text-center">
                <small class="text-muted">Showing next 2 documents in queue</small>
            </div>
        `;
    }, 1000);
}

function showLowConfidenceDocs() {
    const content = document.getElementById('activityContent');
    content.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading low confidence documents...</p>
        </div>
    `;
    
    // Simulate loading low confidence docs
    setTimeout(() => {
        content.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Documents requiring review:</strong> Documents with confidence below 60% may need manual verification.
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Document</th>
                            <th>Patient</th>
                            <th>Confidence</th>
                            <th>Processed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>unclear_scan_001.pdf</td>
                            <td>John Doe</td>
                            <td><span class="badge bg-danger">45%</span></td>
                            <td>1 hour ago</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary">Review</button>
                                <button class="btn btn-sm btn-outline-warning">Reprocess</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;
    }, 1000);
}

// Auto-refresh every 30 seconds
setInterval(refreshOCRStats, 30 * 1000);

// Load initial activity
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(showProcessingQueue, 1000);
});
</script>
{% endblock %}

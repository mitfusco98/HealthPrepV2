{% extends 'base_admin.html' %}

{% block title %}Admin Dashboard - HealthPrep{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>
            <i class="fas fa-chart-line me-2"></i>
            Admin Dashboard
        </h2>
        <p class="text-muted mb-0">Centralized admin control panel</p>
    </div>
    <div>
        <span class="badge bg-success fs-6">
            <i class="fas fa-shield-alt me-1"></i>
            System Healthy
        </span>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="card">
    <div class="card-header p-0">
        <nav>
            <div class="nav nav-tabs d-flex" id="nav-tab" role="tablist" style="white-space: nowrap;">
                <a class="nav-link flex-fill text-center small {{ 'active' if active_tab == 'activity' else '' }}" href="{{ url_for('admin.dashboard_logs') }}" style="min-width: 0; padding: 0.5rem 0.25rem;">
                    <i class="fas fa-history me-1"></i>
                    <span class="d-none d-md-inline">Activity Logs</span>
                    <span class="d-md-none">Activity</span>
                </a>
                <a class="nav-link flex-fill text-center small {{ 'active' if active_tab == 'users' else '' }}" href="{{ url_for('admin.dashboard_users') }}" style="min-width: 0; padding: 0.5rem 0.25rem;">
                    <i class="fas fa-users me-1"></i>
                    <span class="d-none d-md-inline">User Management</span>
                    <span class="d-md-none">Users</span>
                </a>
                <a class="nav-link flex-fill text-center small {{ 'active' if active_tab == 'presets' else '' }}" href="{{ url_for('admin.dashboard_presets') }}" style="min-width: 0; padding: 0.5rem 0.25rem;">
                    <i class="fas fa-cogs me-1"></i>
                    <span class="d-none d-md-inline">Preset Management</span>
                    <span class="d-md-none">Presets</span>
                </a>
                <a class="nav-link flex-fill text-center small {{ 'active' if active_tab == 'phi' else '' }}" href="{{ url_for('admin.dashboard_phi') }}" style="min-width: 0; padding: 0.5rem 0.25rem;">
                    <i class="fas fa-user-shield me-1"></i>
                    <span class="d-none d-md-inline">PHI Statistics</span>
                    <span class="d-md-none">PHI</span>
                </a>
                <a class="nav-link flex-fill text-center small {{ 'active' if active_tab == 'analytics' else '' }}" href="{{ url_for('admin.dashboard_analytics') }}" style="min-width: 0; padding: 0.5rem 0.25rem;">
                    <i class="fas fa-chart-bar me-1"></i>
                    <span class="d-none d-md-inline">Customer Analytics</span>
                    <span class="d-md-none">Analytics</span>
                </a>
            </div>
        </nav>
    </div>
    <div class="card-body">
        <div class="tab-content" id="nav-tabContent">

            <!-- Activity Logs Tab -->
            <div class="tab-pane fade {{ 'show active' if active_tab == 'activity' else '' }}" id="nav-activity" role="tabpanel" aria-labelledby="nav-activity-tab">
                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                Recent Admin Activity
                            </h5>
                            <a href="{{ url_for('admin.logs') }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-external-link-alt me-1"></i>
                                View All Logs
                            </a>
                        </div>
                        {% if recent_logs %}
                        <div class="table-responsive">
                            <table id="activityTable" class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Event</th>
                                        <th>User</th>
                                        <th>Time</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in recent_logs %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary">{{ log.event_type.replace('_', ' ').title() if log.event_type else 'Unknown' }}</span>
                                        </td>
                                        <td>{{ log.user.username if log.user else 'System' }}</td>
                                        <td>{{ log.timestamp.strftime('%m/%d %H:%M') }}</td>
                                        <td>
                                            <small class="text-muted">{{ log.data.get('description', '') if log.data else '' }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Recent Activity</h5>
                            <p class="text-muted">Admin actions will appear here</p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-lg-4">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-filter me-2"></i>
                                    Activity Filters
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label small">Quick Filter</label>
                                    <input type="text" id="activitySearch" class="form-control form-control-sm" placeholder="Search activity...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">Event Type</label>
                                    <select id="eventTypeFilter" class="form-select form-select-sm">
                                        <option value="">All Events</option>
                                        <option value="user_management">User Management</option>
                                        <option value="settings_change">Settings Changes</option>
                                        <option value="system_event">System Events</option>
                                    </select>
                                </div>
                                <div class="d-grid gap-2">
                                    <button id="clearFilters" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i>
                                        Clear Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Tab -->
            <div class="tab-pane fade {{ 'show active' if active_tab == 'users' else '' }}" id="nav-users" role="tabpanel" aria-labelledby="nav-users-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>
                        User Management
                    </h5>
                    <div>
                        <a href="{{ url_for('admin.users') }}" class="btn btn-sm btn-outline-primary me-2">
                            <i class="fas fa-external-link-alt me-1"></i>
                            Manage All Users
                        </a>
                        <button class="btn btn-sm btn-primary">
                            <i class="fas fa-plus me-1"></i>
                            Add User
                        </button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Last Login</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center py-4">
                                            <i class="fas fa-users fa-2x text-muted mb-2"></i>
                                            <p class="text-muted mb-0">User data will be loaded here</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>
                                    User Statistics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Total Users</span>
                                        <span class="badge bg-primary">{{ total_users or 0 }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Active Users</span>
                                        <span class="badge bg-success">{{ active_users or 0 }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Admin Users</span>
                                        <span class="badge bg-warning">{{ admin_users or 0 }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Inactive Users</span>
                                        <span class="badge bg-secondary">{{ inactive_users or 0 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preset Management Tab -->
            <div class="tab-pane fade {{ 'show active' if active_tab == 'presets' else '' }}" id="nav-presets" role="tabpanel" aria-labelledby="nav-presets-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        System Presets & Settings
                    </h5>
                    <button class="btn btn-sm btn-primary">
                        <i class="fas fa-plus me-1"></i>
                        Create Preset
                    </button>
                </div>
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    Screening Presets
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                        <div>
                                            <strong>Standard Physical</strong>
                                            <small class="text-muted d-block">Basic health screening preset</small>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary me-1">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                        <div>
                                            <strong>Cardiac Screening</strong>
                                            <small class="text-muted d-block">Heart health focused preset</small>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary me-1">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-sliders-h me-2"></i>
                                    System Settings
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="list-group list-group-flush">
                                    <a href="{{ url_for('admin.phi_settings') }}" class="list-group-item list-group-item-action">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-user-shield me-2"></i>
                                                PHI Filter Settings
                                            </div>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </a>
                                    <div class="list-group-item list-group-item-action">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-file-alt me-2"></i>
                                                Prep Sheet Settings
                                            </div>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                    <div class="list-group-item list-group-item-action">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="fas fa-eye me-2"></i>
                                                OCR Configuration
                                            </div>
                                            <i class="fas fa-chevron-right"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- PHI Statistics Tab -->
            <div class="tab-pane fade {{ 'show active' if active_tab == 'phi' else '' }}" id="nav-phi" role="tabpanel" aria-labelledby="nav-phi-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">
                        <i class="fas fa-user-shield me-2"></i>
                        PHI Redaction Statistics & Controls
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active">Today</button>
                        <button class="btn btn-outline-secondary">Week</button>
                        <button class="btn btn-outline-secondary">Month</button>
                    </div>
                </div>
                
                <!-- PHI Control Switch -->
                <div class="alert alert-info mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="phiEnabled" 
                                       {{ 'checked' if phi_settings and phi_settings.enabled else '' }}>
                                <label class="form-check-label fw-bold" for="phiEnabled">
                                    <i class="fas fa-power-off me-2"></i>
                                    Enable PHI Redaction
                                </label>
                            </div>
                            <small class="text-muted">Automatically redact PHI from OCR text for HIPAA compliance</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge {{ 'bg-success' if phi_settings and phi_settings.enabled else 'bg-danger' }} fs-6">
                                <i class="fas fa-shield-alt me-1"></i>
                                {{ 'PROTECTED' if phi_settings and phi_settings.enabled else 'UNPROTECTED' }}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-file-medical fa-2x text-info mb-3"></i>
                                <h4 class="mb-1">{{ phi_stats.documents_processed if phi_stats else '0' }}</h4>
                                <p class="text-muted mb-0">Documents Processed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-shield-alt fa-2x text-success mb-3"></i>
                                <h4 class="mb-1">{{ phi_stats.phi_items_redacted if phi_stats else '0' }}</h4>
                                <p class="text-muted mb-0">PHI Items Redacted</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-percentage fa-2x text-warning mb-3"></i>
                                <h4 class="mb-1">{{ phi_stats.detection_accuracy if phi_stats else '0.0' }}%</h4>
                                <p class="text-muted mb-0">Detection Accuracy</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-clock fa-2x text-danger mb-3"></i>
                                <h4 class="mb-1">{{ phi_stats.avg_processing_time if phi_stats else '0.0' }}s</h4>
                                <p class="text-muted mb-0">Avg Processing Time</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    PHI Detection Trends
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center py-5">
                                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">PHI Statistics Chart</h5>
                                    <p class="text-muted">Interactive chart showing PHI detection patterns over time</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    Detection Breakdown
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Social Security Numbers</span>
                                        <span class="badge bg-primary">{{ phi_breakdown.ssn_count if phi_breakdown else '0' }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Phone Numbers</span>
                                        <span class="badge bg-success">{{ phi_breakdown.phone_count if phi_breakdown else '0' }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Email Addresses</span>
                                        <span class="badge bg-info">{{ phi_breakdown.email_count if phi_breakdown else '0' }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Medical Record Numbers</span>
                                        <span class="badge bg-warning">{{ phi_breakdown.mrn_count if phi_breakdown else '0' }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Names</span>
                                        <span class="badge bg-secondary">{{ phi_breakdown.name_count if phi_breakdown else '0' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- HIPAA Compliance Card -->
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-balance-scale me-2"></i>
                                    HIPAA Compliance Status
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if phi_settings and phi_settings.enabled %}
                                <div class="alert alert-success small mb-3">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Compliant Configuration</strong><br>
                                    PHI redaction is active and meets HIPAA requirements.
                                </div>
                                {% else %}
                                <div class="alert alert-warning small mb-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Compliance Warning</strong><br>
                                    PHI redaction is disabled. This may compromise HIPAA compliance.
                                </div>
                                {% endif %}
                                
                                <div class="small">
                                    <strong>Last Updated:</strong><br>
                                    {{ phi_settings.updated_at.strftime('%m/%d/%Y %H:%M') if phi_settings and phi_settings.updated_at else 'Never' }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>
                                    Quick Actions
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="testPHIFilter()">
                                        <i class="fas fa-vial me-1"></i>
                                        Test PHI Filter
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewFilteredDocuments()">
                                        <i class="fas fa-eye me-1"></i>
                                        View Filtered Documents
                                    </button>
                                    <a href="{{ url_for('admin.export_logs', event_type='phi_filter') }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-download me-1"></i>
                                        Export PHI Logs
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Customer Analytics Tab -->
            <div class="tab-pane fade {{ 'show active' if active_tab == 'analytics' else '' }}" id="nav-analytics" role="tabpanel" aria-labelledby="nav-analytics-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Customer Value Analytics
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active">Monthly</button>
                        <button class="btn btn-outline-secondary">Quarterly</button>
                        <button class="btn btn-outline-secondary">Yearly</button>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-dollar-sign fa-2x text-success mb-3"></i>
                                <h4 class="mb-1">$24,890</h4>
                                <p class="text-muted mb-0">Monthly Revenue</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-users fa-2x text-primary mb-3"></i>
                                <h4 class="mb-1">127</h4>
                                <p class="text-muted mb-0">Active Customers</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-chart-line fa-2x text-info mb-3"></i>
                                <h4 class="mb-1">18%</h4>
                                <p class="text-muted mb-0">Growth Rate</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-star fa-2x text-warning mb-3"></i>
                                <h4 class="mb-1">4.8</h4>
                                <p class="text-muted mb-0">Customer Satisfaction</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-area me-2"></i>
                                    Revenue & Usage Trends
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center py-5">
                                    <i class="fas fa-chart-area fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">Customer Analytics Dashboard</h5>
                                    <p class="text-muted">Interactive charts showing customer value metrics and trends</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-trophy me-2"></i>
                                    Top Customers
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center py-4">
                                    <i class="fas fa-crown fa-2x text-warning mb-2"></i>
                                    <p class="text-muted mb-0">Top customer rankings will appear here</p>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-bell me-2"></i>
                                    Value Alerts
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="text-center py-4">
                                    <i class="fas fa-bell fa-2x text-info mb-2"></i>
                                    <p class="text-muted mb-0">Customer value alerts and notifications</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize Bootstrap tabs
document.addEventListener('DOMContentLoaded', function() {
    // Enable Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Tab switching with URL hash support
document.addEventListener('DOMContentLoaded', function() {
    // Remove old tab-based navigation since we're using proper routes
    console.log('Dashboard loaded with route-based navigation');
});

// Filter functionality for activity logs
function applyActivityFilters() {
    // Placeholder for filter logic
    console.log('Applying activity filters...');
}

// Quick actions
function refreshAllData() {
    showRealTimeIndicator('Refreshing dashboard data...');
    // Implement refresh logic
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function exportLogs() {
    showRealTimeIndicator('Preparing log export...');
    // Implement export logic
    window.location.href = '/admin/logs/export';
}

// Real-time updates indicator
function showRealTimeIndicator(message) {
    const indicator = document.createElement('div');
    indicator.className = 'position-fixed top-50 end-0 translate-middle-y bg-info text-white p-3 rounded-start shadow';
    indicator.innerHTML = `<i class="fas fa-sync fa-spin me-2"></i>${message}`;
    document.body.appendChild(indicator);
    
    setTimeout(() => {
        indicator.remove();
    }, 3000);
}

// Tab content loading (for dynamic content)
function loadTabContent(tabName) {
    switch(tabName) {
        case 'users':
            loadUserManagementData();
            break;
        case 'presets':
            loadPresetManagementData();
            break;
        case 'phi':
            loadPHIStatistics();
            break;
        case 'analytics':
            loadCustomerAnalytics();
            break;
    }
}

// Placeholder functions for dynamic loading
function loadUserManagementData() {
    console.log('Loading user management data...');
}

function loadPresetManagementData() {
    console.log('Loading preset management data...');
}

function loadPHIStatistics() {
    console.log('Loading PHI statistics...');
}

function loadCustomerAnalytics() {
    console.log('Loading customer analytics...');
}

// PHI Settings Toggle
document.getElementById('phiEnabled').addEventListener('change', function() {
    const enabled = this.checked;
    
    // Show confirmation for disabling PHI
    if (!enabled) {
        if (!confirm('Warning: Disabling PHI redaction may compromise HIPAA compliance. Are you sure?')) {
            this.checked = true;
            return;
        }
    }
    
    // Update button state
    const statusBadge = document.querySelector('.badge');
    const originalHtml = statusBadge.innerHTML;
    statusBadge.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>UPDATING...';
    
    // Send API request
    fetch('/admin/api/update-phi-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ enabled: enabled })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update status badge
            statusBadge.className = enabled ? 'badge bg-success fs-6' : 'badge bg-danger fs-6';
            statusBadge.innerHTML = '<i class="fas fa-shield-alt me-1"></i>' + 
                                  (enabled ? 'PROTECTED' : 'UNPROTECTED');
            
            // Show success message
            showToast(data.message, 'success');
            
            // Refresh PHI statistics
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            // Revert toggle and show error
            this.checked = !enabled;
            statusBadge.innerHTML = originalHtml;
            showToast('Error updating PHI settings: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        // Revert toggle and show error
        this.checked = !enabled;
        statusBadge.innerHTML = originalHtml;
        showToast('Network error updating PHI settings', 'danger');
        console.error('PHI settings update error:', error);
    });
});

// PHI Quick Actions
function testPHIFilter() {
    showToast('PHI filter test coming soon', 'info');
}

function viewFilteredDocuments() {
    showToast('Filtered documents view coming soon', 'info');
}

// Toast notification helper
function showToast(message, type = 'info') {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // Add toast to container
    const toastElement = document.createElement('div');
    toastElement.innerHTML = toastHtml;
    toastContainer.appendChild(toastElement.firstElementChild);
    
    // Initialize and show toast
    const toast = new bootstrap.Toast(toastContainer.lastElementChild);
    toast.show();
    
    // Remove toast element after it's hidden
    toastContainer.lastElementChild.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}
</script>

<!-- DataTables JavaScript -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
// Initialize DataTables for activity logs
$(document).ready(function() {
    if ($('#activityTable').length) {
        var table = $('#activityTable').DataTable({
            pageLength: 10,
            lengthChange: false,
            info: false,
            searching: true,
            paging: false,
            order: [[2, 'desc']], // Sort by time column descending
            columnDefs: [
                { orderable: false, targets: [3] } // Disable sorting on details column
            ],
            language: {
                search: "",
                searchPlaceholder: "Search activity..."
            }
        });

        // Custom search functionality
        $('#activitySearch').on('keyup', function() {
            table.search(this.value).draw();
        });

        // Event type filter
        $('#eventTypeFilter').on('change', function() {
            var filterValue = this.value;
            if (filterValue) {
                table.column(0).search(filterValue, true, false).draw();
            } else {
                table.column(0).search('').draw();
            }
        });

        // Clear filters
        $('#clearFilters').on('click', function() {
            $('#activitySearch').val('');
            $('#eventTypeFilter').val('');
            table.search('').columns().search('').draw();
        });
    }
});
</script>
{% endblock %}

{% extends 'base_admin.html' %}

{% block title %}Admin Dashboard - HealthPrep{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<!-- Chart.js CSS -->
<style>
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}
.chart-small {
    height: 200px;
}
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>
            <i class="fas fa-chart-line me-2"></i>
            Admin Dashboard
        </h2>
        <p class="text-muted mb-0">Centralized admin control panel</p>
    </div>
    <div>
        <span class="badge bg-success fs-6">
            <i class="fas fa-shield-alt me-1"></i>
            System Healthy
        </span>
    </div>
</div>

<!-- Navigation Tabs -->
<div class="card">
    <div class="card-header p-0">
        <nav>
            <div class="nav nav-tabs d-flex" id="nav-tab" role="tablist" style="white-space: nowrap;">
                <a class="nav-link flex-fill text-center small {{ 'active' if active_tab == 'activity' else '' }}" href="{{ url_for('admin.dashboard_logs') }}" style="min-width: 0; padding: 0.5rem 0.25rem;">
                    <i class="fas fa-history me-1"></i>
                    <span class="d-none d-md-inline">Activity Logs</span>
                    <span class="d-md-none">Activity</span>
                </a>
                <a class="nav-link flex-fill text-center small {{ 'active' if active_tab == 'users' else '' }}" href="{{ url_for('admin.dashboard_users') }}" style="min-width: 0; padding: 0.5rem 0.25rem;">
                    <i class="fas fa-users me-1"></i>
                    <span class="d-none d-md-inline">User Management</span>
                    <span class="d-md-none">Users</span>
                </a>
                <a class="nav-link flex-fill text-center small {{ 'active' if active_tab == 'presets' else '' }}" href="{{ url_for('admin.dashboard_presets') }}" style="min-width: 0; padding: 0.5rem 0.25rem;">
                    <i class="fas fa-cogs me-1"></i>
                    <span class="d-none d-md-inline">Preset Management</span>
                    <span class="d-md-none">Presets</span>
                </a>
                <a class="nav-link flex-fill text-center small {{ 'active' if active_tab == 'phi' else '' }}" href="{{ url_for('admin.dashboard_phi') }}" style="min-width: 0; padding: 0.5rem 0.25rem;">
                    <i class="fas fa-user-shield me-1"></i>
                    <span class="d-none d-md-inline">PHI Statistics</span>
                    <span class="d-md-none">PHI</span>
                </a>
                <a class="nav-link flex-fill text-center small {{ 'active' if active_tab == 'analytics' else '' }}" href="{{ url_for('admin.dashboard_analytics') }}" style="min-width: 0; padding: 0.5rem 0.25rem;">
                    <i class="fas fa-chart-bar me-1"></i>
                    <span class="d-none d-md-inline">Customer Analytics</span>
                    <span class="d-md-none">Analytics</span>
                </a>
            </div>
        </nav>
    </div>
    <div class="card-body">
        <div class="tab-content" id="nav-tabContent">

            <!-- Activity Logs Tab -->
            <div class="tab-pane fade {{ 'show active' if active_tab == 'activity' else '' }}" id="nav-activity" role="tabpanel" aria-labelledby="nav-activity-tab">
                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                Recent Admin Activity
                            </h5>
                            <a href="{{ url_for('admin.logs') }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-external-link-alt me-1"></i>
                                View All Logs
                            </a>
                        </div>
                        {% if recent_logs %}
                        <div class="table-responsive">
                            <table id="activityTable" class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Event</th>
                                        <th>User</th>
                                        <th>Time</th>
                                        <th>Details</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in recent_logs %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-primary">{{ log.event_type.replace('_', ' ').title() if log.event_type else 'Unknown' }}</span>
                                        </td>
                                        <td>{{ log.user.username if log.user else 'System' }}</td>
                                        <td>{{ log.timestamp.strftime('%m/%d/%H:%M') }}</td>
                                        <td>
                                            <small class="text-muted">{{ log.data.get('description', '') if log.data else '' }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Recent Activity</h5>
                            <p class="text-muted">Admin actions will appear here</p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-filter me-2"></i>
                                    Activity Filters
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label small">Quick Filter</label>
                                    <input type="text" id="activitySearch" class="form-control form-control-sm" placeholder="Search activity...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small">Event Type</label>
                                    <select id="eventTypeFilter" class="form-select form-select-sm">
                                        <option value="">All Events</option>
                                        <option value="user_management">User Management</option>
                                        <option value="settings_change">Settings Changes</option>
                                        <option value="system_event">System Events</option>
                                    </select>
                                </div>
                                <div class="d-grid gap-2">
                                    <button id="clearFilters" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i>
                                        Clear Filters
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Management Tab -->
            <div class="tab-pane fade {{ 'show active' if active_tab == 'users' else '' }}" id="nav-users" role="tabpanel" aria-labelledby="nav-users-tab">
                <div class="row g-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-users me-2"></i>
                                    User Management
                                </h5>
                                <a href="{{ url_for('admin.users') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-cog me-1"></i>
                                    Manage Users
                                </a>
                            </div>
                            <div class="card-body">
                                {% if users %}
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Email</th>
                                                    <th>Role</th>
                                                    <th>Status</th>
                                                    <th>Last Login</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for user in users[:10] %}
                                                <tr>
                                                    <td>
                                                        <strong>{{ user.username }}</strong>
                                                        {% if user.id == current_user.id %}
                                                            <span class="badge bg-info ms-1">You</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ user.email }}</td>
                                                    <td>
                                                        <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'primary' if user.role == 'MA' else 'secondary' }}">
                                                            {{ user.role_display }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-{{ 'success' if user.is_active_user else 'danger' }}">
                                                            {{ 'Active' if user.is_active_user else 'Inactive' }}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">
                                                            {{ user.last_login.strftime('%m/%d/%Y') if user.last_login else 'Never' }}
                                                        </small>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                                {% if users|length > 10 %}
                                                <tr>
                                                    <td colspan="5" class="text-center py-2">
                                                        <a href="{{ url_for('admin.users') }}" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-users me-1"></i>
                                                            View All {{ users|length }} Users
                                                        </a>
                                                    </td>
                                                </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <div class="text-center py-4">
                                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No users found</h5>
                                        <p class="text-muted mb-0">No users found</p>
                                        <a href="{{ url_for('admin.users') }}" class="btn btn-sm btn-outline-primary mt-2">
                                            <i class="fas fa-cog me-1"></i>
                                            Manage Users
                                        </a>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Preset Management Tab -->
            <div class="tab-pane fade {{ 'show active' if active_tab == 'presets' else '' }}" id="nav-presets" role="tabpanel" aria-labelledby="nav-presets-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Screening Preset Management
                    </h5>
                    <div>
                        <!-- Buttons removed for streamlined interface -->
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    Screening Presets
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="presetsContainer">
                                    {% if recent_presets %}
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Specialty</th>
                                                    <th>Screenings</th>
                                                    <th>Shared</th>
                                                    <th>Created</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for preset in recent_presets %}
                                                <tr data-preset-id="{{ preset.id }}">
                                                    <td>
                                                        <strong>{{ preset.name }}</strong>
                                                        {% if preset.description %}
                                                        <small class="text-muted d-block">{{ preset.description[:50] }}{{ '...' if preset.description|length > 50 else '' }}</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-info">{{ preset.specialty_display }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-primary">{{ preset.screening_count }}</span>
                                                    </td>
                                                    <td>
                                                        {% if preset.shared %}
                                                            <span class="badge bg-success">Global</span>
                                                        {% elif preset.is_pending_approval() %}
                                                            <span class="badge bg-warning">Pending Approval</span>
                                                        {% else %}
                                                            <span class="badge bg-secondary">Organization</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <small class="text-muted">
                                                            {{ preset.created_at.strftime('%m/%d/%Y') if preset.created_at else 'N/A' }}
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <!-- Apply to Organization -->
                                                            <button class="btn btn-outline-success" onclick="applyPreset({{ preset.id }}, '{{ preset.name|e }}')" title="Apply to Organization">
                                                                <i class="fas fa-play"></i> Apply
                                                            </button>

                                                            <!-- View Preset Details -->
                                                            <button class="btn btn-outline-info" onclick="viewPresetDetails({{ preset.id }}, '{{ preset.name }}')" title="View Preset Details">
                                                                <i class="fas fa-eye"></i> View
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No Presets Created</h5>
                                        <p class="text-muted">Create your first screening preset to get started.</p>
                                        <div class="mt-3">
                                            <a href="{{ url_for('admin.create_preset_from_types') }}" class="btn btn-success">
                                                <i class="fas fa-magic me-1"></i>
                                                Create from Existing Types
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>
                                    Preset Statistics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Total Presets</span>
                                        <span class="badge bg-primary">{{ total_presets or 0 }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Shared Presets</span>
                                        <span class="badge bg-success">{{ shared_presets or 0 }}</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="mb-3">
                                    <small class="text-muted">
                                        <strong>Quick Actions:</strong>
                                    </small>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-info" onclick="loadAllPresets()">
                                        <i class="fas fa-refresh me-1"></i>
                                        Refresh List
                                    </button>
                                    <a href="{{ url_for('admin.view_presets') }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-external-link-alt me-1"></i>
                                        View All Presets
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    About Presets
                                </h6>
                            </div>
                            <div class="card-body">
                                <small class="text-muted">
                                    <p>Screening presets allow you to:</p>
                                    <ul class="mb-0">
                                        <li>Store reusable screening configurations</li>
                                        <li>Import/export screening templates</li>
                                        <li>Share configurations across systems</li>
                                        <li>Quickly deploy standard screening sets</li>
                                    </ul>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PHI Statistics Tab -->
            <div class="tab-pane fade {{ 'show active' if active_tab == 'phi' else '' }}" id="nav-phi" role="tabpanel" aria-labelledby="nav-phi-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">
                        <i class="fas fa-user-shield me-2"></i>
                        PHI Redaction Statistics & Controls
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active">Today</button>
                        <button class="btn btn-outline-secondary">Week</button>
                        <button class="btn btn-outline-secondary">Month</button>
                    </div>
                </div>

                <!-- PHI Control Switch -->
                <div class="alert alert-info mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="phiEnabled" 
                                       {{ 'checked' if phi_settings and phi_settings.enabled else '' }}>
                                <label class="form-check-label fw-bold" for="phiEnabled">
                                    <i class="fas fa-power-off me-2"></i>
                                    Enable PHI Redaction
                                </label>
                            </div>
                            <small class="text-muted">Automatically redact PHI from OCR text for HIPAA compliance</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge {{ 'bg-success' if phi_settings and phi_settings.enabled else 'bg-danger' }} fs-6">
                                <i class="fas fa-shield-alt me-1"></i>
                                {{ 'PROTECTED' if phi_settings and phi_settings.enabled else 'UNPROTECTED' }}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-file-medical fa-2x text-info mb-3"></i>
                                <h4 class="mb-1">{{ phi_stats.documents_processed if phi_stats else '0' }}</h4>
                                <p class="text-muted mb-0">Documents Processed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-shield-alt fa-2x text-success mb-3"></i>
                                <h4 class="mb-1">{{ phi_stats.phi_items_redacted if phi_stats else '0' }}</h4>
                                <p class="text-muted mb-0">PHI Items Redacted</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-percentage fa-2x text-warning mb-3"></i>
                                <h4 class="mb-1">{{ phi_stats.detection_accuracy if phi_stats else '0.0' }}%</h4>
                                <p class="text-muted mb-0">Detection Accuracy</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-4">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-clock fa-2x text-danger mb-3"></i>
                                <h4 class="mb-1">{{ phi_stats.avg_processing_time if phi_stats else '0.0' }}s</h4>
                                <p class="text-muted mb-0">Avg Processing Time</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    PHI Detection Trends
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="phiTrendsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    Detection Breakdown
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Social Security Numbers</span>
                                        <span class="badge bg-primary">{{ phi_breakdown.ssn_count if phi_breakdown else '0' }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Phone Numbers</span>
                                        <span class="badge bg-success">{{ phi_breakdown.phone_count if phi_breakdown else '0' }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Email Addresses</span>
                                        <span class="badge bg-info">{{ phi_breakdown.email_count if phi_breakdown else '0' }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Medical Record Numbers</span>
                                        <span class="badge bg-warning">{{ phi_breakdown.mrn_count if phi_breakdown else '0' }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span>Names</span>
                                        <span class="badge bg-secondary">{{ phi_breakdown.name_count if phi_breakdown else '0' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Charts Row -->
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>
                                    PHI Type Distribution
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container chart-small">
                                    <canvas id="phiTypeChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Processing Efficiency
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container chart-small">
                                    <canvas id="efficiencyChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HIPAA Compliance Card -->
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-balance-scale me-2"></i>
                                    HIPAA Compliance Status
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if phi_settings and phi_settings.enabled %}
                                <div class="alert alert-success small mb-3">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Compliant Configuration</strong><br>
                                    PHI redaction is active and meets HIPAA requirements.
                                </div>
                                {% else %}
                                <div class="alert alert-warning small mb-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Compliance Warning</strong><br>
                                    PHI redaction is disabled. This may compromise HIPAA compliance.
                                </div>
                                {% endif %}

                                <div class="small">
                                    <strong>Last Updated:</strong><br>
                                    {{ phi_settings.updated_at.strftime('%m/%d/%Y %H:%M') if phi_settings and phi_settings.updated_at else 'Never' }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>
                                    Quick Actions
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="testPHIFilter()">
                                        <i class="fas fa-vial me-1"></i>
                                        Test PHI Filter
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewFilteredDocuments()">
                                        <i class="fas fa-eye me-1"></i>
                                        View Filtered Documents
                                    </button>
                                    <a href="{{ url_for('admin.export_logs', event_type='phi_filter') }}" class="btn btn-sm btn-outline-secondary">
                                        <i class="fas fa-download me-1"></i>
                                        Export PHI Logs
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Analytics Tab -->
            <div class="tab-pane fade {{ 'show active' if active_tab == 'analytics' else '' }}" id="nav-analytics" role="tabpanel" aria-labelledby="nav-analytics-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Customer Value Analytics
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active" data-period="monthly">Monthly</button>
                        <button class="btn btn-outline-secondary" data-period="quarterly">Quarterly</button>
                        <button class="btn btn-outline-secondary" data-period="yearly">Yearly</button>
                    </div>
                </div>
                <!-- Key Value Metrics -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <i class="fas fa-clock fa-2x text-success mb-3"></i>
                                <h4 class="mb-1">41.67</h4>
                                <p class="text-muted mb-0">Hours Saved</p>
                                <small class="text-success">≈ 1 Full Work Week</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-center border-primary">
                            <div class="card-body">
                                <i class="fas fa-dollar-sign fa-2x text-primary mb-3"></i>
                                <h4 class="mb-1">$1,042.50</h4>
                                <p class="text-muted mb-0">Labor Cost Avoided</p>
                                <small class="text-primary">Per 500 Patients</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <i class="fas fa-robot fa-2x text-info mb-3"></i>
                                <h4 class="mb-1">500</h4>
                                <p class="text-muted mb-0">Tasks Automated</p>
                                <small class="text-info">Prep Sheets Generated</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <i class="fas fa-shield-alt fa-2x text-warning mb-3"></i>
                                <h4 class="mb-1">87</h4>
                                <p class="text-muted mb-0">Gaps Closed</p>
                                <small class="text-warning">Compliance Issues</small>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Labor Savings Breakdown -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-calculator me-2"></i>
                                    Labor Savings Calculation Breakdown
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="border-end">
                                            <h5 class="text-primary">500</h5>
                                            <p class="small text-muted mb-0">Patients Prepped</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border-end">
                                            <h5 class="text-success">5 min</h5>
                                            <p class="small text-muted mb-0">Time per Patient</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="border-end">
                                            <h5 class="text-info">2,500 min</h5>
                                            <p class="small text-muted mb-0">Total Time Saved</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <h5 class="text-warning">$25/hr</h5>
                                        <p class="small text-muted mb-0">Average MA Wage</p>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <h4 class="text-success mb-1">500 patients × 5 minutes = 2,500 minutes saved</h4>
                                    <h4 class="text-primary mb-1">41.67 hours × $25/hr = $1,042.50 labor cost avoided</h4>
                                    <small class="text-muted">This represents what clinics currently spend on manual prep sheet labor per batch of 500 patients</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-area me-2"></i>
                                    Time & Cost Savings Trends
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="savingsTrendsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>
                                    Efficiency Breakdown
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container chart-small">
                                    <canvas id="efficiencyBreakdownChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-bullseye me-2"></i>
                                    ROI Metrics
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span class="small">Cost per Patient</span>
                                        <span class="badge bg-success">$2.09</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span class="small">Minutes Saved/Patient</span>
                                        <span class="badge bg-primary">5.0</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span class="small">Automation Rate</span>
                                        <span class="badge bg-info">100%</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between">
                                        <span class="small">Compliance Rate</span>
                                        <span class="badge bg-warning">97.4%</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <small class="text-muted">
                                        <strong>Break-even Point:</strong><br>
                                        50 patients per month
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Analytics Charts -->
                <div class="row mt-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Monthly Labor Savings
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container chart-small">
                                    <canvas id="monthlySavingsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Cumulative Value Impact
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container chart-small">
                                    <canvas id="cumulativeValueChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deletePresetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Warning:</strong> This action cannot be undone.</p>
                <p>Are you sure you want to delete preset <strong id="deletePresetName"></strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeletePreset()">
                    <i class="fas fa-trash me-1"></i>
                    Delete Preset
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Import to Types Modal -->
<div class="modal fade" id="importToTypesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Apply Preset: <span id="importToTypesPresetName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="applyPresetSummary"></div>
                <p>This will apply the preset to your organization's screening types. Are you sure you want to continue?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmImportToTypes">Apply Preset</button>
            </div>
        </div>
    </div>
</div>

<!-- Conflict Warning Modal -->
<div class="modal fade" id="conflictWarningModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Preset Application Conflicts
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>The preset "<span id="conflictPresetName"></span>" has conflicts with existing screening types:</p>
                <div id="conflictDetails"></div>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="forceOverwriteDashboard">
                    <label class="form-check-label" for="forceOverwriteDashboard">
                        <strong>Force overwrite existing screening types</strong>
                        <small class="text-muted d-block">This will replace existing screening types with preset data.</small>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmApplyDashboard">
                    <i class="fas fa-exclamation-triangle"></i> Apply Anyway
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Initialize Bootstrap tabs
document.addEventListener('DOMContentLoaded', function() {
    // Enable Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Tab switching with URL hash support
document.addEventListener('DOMContentLoaded', function() {
    // Remove old tab-based navigation since we're using proper routes
    console.log('Dashboard loaded with route-based navigation');
});

// Filter functionality for activity logs
function applyActivityFilters() {
    // Placeholder for filter logic
    console.log('Applying activity filters...');
}

// Missing JavaScript functions for dashboard presets
let currentPresetId = null;
let currentPresetName = null;

function importToTypes(presetId, presetName) {
    currentPresetId = presetId;
    currentPresetName = presetName;
    document.getElementById('importToTypesPresetName').textContent = presetName;

    // First check for conflicts
    fetch(`/admin/presets/${presetId}/check-conflicts`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(conflicts => {
            if (conflicts.error) {
                showToast(`Could not verify conflicts: ${conflicts.error}. Please try again or use the full presets page.`, 'warning');
                return;
            }

            if (conflicts.has_conflicts && conflicts.modified_types && conflicts.modified_types.length > 0) {
                // Show conflict warning modal instead
                showConflictWarning(conflicts);
            } else {
                // Show standard apply modal
                const modal = new bootstrap.Modal(document.getElementById('importToTypesModal'));
                modal.show();
            }
        })
        .catch(error => {
            console.error('Error checking conflicts:', error);
            showToast('Could not verify conflicts. Please try again or use the full presets page.', 'warning');
        });
}

// Function to handle the 'Apply Preset' action from the dashboard
function applyPreset(presetId, presetName) {
    currentPresetId = presetId;
    currentPresetName = presetName;

    // We need to check for conflicts before showing the modal for direct apply
    fetch(`/admin/presets/${presetId}/check-conflicts`)
        .then(response => response.json())
        .then(conflicts => {
            if (conflicts.has_conflicts && conflicts.modified_types && conflicts.modified_types.length > 0) {
                // Show conflict warning modal
                showConflictWarning(conflicts);
            } else {
                // If no conflicts, directly apply
                performApplyPreset(false); // No force overwrite needed if no conflicts
            }
        })
        .catch(error => {
            console.error('Error checking conflicts:', error);
            // If there's an error checking conflicts, we might want to default to showing the modal or handling it gracefully
            // For now, we'll assume no conflict and proceed, or show a generic error
            showToast('Could not verify conflicts. Please try again or use the full presets page.', 'danger');
        });
}


function showConflictWarning(conflicts) {
    const conflictDetails = document.getElementById('conflictDetails');
    if (conflictDetails) {
        let detailsHtml = '';

        if (conflicts.modified_types && conflicts.modified_types.length > 0) {
            detailsHtml += '<h6>Modified Screening Types (will be overwritten):</h6>';
            detailsHtml += '<ul class="list-unstyled">';
            conflicts.modified_types.forEach(type => {
                detailsHtml += `<li><i class="fas fa-exclamation-triangle text-warning"></i> <strong>${type.name}</strong> - Modified on ${type.modified_date}</li>`;
            });
            detailsHtml += '</ul>';
        }

        if (conflicts.missing_types && conflicts.missing_types.length > 0) {
            detailsHtml += '<h6 class="mt-3">Missing Screening Types (will be added):</h6>';
            detailsHtml += '<ul class="list-unstyled">';
            conflicts.missing_types.forEach(type => {
                detailsHtml += `<li><i class="fas fa-plus text-success"></i> <strong>${type.name}</strong> - Will be added</li>`;
            });
            detailsHtml += '</ul>';
        }

        conflictDetails.innerHTML = detailsHtml;
    }

    const modal = new bootstrap.Modal(document.getElementById('conflictWarningModal'));
    modal.show();
}

// Event listeners for dashboard apply functionality
document.addEventListener('DOMContentLoaded', function() {
    const confirmImportBtn = document.getElementById('confirmImportToTypes');
    const confirmApplyBtn = document.getElementById('confirmApplyDashboard');

    if (confirmImportBtn) {
        confirmImportBtn.addEventListener('click', function() {
            if (currentPresetId) {
                applyPresetDashboard(false); // This refers to the "Import to Types" flow
            }
        });
    }

    if (confirmApplyBtn) {
        confirmApplyBtn.addEventListener('click', function() {
            const forceOverwrite = document.getElementById('forceOverwriteDashboard').checked;
            applyPresetDashboard(forceOverwrite); // This refers to the direct "Apply Preset" flow
        });
    }
});

// This function is called from the "Apply" button in the presets table
function applyPresetDashboard(forceOverwrite = false) {
    if (!currentPresetId) return;

    const form = document.createElement('form');
    form.method = 'POST';
    // This URL applies the preset to the organization's screening types
    form.action = `/admin/presets/${currentPresetId}/apply-to-organization`; 

    // Add CSRF token - get from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
    }

    // Add force overwrite flag if requested
    if (forceOverwrite) {
        const overwriteInput = document.createElement('input');
        overwriteInput.type = 'hidden';
        overwriteInput.name = 'force_overwrite';
        overwriteInput.value = 'true';
        form.appendChild(overwriteInput);
    }

    document.body.appendChild(form);
    form.submit();
}

// Quick actions
function loadAllPresets() {
    showRealTimeIndicator('Loading all presets...');
    // Implement preset loading logic
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function viewPresetDetails(presetId, presetName) {
    showToast(`Viewing details for preset: ${presetName}`, 'info');
    // Redirect to the full presets page which shows detailed information
    window.location.href = '/admin/presets';
}

function refreshAllData() {
    showRealTimeIndicator('Refreshing dashboard data...');
    // Implement refresh logic
    setTimeout(() => {
        location.reload();
    }, 1000);
}

function exportLogs() {
    showRealTimeIndicator('Preparing log export...');
    // Implement export logic
    window.location.href = '/admin/logs/export';
}

// Real-time updates indicator
function showRealTimeIndicator(message) {
    const indicator = document.createElement('div');
    indicator.className = 'position-fixed top-50 end-0 translate-middle-y bg-info text-white p-3 rounded-start shadow';
    indicator.innerHTML = `<i class="fas fa-sync fa-spin me-2"></i>${message}`;
    document.body.appendChild(indicator);

    setTimeout(() => {
        indicator.remove();
    }, 3000);
}

// Tab content loading (for dynamic content)
function loadTabContent(tabName) {
    switch(tabName) {
        case 'users':
            loadUserManagementData();
            break;
        case 'presets':
            loadPresetManagementData();
            break;
        case 'phi':
            loadPHIStatistics();
            break;
        case 'analytics':
            loadCustomerAnalytics();
            break;
    }
}

// Placeholder functions for dynamic loading
function loadUserManagementData() {
    console.log('Loading user management data...');
}

function loadPresetManagementData() {
    console.log('Loading preset management data...');
}

function loadPHIStatistics() {
    console.log('Loading PHI statistics...');
}

function loadCustomerAnalytics() {
    console.log('Loading customer analytics...');
}

// PHI Settings Toggle
document.getElementById('phiEnabled').addEventListener('change', function() {
    const enabled = this.checked;

    // Show confirmation for disabling PHI
    if (!enabled) {
        if (!confirm('Warning: Disabling PHI redaction may compromise HIPAA compliance. Are you sure?')) {
            this.checked = true;
            return;
        }
    }

    // Update button state
    const statusBadge = document.querySelector('.badge');
    const originalHtml = statusBadge.innerHTML;
    statusBadge.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>UPDATING...';

    // Send API request
    fetch('/admin/api/update-phi-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
        },
        body: JSON.stringify({ enabled: enabled })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update status badge
            statusBadge.className = enabled ? 'badge bg-success fs-6' : 'badge bg-danger fs-6';
            statusBadge.innerHTML = '<i class="fas fa-shield-alt me-1"></i>' + 
                                  (enabled ? 'PROTECTED' : 'UNPROTECTED');

            // Show success message
            showToast(data.message, 'success');

            // Refresh PHI statistics
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            // Revert toggle and show error
            this.checked = !enabled;
            statusBadge.innerHTML = originalHtml;
            showToast('Error updating PHI settings: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        // Revert toggle and show error
        this.checked = !enabled;
        statusBadge.innerHTML = originalHtml;
        showToast('Network error updating PHI settings', 'danger');
        console.error('PHI settings update error:', error);
    });
});

// PHI Quick Actions
function testPHIFilter() {
    showToast('PHI filter test coming soon', 'info');
}

function viewFilteredDocuments() {
    showToast('Filtered documents view coming soon', 'info');
}

// Toast notification helper
function showToast(message, type = 'info') {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }

    // Add toast to container
    const toastElement = document.createElement('div');
    toastElement.innerHTML = toastHtml;
    toastContainer.appendChild(toastElement.firstElementChild);

    // Initialize and show toast
    const toast = new bootstrap.Toast(toastContainer.lastElementChild);
    toast.show();

    // Remove toast element after it's hidden
    toastContainer.lastElementChild.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}
</script>

<!-- DataTables JavaScript -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

<script>
// Initialize DataTables for activity logs
$(document).ready(function() {
    if ($('#activityTable').length) {
        var table = $('#activityTable').DataTable({
            pageLength: 10,
            lengthChange: false,
            info: false,
            searching: true,
            paging: false,
            order: [[2, 'desc']], // Sort by time column descending
            columnDefs: [
                { orderable: false, targets: [3] } // Disable sorting on details column
            ],
            language: {
                search: "",
                searchPlaceholder: "Search activity..."
            }
        });

        // Custom search functionality
        $('#activitySearch').on('keyup', function() {
            table.search(this.value).draw();
        });

        // Event type filter
        $('#eventTypeFilter').on('change', function() {
            var filterValue = this.value;
            if (filterValue) {
                table.column(0).search(filterValue, true, false).draw();
            } else {
                table.column(0).search('').draw();
            }
        });

        // Clear filters
        $('#clearFilters').on('click', function() {
            $('#activitySearch').val('');
            $('#eventTypeFilter').val('');
            table.search('').columns().search('').draw();
        });
    }
});
</script>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// PHI Statistics Charts Implementation
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize charts if we're on the PHI tab
    const phiTab = document.getElementById('nav-phi');
    if (!phiTab) return;

    // PHI Trends Chart (Line Chart)
    const trendsCtx = document.getElementById('phiTrendsChart');
    if (trendsCtx) {
        new Chart(trendsCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                datasets: [{
                    label: 'PHI Items Redacted',
                    data: [120, 189, 234, 167, 203, 289, 345],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Documents Processed',
                    data: [65, 87, 101, 79, 95, 134, 158],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'PHI Detection Trends Over Time'
                    },
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Count'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    }
                }
            }
        });
    }

    // PHI Type Distribution Chart (Doughnut Chart)
    const typeCtx = document.getElementById('phiTypeChart');
    if (typeCtx) {
        new Chart(typeCtx, {
            type: 'doughnut',
            data: {
                labels: ['SSN', 'Phone Numbers', 'Email Addresses', 'MRN', 'Names', 'Addresses'],
                datasets: [{
                    data: [{{ phi_breakdown.ssn_count if phi_breakdown else '234' }}, 
                           {{ phi_breakdown.phone_count if phi_breakdown else '187' }}, 
                           {{ phi_breakdown.email_count if phi_breakdown else '156' }}, 
                           {{ phi_breakdown.mrn_count if phi_breakdown else '145' }}, 
                           {{ phi_breakdown.name_count if phi_breakdown else '123' }}, 
                           89],
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB', 
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'PHI Types Detected'
                    },
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Processing Efficiency Chart (Bar Chart)
    const efficiencyCtx = document.getElementById('efficiencyChart');
    if (efficiencyCtx) {
        new Chart(efficiencyCtx, {
            type: 'bar',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Detection Accuracy (%)',
                    data: [95.2, 97.1, 96.8, 98.3],
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgb(54, 162, 235)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }, {
                    label: 'Avg Processing Time (s)',
                    data: [1.4, 1.2, 1.1, 0.9],
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 1,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Weekly Processing Performance'
                    },
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Accuracy (%)'
                        },
                        min: 90,
                        max: 100
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Time (seconds)'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        min: 0,
                        max: 2
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time Period'
                        }
                    }
                }
            }
        });
    }
});

// Time period filter functionality - only apply to dashboard PHI controls
document.querySelectorAll('#nav-overview .btn-group-sm .btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
        // Only handle this if it's within the overview tab (dashboard)
        if (!this.closest('#nav-overview')) {
            return;
        }

        // Prevent event bubbling to avoid conflicts with other modals
        e.stopPropagation();

        // Remove active class from all buttons in this group only
        this.closest('.btn-group-sm').querySelectorAll('.btn').forEach(b => {
            b.classList.remove('active');
        });

        // Add active class to clicked button
        this.classList.add('active');

        // Here you would typically refresh the charts with new data
        // For now, we'll just show a toast notification
        showToast(`Showing PHI statistics for: ${this.textContent}`, 'info');
    });
});

// PHI Control Switch handler
const phiEnabledSwitch = document.getElementById('phiEnabled');
if (phiEnabledSwitch) {
    phiEnabledSwitch.addEventListener('change', function() {
        const isEnabled = this.checked;
        const statusBadge = this.closest('.alert').querySelector('.badge');

        if (isEnabled) {
            statusBadge.className = 'badge bg-success fs-6';
            statusBadge.innerHTML = '<i class="fas fa-shield-alt me-1"></i>PROTECTED';
            showToast('PHI redaction enabled - HIPAA compliant', 'success');
        } else {
            statusBadge.className = 'badge bg-danger fs-6';
            statusBadge.innerHTML = '<i class="fas fa-shield-alt me-1"></i>UNPROTECTED';
            showToast('Warning: PHI redaction disabled', 'warning');
        }

        // Here you would typically make an API call to update the backend
        // updatePHISettings(isEnabled);
    });
}

// Quick action functions
function testPHIFilter() {
    showToast('PHI filter test initiated...', 'info');
    // Simulate test with mock results
    setTimeout(() => {
        showToast('PHI filter test completed: 98.5% accuracy', 'success');
    }, 2000);
}

function viewFilteredDocuments() {
    showToast('Loading filtered documents view...', 'info');
    // This would typically open a modal or redirect to a filtered documents page
}

// Placeholder function for updating PHI settings via API
function updatePHISettings(enabled) {
    fetch('/admin/api/update-phi-settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ enabled: enabled })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('PHI settings updated successfully', 'success');
        } else {
            showToast('Error updating PHI settings: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Network error updating PHI settings', 'error');
    });
}

// Helper function to get CSRF token (if using CSRF protection)
function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : '';
}

// Customer Value Analytics Charts Implementation
function initializeAnalyticsCharts() {
    // Only initialize if we're on the analytics tab
    const analyticsTab = document.getElementById('nav-analytics');
    if (!analyticsTab) return;

    // Time & Cost Savings Trends Chart (Main Chart)
    const savingsTrendsCtx = document.getElementById('savingsTrendsChart');
    if (savingsTrendsCtx) {
        new Chart(savingsTrendsCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Hours Saved',
                    data: [35.2, 38.7, 41.67, 39.1, 42.3, 45.8],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    yAxisID: 'y',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Cost Avoided ($)',
                    data: [880, 967.50, 1042.50, 977.50, 1057.50, 1145],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Labor Savings Trends (Per 500 Patient Batches)'
                    },
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            afterLabel: function(context) {
                                if (context.datasetIndex === 0) {
                                    return '≈ ' + (context.parsed.y / 40).toFixed(1) + ' work weeks';
                                } else {
                                    return 'Based on $25/hr wage';
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Hours Saved'
                        },
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Cost Avoided ($)'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Efficiency Breakdown Chart (Pie Chart)
    const efficiencyCtx = document.getElementById('efficiencyBreakdownChart');
    if (efficiencyCtx) {
        new Chart(efficiencyCtx, {
            type: 'doughnut',
            data: {
                labels: ['Prep Sheet Generation', 'Document Processing', 'Quality Review', 'Manual Tasks'],
                datasets: [{
                    data: [65, 20, 10, 5],
                    backgroundColor: [
                        '#36A2EB',
                        '#FF6384', 
                        '#FFCE56',
                        '#FF9F40'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Time Allocation Breakdown'
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 10,
                            font: {
                                size: 11
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                return `${label}: ${value}%`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Monthly Labor Savings Chart (Bar Chart)
    const monthlySavingsCtx = document.getElementById('monthlySavingsChart');
    if (monthlySavingsCtx) {
        new Chart(monthlySavingsCtx, {
            type: 'bar',
            data: {
                labels: ['Q1', 'Q2', 'Q3', 'Q4 (Proj)'],
                datasets: [{
                    label: 'Patients Processed',
                    data: [1450, 1623, 1789, 1950],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgb(54, 162, 235)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }, {
                    label: 'Cost Savings ($)',
                    data: [3023, 3388, 3733, 4068],
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 1,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Quarterly Performance Summary'
                    },
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Patients'
                        },
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Cost Savings ($)'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Cumulative Value Impact Chart (Area Chart)
    const cumulativeCtx = document.getElementById('cumulativeValueChart');
    if (cumulativeCtx) {
        new Chart(cumulativeCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Cumulative Hours Saved',
                    data: [35.2, 73.9, 115.57, 154.67, 196.97, 242.77],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: 'origin',
                    tension: 0.4
                }, {
                    label: 'Cumulative Cost Avoided ($)',
                    data: [880, 1847.50, 2890, 3867.50, 4925, 6070],
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.2)',
                    fill: 'origin',
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Cumulative Impact Over Time'
                    },
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Hours'
                        },
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Cost ($)'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

// Initialize analytics charts when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Add delay to ensure tab content is rendered
    setTimeout(initializeAnalyticsCharts, 500);
});

// Analytics period filter functionality
document.querySelectorAll('[data-period]').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('[data-period]').forEach(b => {
            b.classList.remove('active');
        });

        // Add active class to clicked button
        this.classList.add('active');

        const period = this.getAttribute('data-period');

        // Show different data based on period
        let message = '';
        switch(period) {
            case 'monthly':
                message = 'Showing monthly analytics: 500 patients, $1,042.50 saved';
                break;
            case 'quarterly':
                message = 'Showing quarterly analytics: 1,500 patients, $3,127.50 saved';
                break;
            case 'yearly':
                message = 'Showing yearly analytics: 6,000 patients, $12,510 saved';
                break;
        }

        showToast(message, 'info');

        // Here you would typically update chart data
        // For now, we'll just reinitialize with the same data
        setTimeout(initializeAnalyticsCharts, 100);
    });
});
</script>
{% endblock %}
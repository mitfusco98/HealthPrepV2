{% extends 'base_admin.html' %}

{% block title %}OCR Dashboard - HealthPrep{% endblock %}

{% block extra_css %}
<style>
.ocr-stat-card {
    border-left: 4px solid;
    transition: transform 0.2s;
}

.ocr-stat-card:hover {
    transform: translateY(-2px);
}

.confidence-excellent { border-left-color: #28a745; }
.confidence-good { border-left-color: #17a2b8; }
.confidence-fair { border-left-color: #ffc107; }
.confidence-poor { border-left-color: #fd7e14; }
.confidence-very-poor { border-left-color: #dc3545; }

.progress-stacked {
    height: 8px;
}

.document-queue {
    max-height: 400px;
    overflow-y: auto;
}

.processing-timeline {
    max-height: 300px;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-eye me-2"></i>
        OCR Processing Dashboard
    </h1>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-primary" onclick="refreshDashboard()">
            <i class="fas fa-sync me-1"></i>
            Refresh
        </button>
        <button type="button" class="btn btn-outline-success" onclick="processQueue()">
            <i class="fas fa-play me-1"></i>
            Process Queue
        </button>
    </div>
</div>

<!-- Processing Statistics -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card ocr-stat-card confidence-excellent">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted">Documents Processed</h6>
                        <h3 class="text-success">{{ processing_stats.total_processed or 0 }}</h3>
                        <small class="text-muted">Last 7 days</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-file-alt fa-2x text-success opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card ocr-stat-card confidence-good">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted">Average Confidence</h6>
                        <h3 class="text-info">{{ "%.1f"|format(processing_stats.average_confidence * 100 if processing_stats.average_confidence else 0) }}%</h3>
                        <small class="text-muted">OCR quality score</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x text-info opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card ocr-stat-card confidence-fair">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted">Processing Time</h6>
                        <h3 class="text-warning">{{ "%.1f"|format(processing_stats.average_processing_time if processing_stats.average_processing_time else 0) }}s</h3>
                        <small class="text-muted">Per document</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x text-warning opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card ocr-stat-card confidence-poor">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted">PHI Instances</h6>
                        <h3 class="text-danger">{{ processing_stats.phi_instances_filtered or 0 }}</h3>
                        <small class="text-muted">Filtered & redacted</small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-shield-alt fa-2x text-danger opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Quality Distribution -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Quality Distribution
                </h5>
            </div>
            <div class="card-body">
                {% if quality_stats and quality_stats.confidence_breakdown %}
                    {% set breakdown = quality_stats.confidence_breakdown %}
                    <div class="row text-center mb-3">
                        <div class="col">
                            <div class="text-success">
                                <h4>{{ breakdown.excellent.count or 0 }}</h4>
                                <small>Excellent (≥90%)</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-info">
                                <h4>{{ breakdown.good.count or 0 }}</h4>
                                <small>Good (80-89%)</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-warning">
                                <h4>{{ breakdown.fair.count or 0 }}</h4>
                                <small>Fair (70-79%)</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-danger">
                                <h4>{{ breakdown.poor.count + breakdown.very_poor.count if breakdown.poor and breakdown.very_poor else 0 }}</h4>
                                <small>Poor (<70%)</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Progress bar -->
                    {% set total = quality_stats.total_processed %}
                    {% if total > 0 %}
                    <div class="progress progress-stacked">
                        <div class="progress-bar bg-success" style="width: {{ breakdown.excellent.count / total * 100 }}%"></div>
                        <div class="progress-bar bg-info" style="width: {{ breakdown.good.count / total * 100 }}%"></div>
                        <div class="progress-bar bg-warning" style="width: {{ breakdown.fair.count / total * 100 }}%"></div>
                        <div class="progress-bar bg-danger" style="width: {{ (breakdown.poor.count + breakdown.very_poor.count) / total * 100 }}%"></div>
                    </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted text-center">No quality data available</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Processing Activity
                </h5>
            </div>
            <div class="card-body processing-timeline">
                {% if recent_activity %}
                    {% for activity in recent_activity %}
                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 bg-dark rounded">
                        <div class="flex-grow-1">
                            <strong>{{ activity.filename }}</strong>
                            <br>
                            <small class="text-muted">{{ activity.patient_name }}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-{% if activity.confidence_category == 'excellent' %}success{% elif activity.confidence_category == 'good' %}info{% elif activity.confidence_category == 'fair' %}warning{% else %}danger{% endif %}">
                                {{ "%.0f"|format(activity.confidence * 100) }}%
                            </span>
                            <br>
                            <small class="text-muted">{{ activity.processed_at }}</small>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center">No recent activity</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Processing Queue and Low Quality Documents -->
<div class="row g-4 mt-4">
    <!-- Processing Queue -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Processing Queue
                </h5>
                <span class="badge bg-primary">{{ pending_queue|length if pending_queue else 0 }} pending</span>
            </div>
            <div class="card-body document-queue">
                {% if pending_queue %}
                    {% for doc in pending_queue %}
                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                        <div class="flex-grow-1">
                            <strong>{{ doc.filename }}</strong>
                            <br>
                            <small class="text-muted">
                                {{ doc.patient_name }} • 
                                {{ doc.document_type.title() }} • 
                                Waiting {{ "%.1f"|format(doc.waiting_time_hours) }}h
                            </small>
                        </div>
                        <div class="text-end">
                            {% if doc.file_size %}
                                <small class="text-muted">{{ "%.1f"|format(doc.file_size / 1024) }} KB</small>
                            {% endif %}
                            <br>
                            <button class="btn btn-sm btn-outline-primary" onclick="processDocument({{ doc.document_id }})">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <p>No documents in processing queue</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Low Quality Documents -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Low Quality Documents
                </h5>
            </div>
            <div class="card-body document-queue">
                {% if quality_stats and quality_stats.low_quality_documents %}
                    {% for doc in quality_stats.low_quality_documents %}
                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 border border-warning rounded">
                        <div class="flex-grow-1">
                            <strong>{{ doc.filename }}</strong>
                            <br>
                            <small class="text-muted">
                                {{ doc.patient_name }} • 
                                {{ doc.document_type.title() }}
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-danger">{{ "%.0f"|format(doc.confidence * 100) }}%</span>
                            <br>
                            <button class="btn btn-sm btn-outline-warning" onclick="reprocessDocument({{ doc.document_id }})">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-thumbs-up fa-3x mb-3"></i>
                        <p>No low quality documents found</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Daily Processing Chart -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Daily Processing Volume
                </h5>
            </div>
            <div class="card-body">
                {% if processing_stats and processing_stats.daily_breakdown %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Documents</th>
                                    <th>Avg Confidence</th>
                                    <th>Processing Time</th>
                                    <th>Low Quality</th>
                                    <th>PHI Filtered</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for day in processing_stats.daily_breakdown %}
                                <tr>
                                    <td>{{ day.date }}</td>
                                    <td>{{ day.documents_processed }}</td>
                                    <td>
                                        <span class="badge bg-{% if day.average_confidence >= 0.9 %}success{% elif day.average_confidence >= 0.8 %}info{% elif day.average_confidence >= 0.7 %}warning{% else %}danger{% endif %}">
                                            {{ "%.1f"|format(day.average_confidence * 100) }}%
                                        </span>
                                    </td>
                                    <td>{{ "%.1f"|format(day.processing_time) }}s</td>
                                    <td>{{ day.low_confidence_count }}</td>
                                    <td>{{ day.phi_instances }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center">No daily processing data available</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshDashboard() {
    location.reload();
}

function processQueue() {
    if (confirm('Process all documents in the queue? This may take some time.')) {
        // Implement queue processing
        alert('Queue processing would be implemented here.');
    }
}

function processDocument(documentId) {
    if (confirm('Process this document now?')) {
        // Implement individual document processing
        alert(`Processing document ${documentId}...`);
    }
}

function reprocessDocument(documentId) {
    if (confirm('Reprocess this document? This will overwrite existing OCR results.')) {
        // Implement document reprocessing
        alert(`Reprocessing document ${documentId}...`);
    }
}

// Auto-refresh every 30 seconds
setInterval(function() {
    // Only refresh if user is active
    if (document.visibilityState === 'visible') {
        refreshDashboard();
    }
}, 30000);
</script>
{% endblock %}

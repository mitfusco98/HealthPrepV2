{% extends 'base_admin.html' %}

{% block title %}HealthPrep Admin - PHI Filter Settings{% endblock %}

{% block content %}
<div class="admin-header text-center">
    <h1><i class="fas fa-shield-alt me-3"></i>PHI Filter Settings</h1>
    <p class="lead mb-0">Configure HIPAA-compliant Protected Health Information filtering</p>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Security Warning -->
        <div class="alert admin-alert mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-2x me-3 text-warning"></i>
                <div>
                    <h5 class="alert-heading">HIPAA Compliance Notice</h5>
                    <p class="mb-0">
                        These settings control the automatic redaction of Protected Health Information (PHI) 
                        from OCR-processed documents. Changes to these settings affect HIPAA compliance and 
                        should be made carefully in consultation with your compliance officer.
                    </p>
                </div>
            </div>
        </div>

        <!-- PHI Filter Configuration Form -->
        <div class="card admin-table">
            <div class="card-header">
                <h5><i class="fas fa-cogs me-2"></i>Filter Configuration</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <!-- Master Enable/Disable -->
                    <div class="form-section mb-4">
                        <div class="form-check form-switch">
                            {{ form.enabled(class="form-check-input", id="phiEnabled") }}
                            <label class="form-check-label" for="phiEnabled">
                                <strong>Enable PHI Filtering</strong>
                            </label>
                        </div>
                        <small class="text-muted">
                            Master switch for all PHI filtering functionality. When disabled, no PHI redaction will occur.
                        </small>
                    </div>

                    <div id="filterOptions">
                        <!-- Personal Identifiers -->
                        <div class="form-section mb-4">
                            <h6><i class="fas fa-id-card me-2"></i>Personal Identifiers</h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.filter_ssn(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.filter_ssn.id }}">
                                            Social Security Numbers
                                        </label>
                                    </div>
                                    <small class="text-muted">Patterns: XXX-XX-XXXX, XXXXXXXXX</small>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.filter_phone(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.filter_phone.id }}">
                                            Phone Numbers
                                        </label>
                                    </div>
                                    <small class="text-muted">Patterns: (XXX) XXX-XXXX, XXX-XXX-XXXX</small>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.filter_names(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.filter_names.id }}">
                                            Patient Names
                                        </label>
                                    </div>
                                    <small class="text-muted">Contextual name detection</small>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.filter_addresses(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.filter_addresses.id }}">
                                            Street Addresses
                                        </label>
                                    </div>
                                    <small class="text-muted">Street addresses and ZIP codes</small>
                                </div>
                            </div>
                        </div>

                        <!-- Medical Identifiers -->
                        <div class="form-section mb-4">
                            <h6><i class="fas fa-hospital me-2"></i>Medical Identifiers</h6>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.filter_mrn(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.filter_mrn.id }}">
                                            Medical Record Numbers
                                        </label>
                                    </div>
                                    <small class="text-muted">MRN patterns and medical IDs</small>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        {{ form.filter_insurance(class="form-check-input") }}
                                        <label class="form-check-label" for="{{ form.filter_insurance.id }}">
                                            Insurance Information
                                        </label>
                                    </div>
                                    <small class="text-muted">Policy numbers and member IDs</small>
                                </div>
                            </div>
                        </div>

                        <!-- Temporal Information -->
                        <div class="form-section mb-4">
                            <h6><i class="fas fa-calendar me-2"></i>Temporal Information</h6>
                            
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.filter_dates(class="form-check-input") }}
                                    <label class="form-check-label" for="{{ form.filter_dates.id }}">
                                        Dates (Smart Filtering)
                                    </label>
                                </div>
                                <small class="text-muted">
                                    Filters personal dates while preserving medical values (lab dates, appointment dates, etc.)
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="button" class="btn btn-outline-info me-2" onclick="testPHIFilter()">
                                <i class="fas fa-vial me-1"></i>Test Filter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="exportConfiguration()">
                                <i class="fas fa-download me-1"></i>Export Config
                            </button>
                        </div>
                        <div>
                            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Save Settings
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- PHI Filter Statistics -->
        <div class="card admin-table mt-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar me-2"></i>PHI Filter Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-primary">{{ settings.get('documents_processed', 0) }}</h4>
                        <small class="text-muted">Documents Processed</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-success">{{ settings.get('phi_instances_found', 0) }}</h4>
                        <small class="text-muted">PHI Instances Found</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-info">{{ settings.get('phi_instances_redacted', 0) }}</h4>
                        <small class="text-muted">PHI Instances Redacted</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-warning">{{ "%.1f"|format(settings.get('compliance_rate', 0)) }}%</h4>
                        <small class="text-muted">Compliance Rate</small>
                    </div>
                </div>
                
                <hr>
                
                <!-- PHI Type Breakdown -->
                <h6>PHI Detection Breakdown (Last 30 Days)</h6>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li class="d-flex justify-content-between">
                                <span>SSN Patterns:</span>
                                <span class="badge bg-secondary">{{ settings.get('ssn_count', 0) }}</span>
                            </li>
                            <li class="d-flex justify-content-between">
                                <span>Phone Numbers:</span>
                                <span class="badge bg-secondary">{{ settings.get('phone_count', 0) }}</span>
                            </li>
                            <li class="d-flex justify-content-between">
                                <span>Names:</span>
                                <span class="badge bg-secondary">{{ settings.get('name_count', 0) }}</span>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li class="d-flex justify-content-between">
                                <span>MRN Patterns:</span>
                                <span class="badge bg-secondary">{{ settings.get('mrn_count', 0) }}</span>
                            </li>
                            <li class="d-flex justify-content-between">
                                <span>Insurance IDs:</span>
                                <span class="badge bg-secondary">{{ settings.get('insurance_count', 0) }}</span>
                            </li>
                            <li class="d-flex justify-content-between">
                                <span>Addresses:</span>
                                <span class="badge bg-secondary">{{ settings.get('address_count', 0) }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Testing Section -->
        <div class="card admin-table mt-4">
            <div class="card-header">
                <h5><i class="fas fa-vial me-2"></i>PHI Filter Testing</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="testInput" class="form-label">Test Input:</label>
                        <textarea class="form-control" id="testInput" rows="6" 
                                  placeholder="Enter text containing PHI to test filtering...
Example:
Patient: John Doe
SSN: 123-45-6789
Phone: (555) 123-4567
MRN: MR123456
Address: 123 Main St, Anytown, NY 12345"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label for="testOutput" class="form-label">Filtered Output:</label>
                        <textarea class="form-control" id="testOutput" rows="6" readonly 
                                  placeholder="Filtered text will appear here..."></textarea>
                    </div>
                </div>
                <div class="mt-3">
                    <button type="button" class="btn btn-outline-primary" onclick="runPHITest()">
                        <i class="fas fa-play me-1"></i>Run Test
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-2" onclick="clearTest()">
                        <i class="fas fa-eraser me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const phiEnabledCheckbox = document.getElementById('phiEnabled');
    const filterOptions = document.getElementById('filterOptions');
    
    // Toggle filter options based on master switch
    function toggleFilterOptions() {
        if (phiEnabledCheckbox.checked) {
            filterOptions.style.display = 'block';
            filterOptions.style.opacity = '1';
        } else {
            filterOptions.style.display = 'none';
            filterOptions.style.opacity = '0.5';
        }
    }
    
    phiEnabledCheckbox.addEventListener('change', toggleFilterOptions);
    toggleFilterOptions(); // Initial state
    
    // Show warning when disabling PHI filtering
    phiEnabledCheckbox.addEventListener('change', function() {
        if (!this.checked) {
            if (!confirm('WARNING: Disabling PHI filtering will stop all automatic redaction of protected health information. This may impact HIPAA compliance. Are you sure you want to continue?')) {
                this.checked = true;
                toggleFilterOptions();
            }
        }
    });
});

function testPHIFilter() {
    const testText = `
Test Document for PHI Detection:

Patient Information:
Name: John Doe
SSN: 123-45-6789
Phone: (555) 123-4567
DOB: 01/15/1980
Address: 123 Main Street, Anytown, NY 12345

Medical Information:
MRN: MR123456
Policy Number: POL987654321
Lab Results Date: 03/15/2024
Blood Pressure: 120/80 mmHg
Glucose: 95 mg/dL
`;
    
    document.getElementById('testInput').value = testText;
    runPHITest();
}

function runPHITest() {
    const input = document.getElementById('testInput').value;
    const output = document.getElementById('testOutput');
    
    if (!input.trim()) {
        alert('Please enter some test text first.');
        return;
    }
    
    // Simulate PHI filtering (in real implementation, this would call the server)
    let filtered = input;
    
    // Simple client-side simulation of PHI filtering
    const phiEnabledCheckbox = document.getElementById('phiEnabled');
    if (phiEnabledCheckbox.checked) {
        // SSN filtering
        if (document.getElementById('{{ form.filter_ssn.id }}').checked) {
            filtered = filtered.replace(/\b\d{3}-\d{2}-\d{4}\b/g, '[SSN REDACTED]');
        }
        
        // Phone filtering
        if (document.getElementById('{{ form.filter_phone.id }}').checked) {
            filtered = filtered.replace(/\(\d{3}\)\s*\d{3}-\d{4}/g, '[PHONE REDACTED]');
        }
        
        // Name filtering
        if (document.getElementById('{{ form.filter_names.id }}').checked) {
            filtered = filtered.replace(/Name:\s*[A-Z][a-z]+\s+[A-Z][a-z]+/g, 'Name: [NAME REDACTED]');
        }
        
        // MRN filtering
        if (document.getElementById('{{ form.filter_mrn.id }}').checked) {
            filtered = filtered.replace(/MRN:\s*[A-Z0-9]+/g, 'MRN: [REDACTED]');
        }
        
        // Address filtering
        if (document.getElementById('{{ form.filter_addresses.id }}').checked) {
            filtered = filtered.replace(/\d+\s+[A-Za-z\s]+Street,\s*[A-Za-z\s]+,\s*[A-Z]{2}\s+\d{5}/g, '[ADDRESS REDACTED]');
        }
        
        // Insurance filtering
        if (document.getElementById('{{ form.filter_insurance.id }}').checked) {
            filtered = filtered.replace(/Policy\s+Number:\s*[A-Z0-9]+/g, 'Policy Number: [REDACTED]');
        }
        
        // Date filtering (preserve medical dates)
        if (document.getElementById('{{ form.filter_dates.id }}').checked) {
            filtered = filtered.replace(/DOB:\s*\d{2}\/\d{2}\/\d{4}/g, 'DOB: [DATE REDACTED]');
        }
    }
    
    output.value = filtered;
    
    // Show differences
    if (input !== filtered) {
        const changes = filtered.split('\n').filter(line => line.includes('[') && line.includes('REDACTED')).length;
        alert(`PHI filtering complete. ${changes} potential PHI instances were redacted.`);
    } else {
        alert('No PHI patterns detected in the test text.');
    }
}

function clearTest() {
    document.getElementById('testInput').value = '';
    document.getElementById('testOutput').value = '';
}

function exportConfiguration() {
    const config = {
        timestamp: new Date().toISOString(),
        phi_filter_settings: {
            enabled: document.getElementById('phiEnabled').checked,
            filter_ssn: document.getElementById('{{ form.filter_ssn.id }}').checked,
            filter_phone: document.getElementById('{{ form.filter_phone.id }}').checked,
            filter_mrn: document.getElementById('{{ form.filter_mrn.id }}').checked,
            filter_insurance: document.getElementById('{{ form.filter_insurance.id }}').checked,
            filter_addresses: document.getElementById('{{ form.filter_addresses.id }}').checked,
            filter_names: document.getElementById('{{ form.filter_names.id }}').checked,
            filter_dates: document.getElementById('{{ form.filter_dates.id }}').checked
        }
    };
    
    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `phi_filter_config_${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}

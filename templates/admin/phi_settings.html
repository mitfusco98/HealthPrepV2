{% extends 'base_admin.html' %}

{% block title %}HealthPrep Admin - PHI Settings{% endblock %}

{% block content %}
<!-- PHI Settings Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>
            <i class="fas fa-user-shield me-2 text-warning"></i>
            PHI Filtering Settings
        </h2>
        <p class="text-muted mb-0">
            Configure protected health information filtering and redaction policies
        </p>
    </div>
    
    <div class="d-flex gap-2">
        <button type="button" 
                class="btn btn-outline-light" 
                onclick="testPHIFilter()"
                data-bs-toggle="tooltip" 
                title="Test current PHI filter settings">
            <i class="fas fa-flask me-2"></i>
            Test Filter
        </button>
        
        <button type="button" 
                class="btn btn-outline-light" 
                onclick="exportPHIConfig()"
                data-bs-toggle="tooltip" 
                title="Export PHI configuration">
            <i class="fas fa-download me-2"></i>
            Export Config
        </button>
    </div>
</div>

<!-- HIPAA Compliance Warning -->
<div class="alert alert-warning mb-4" role="alert">
    <div class="d-flex align-items-center">
        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
        <div>
            <h5 class="alert-heading mb-1">HIPAA Compliance Notice</h5>
            <p class="mb-0">
                These settings control how protected health information (PHI) is handled during document processing. 
                Changes may affect HIPAA compliance. Ensure all modifications are reviewed and documented.
            </p>
        </div>
    </div>
</div>

<!-- PHI Settings Form -->
<form method="POST">
    <div class="row">
        <!-- Global Settings -->
        <div class="col-lg-8">
            <div class="card admin-card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-toggle-on me-2"></i>
                        Global PHI Filtering
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" 
                               type="checkbox" 
                               id="global_enabled" 
                               name="global_enabled" 
                               {{ 'checked' if settings.global_enabled else '' }}>
                        <label class="form-check-label" for="global_enabled">
                            <strong>Enable PHI Filtering System-Wide</strong>
                        </label>
                        <div class="form-text">
                            Master switch to enable or disable all PHI filtering functionality. 
                            When disabled, no PHI redaction will occur.
                        </div>
                    </div>
                    
                    {% if not settings.global_enabled %}
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Warning:</strong> PHI filtering is currently disabled. This may not be HIPAA compliant.
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Individual PHI Types -->
            <div class="card admin-card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list-check me-2"></i>
                        PHI Type Filtering
                    </h5>
                    <small class="text-muted">Configure which types of PHI to detect and redact</small>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- SSN Filtering -->
                        <div class="col-md-6 mb-3">
                            <div class="card border">
                                <div class="card-body">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="filter_ssn" 
                                               name="filter_ssn" 
                                               {{ 'checked' if settings.filter_ssn else '' }}>
                                        <label class="form-check-label fw-bold" for="filter_ssn">
                                            <i class="fas fa-id-card me-2 text-danger"></i>
                                            Social Security Numbers
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        Detects: XXX-XX-XXXX, XXX XX XXXX, XXXXXXXXX patterns
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Phone Filtering -->
                        <div class="col-md-6 mb-3">
                            <div class="card border">
                                <div class="card-body">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="filter_phone" 
                                               name="filter_phone" 
                                               {{ 'checked' if settings.filter_phone else '' }}>
                                        <label class="form-check-label fw-bold" for="filter_phone">
                                            <i class="fas fa-phone me-2 text-info"></i>
                                            Phone Numbers
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        Detects: (XXX) XXX-XXXX, XXX-XXX-XXXX, XXX.XXX.XXXX patterns
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MRN Filtering -->
                        <div class="col-md-6 mb-3">
                            <div class="card border">
                                <div class="card-body">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="filter_mrn" 
                                               name="filter_mrn" 
                                               {{ 'checked' if settings.filter_mrn else '' }}>
                                        <label class="form-check-label fw-bold" for="filter_mrn">
                                            <i class="fas fa-file-medical me-2 text-success"></i>
                                            Medical Record Numbers
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        Detects: MRN:, MR#:, Medical Record Number: patterns
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Insurance Filtering -->
                        <div class="col-md-6 mb-3">
                            <div class="card border">
                                <div class="card-body">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="filter_insurance" 
                                               name="filter_insurance" 
                                               {{ 'checked' if settings.filter_insurance else '' }}>
                                        <label class="form-check-label fw-bold" for="filter_insurance">
                                            <i class="fas fa-credit-card me-2 text-warning"></i>
                                            Insurance Information
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        Detects: Policy #:, Member ID:, Group #: patterns
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Address Filtering -->
                        <div class="col-md-6 mb-3">
                            <div class="card border">
                                <div class="card-body">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="filter_addresses" 
                                               name="filter_addresses" 
                                               {{ 'checked' if settings.filter_addresses else '' }}>
                                        <label class="form-check-label fw-bold" for="filter_addresses">
                                            <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                            Street Addresses
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        Detects: Street addresses and ZIP codes
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Date Filtering -->
                        <div class="col-md-6 mb-3">
                            <div class="card border">
                                <div class="card-body">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="filter_dates" 
                                               name="filter_dates" 
                                               {{ 'checked' if settings.filter_dates else '' }}>
                                        <label class="form-check-label fw-bold" for="filter_dates">
                                            <i class="fas fa-calendar me-2 text-secondary"></i>
                                            Dates (Selective)
                                        </label>
                                    </div>
                                    <small class="text-muted">
                                        Detects dates while preserving medical measurements (BP, etc.)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PHI Statistics and Controls -->
        <div class="col-lg-4">
            <!-- Current Status -->
            <div class="card admin-card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        PHI Processing Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Global Status</span>
                            <span class="badge {{ 'bg-success' if settings.global_enabled else 'bg-danger' }}">
                                {{ 'Enabled' if settings.global_enabled else 'Disabled' }}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Active Filters</span>
                            <span class="badge bg-primary">
                                {% set active_count = [
                                    settings.filter_ssn,
                                    settings.filter_phone,
                                    settings.filter_mrn,
                                    settings.filter_insurance,
                                    settings.filter_addresses,
                                    settings.filter_dates
                                ]|select|list|length %}
                                {{ active_count }}/6
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>Last Updated</span>
                            <span class="badge bg-info">
                                {{ settings.updated_at.strftime('%m/%d/%Y') if settings.updated_at else 'Never' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Medical Term Protection -->
            <div class="card admin-card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-stethoscope me-2"></i>
                        Medical Term Protection
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Automatic Protection</strong>
                        <p class="mb-0 mt-2 small">
                            The system automatically preserves medical terminology:
                        </p>
                        <ul class="small mt-2 mb-0">
                            <li>Blood pressure readings (XXX/XX mmHg)</li>
                            <li>Lab values (mg/dL, percentages)</li>
                            <li>Medical procedures and medications</li>
                            <li>Clinical measurements</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="card admin-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Tools & Testing
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" 
                                class="btn btn-outline-primary btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#testPHIModal">
                            <i class="fas fa-flask me-2"></i>
                            Test PHI Filter
                        </button>
                        
                        <button type="button" 
                                class="btn btn-outline-secondary btn-sm" 
                                onclick="resetToRecommended()">
                            <i class="fas fa-undo me-2"></i>
                            HIPAA Recommended
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Button -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-end gap-2">
                <button type="button" 
                        class="btn btn-secondary" 
                        onclick="window.location.reload()">
                    <i class="fas fa-times me-2"></i>
                    Cancel
                </button>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save me-2"></i>
                    Save PHI Settings
                </button>
            </div>
        </div>
    </div>
</form>

<!-- PHI Test Modal -->
<div class="modal fade" id="testPHIModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-flask me-2"></i>
                    PHI Filter Test
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="testText" class="form-label">Test Text (Enter sample text with PHI)</label>
                    <textarea class="form-control" 
                              id="testText" 
                              rows="5" 
                              placeholder="Patient John Doe, SSN: 123-45-6789, Phone: (555) 123-4567, MRN: 12345678, visited on 01/15/2024. Blood pressure was 120/80 mmHg."></textarea>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Filtered Result</label>
                    <div id="filteredResult" class="form-control" style="min-height: 100px; background-color: #f8f9fa;">
                        <em class="text-muted">Enter text above and click "Test Filter" to see results</em>
                    </div>
                </div>
                
                <div id="phiStatistics" class="d-none">
                    <h6>Detection Statistics:</h6>
                    <div id="phiStats"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Close
                </button>
                <button type="button" class="btn btn-primary" onclick="runPHITest()">
                    <i class="fas fa-play me-2"></i>
                    Test Filter
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Reset to HIPAA recommended settings
function resetToRecommended() {
    if (confirm('Reset to HIPAA recommended settings? This will enable all PHI filters.')) {
        document.getElementById('global_enabled').checked = true;
        document.getElementById('filter_ssn').checked = true;
        document.getElementById('filter_phone').checked = true;
        document.getElementById('filter_mrn').checked = true;
        document.getElementById('filter_insurance').checked = true;
        document.getElementById('filter_addresses').checked = true;
        document.getElementById('filter_dates').checked = true;
    }
}

// Test PHI filter
function testPHIFilter() {
    const modal = new bootstrap.Modal(document.getElementById('testPHIModal'));
    modal.show();
}

// Run PHI test
function runPHITest() {
    const testText = document.getElementById('testText').value;
    
    if (!testText.trim()) {
        alert('Please enter some test text');
        return;
    }
    
    // This would typically call the backend PHI filter API
    // For now, we'll simulate the filtering
    let filteredText = testText;
    const detectedPHI = {};
    
    // Simulate PHI detection and replacement
    if (document.getElementById('filter_ssn').checked) {
        const ssnRegex = /\b\d{3}-\d{2}-\d{4}\b/g;
        const ssnMatches = testText.match(ssnRegex);
        if (ssnMatches) {
            detectedPHI['SSN'] = ssnMatches.length;
            filteredText = filteredText.replace(ssnRegex, '[SSN REDACTED]');
        }
    }
    
    if (document.getElementById('filter_phone').checked) {
        const phoneRegex = /\(\d{3}\)\s?\d{3}-\d{4}/g;
        const phoneMatches = testText.match(phoneRegex);
        if (phoneMatches) {
            detectedPHI['Phone'] = phoneMatches.length;
            filteredText = filteredText.replace(phoneRegex, '[PHONE REDACTED]');
        }
    }
    
    if (document.getElementById('filter_mrn').checked) {
        const mrnRegex = /MRN:\s*\d+/g;
        const mrnMatches = testText.match(mrnRegex);
        if (mrnMatches) {
            detectedPHI['MRN'] = mrnMatches.length;
            filteredText = filteredText.replace(mrnRegex, '[MRN REDACTED]');
        }
    }
    
    // Display results
    document.getElementById('filteredResult').innerHTML = filteredText;
    
    if (Object.keys(detectedPHI).length > 0) {
        const statsHtml = Object.entries(detectedPHI).map(([type, count]) => 
            `<span class="badge bg-warning text-dark me-2">${type}: ${count}</span>`
        ).join('');
        document.getElementById('phiStats').innerHTML = statsHtml;
        document.getElementById('phiStatistics').classList.remove('d-none');
    } else {
        document.getElementById('phiStatistics').classList.add('d-none');
    }
}

// Export PHI configuration
function exportPHIConfig() {
    const config = {
        global_enabled: document.getElementById('global_enabled').checked,
        filters: {
            ssn: document.getElementById('filter_ssn').checked,
            phone: document.getElementById('filter_phone').checked,
            mrn: document.getElementById('filter_mrn').checked,
            insurance: document.getElementById('filter_insurance').checked,
            addresses: document.getElementById('filter_addresses').checked,
            dates: document.getElementById('filter_dates').checked
        },
        export_timestamp: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(config, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'phi_config.json';
    link.click();
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const globalToggle = document.getElementById('global_enabled');
    const filterCheckboxes = document.querySelectorAll('input[name^="filter_"]');
    
    // Warn when disabling global PHI filtering
    globalToggle.addEventListener('change', function() {
        if (!this.checked) {
            const confirmed = confirm(
                'WARNING: Disabling PHI filtering may violate HIPAA compliance requirements.\n\n' +
                'Are you sure you want to disable PHI filtering?'
            );
            if (!confirmed) {
                this.checked = true;
            }
        }
    });
    
    // Disable individual filters when global is disabled
    function updateFilterStates() {
        filterCheckboxes.forEach(checkbox => {
            checkbox.disabled = !globalToggle.checked;
            if (!globalToggle.checked) {
                checkbox.closest('.card').classList.add('opacity-50');
            } else {
                checkbox.closest('.card').classList.remove('opacity-50');
            }
        });
    }
    
    globalToggle.addEventListener('change', updateFilterStates);
    updateFilterStates(); // Initial state
    
    // Form submission
    form.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        submitBtn.disabled = true;
    });
});
</script>
{% endblock %}

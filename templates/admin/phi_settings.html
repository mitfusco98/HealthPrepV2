{% extends 'admin/base.html' %}

{% block title %}HealthPrep Admin - PHI Settings{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-user-shield me-2"></i>PHI Filtering Settings</h1>
    <div>
        <button class="btn btn-success btn-sm" onclick="testPHIFilter()">
            <i class="fas fa-test-tube me-1"></i>Test Filter
        </button>
    </div>
</div>

<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle me-2"></i>
    <strong>HIPAA Compliance:</strong> These settings control how personally identifiable information (PHI) 
    is filtered from OCR-processed documents to ensure HIPAA compliance.
</div>

<form method="POST" action="{{ url_for('admin_phi_settings') }}">
    <div class="row">
        <!-- Master Toggle -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-power-off me-2"></i>
                        Master Controls
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="phi_filtering_enabled" 
                               name="phi_filtering_enabled" 
                               {{ 'checked' if settings.phi_filtering_enabled else '' }}>
                        <label class="form-check-label fw-bold" for="phi_filtering_enabled">
                            Enable PHI Filtering System-Wide
                        </label>
                        <div class="form-text">
                            When disabled, no PHI filtering will be applied to any documents. 
                            <strong class="text-danger">Use with extreme caution.</strong>
                        </div>
                    </div>
                    
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="preserve_medical_terms" 
                               name="preserve_medical_terms" 
                               {{ 'checked' if settings.preserve_medical_terms else '' }}>
                        <label class="form-check-label fw-bold" for="preserve_medical_terms">
                            Preserve Medical Terminology
                        </label>
                        <div class="form-text">
                            Protects medical values, measurements, and clinical terms from being filtered.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PHI Type Controls -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-id-card me-2"></i>
                        Personal Identifiers
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="filter_ssn" 
                               name="filter_ssn" 
                               {{ 'checked' if settings.filter_ssn else '' }}>
                        <label class="form-check-label" for="filter_ssn">
                            <strong>Social Security Numbers</strong>
                        </label>
                        <div class="form-text">Filters XXX-XX-XXXX patterns</div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="filter_phone" 
                               name="filter_phone" 
                               {{ 'checked' if settings.filter_phone else '' }}>
                        <label class="form-check-label" for="filter_phone">
                            <strong>Phone Numbers</strong>
                        </label>
                        <div class="form-text">Filters (XXX) XXX-XXXX patterns</div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="filter_names" 
                               name="filter_names" 
                               {{ 'checked' if settings.filter_names else '' }}>
                        <label class="form-check-label" for="filter_names">
                            <strong>Patient Names</strong>
                        </label>
                        <div class="form-text">Filters identifiable patient names</div>
                    </div>
                    
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="filter_addresses" 
                               name="filter_addresses" 
                               {{ 'checked' if settings.filter_addresses else '' }}>
                        <label class="form-check-label" for="filter_addresses">
                            <strong>Street Addresses</strong>
                        </label>
                        <div class="form-text">Filters street addresses and ZIP codes</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Medical & Temporal Data
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="filter_mrn" 
                               name="filter_mrn" 
                               {{ 'checked' if settings.filter_mrn else '' }}>
                        <label class="form-check-label" for="filter_mrn">
                            <strong>Medical Record Numbers</strong>
                        </label>
                        <div class="form-text">Filters MRN and chart numbers</div>
                    </div>
                    
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="filter_insurance" 
                               name="filter_insurance" 
                               {{ 'checked' if settings.filter_insurance else '' }}>
                        <label class="form-check-label" for="filter_insurance">
                            <strong>Insurance Information</strong>
                        </label>
                        <div class="form-text">Filters policy and member IDs</div>
                    </div>
                    
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="filter_dates" 
                               name="filter_dates" 
                               {{ 'checked' if settings.filter_dates else '' }}>
                        <label class="form-check-label" for="filter_dates">
                            <strong>Dates</strong>
                        </label>
                        <div class="form-text">
                            Filters date patterns while preserving medical values
                            <small class="text-warning d-block">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Use carefully - may affect clinical data
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Last updated: {{ settings.updated_at.strftime('%m/%d/%Y %H:%M') if settings.updated_at else 'Never' }}
                            </small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="location.reload()">
                                <i class="fas fa-undo me-1"></i>Reset
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Save Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- PHI Filter Test Modal -->
<div class="modal fade" id="phiTestModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-test-tube me-2"></i>
                    PHI Filter Test
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="testText" class="form-label">Enter text to test PHI filtering:</label>
                    <textarea class="form-control" id="testText" rows="5" 
                              placeholder="Patient John Doe, SSN: 123-45-6789, Phone: (555) 123-4567, born 01/15/1980..."></textarea>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h6>Original Text:</h6>
                        <div id="originalText" class="border p-3 bg-light text-dark" style="min-height: 100px; white-space: pre-wrap;"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Filtered Text:</h6>
                        <div id="filteredText" class="border p-3 bg-light text-dark" style="min-height: 100px; white-space: pre-wrap;"></div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Filter Statistics:</h6>
                    <div id="filterStats" class="alert alert-info"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="runPHITest()">
                    <i class="fas fa-play me-1"></i>Run Test
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function testPHIFilter() {
    const modal = new bootstrap.Modal(document.getElementById('phiTestModal'));
    modal.show();
}

function runPHITest() {
    const testText = document.getElementById('testText').value;
    if (!testText.trim()) {
        alert('Please enter some text to test');
        return;
    }
    
    // Display original text
    document.getElementById('originalText').textContent = testText;
    
    // Simulate PHI filtering (in real implementation, this would call the API)
    showLoading('Running PHI filter test...');
    
    setTimeout(() => {
        hideLoading();
        
        // Simulated filtered result
        let filtered = testText;
        let stats = {
            ssn_found: 0,
            phone_found: 0,
            names_found: 0,
            total_redactions: 0
        };
        
        // Simple simulation of filtering
        if (filtered.match(/\d{3}-\d{2}-\d{4}/g)) {
            filtered = filtered.replace(/\d{3}-\d{2}-\d{4}/g, '[SSN REDACTED]');
            stats.ssn_found++;
            stats.total_redactions++;
        }
        
        if (filtered.match(/\(\d{3}\)\s*\d{3}-\d{4}/g)) {
            filtered = filtered.replace(/\(\d{3}\)\s*\d{3}-\d{4}/g, '[PHONE REDACTED]');
            stats.phone_found++;
            stats.total_redactions++;
        }
        
        // Display results
        document.getElementById('filteredText').textContent = filtered;
        document.getElementById('filterStats').innerHTML = `
            <strong>Redactions Applied:</strong><br>
            • SSN patterns found: ${stats.ssn_found}<br>
            • Phone patterns found: ${stats.phone_found}<br>
            • Total redactions: ${stats.total_redactions}
        `;
    }, 1500);
}

// Validate settings before submission
document.querySelector('form').addEventListener('submit', function(e) {
    const phiEnabled = document.getElementById('phi_filtering_enabled').checked;
    
    if (!phiEnabled) {
        if (!confirm('⚠️ WARNING: Disabling PHI filtering may violate HIPAA compliance requirements. Are you sure you want to continue?')) {
            e.preventDefault();
        }
    }
});
</script>
{% endblock %}

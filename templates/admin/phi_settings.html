{% extends 'base_admin.html' %}

{% block title %}PHI Settings - HealthPrep Admin{% endblock %}

{% block content %}
<!-- PHI Settings Header -->
<div class="admin-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="h3 mb-1">
                <i class="fas fa-shield-alt me-2"></i>
                PHI Filtering Settings
            </h1>
            <p class="mb-0 opacity-75">
                Configure HIPAA-compliant Protected Health Information filtering and redaction
            </p>
        </div>
        <div class="col-md-4 text-end">
            <div class="badge bg-{{ 'success' if settings.phi_filtering_enabled else 'warning' }} px-3 py-2">
                <i class="fas fa-{{ 'shield-check' if settings.phi_filtering_enabled else 'shield-alt' }} me-1"></i>
                PHI Filtering {{ 'Enabled' if settings.phi_filtering_enabled else 'Disabled' }}
            </div>
        </div>
    </div>
</div>

<!-- Security Status Cards -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="metric-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="text-success mb-1">{{ phi_stats.phi_filtered_documents if phi_stats else 0 }}</h3>
                    <p class="text-muted mb-0">Documents Filtered</p>
                    <small class="text-success">PHI Protected</small>
                </div>
                <div class="text-success">
                    <i class="fas fa-file-shield fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="metric-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="text-primary mb-1">{{ phi_stats.filtering_rate if phi_stats else 0 }}%</h3>
                    <p class="text-muted mb-0">Filtering Rate</p>
                    <small class="text-primary">Coverage</small>
                </div>
                <div class="text-primary">
                    <i class="fas fa-percentage fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="metric-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="text-warning mb-1">{{ phi_stats.pattern_statistics|length if phi_stats else 0 }}</h3>
                    <p class="text-muted mb-0">Pattern Types</p>
                    <small class="text-warning">Active Filters</small>
                </div>
                <div class="text-warning">
                    <i class="fas fa-search fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="metric-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="text-info mb-1">{{ phi_stats.total_documents if phi_stats else 0 }}</h3>
                    <p class="text-muted mb-0">Total Documents</p>
                    <small class="text-info">In System</small>
                </div>
                <div class="text-info">
                    <i class="fas fa-files fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- PHI Configuration -->
    <div class="col-lg-8">
        <div class="admin-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cog text-primary me-2"></i>
                    PHI Filtering Configuration
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin.phi_settings') }}">
                    {{ csrf_token() }}
                    
                    <!-- Master Switch -->
                    <div class="alert alert-{{ 'success' if settings.phi_filtering_enabled else 'warning' }} border-0 mb-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="phi_filtering_enabled" 
                                   name="phi_filtering_enabled" {{ 'checked' if settings.phi_filtering_enabled else '' }}>
                            <label class="form-check-label fw-bold" for="phi_filtering_enabled">
                                <i class="fas fa-shield-alt me-2"></i>
                                Enable PHI Filtering System
                            </label>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Master control for all PHI filtering functionality. Disabling this will turn off all PHI protection.
                        </small>
                    </div>
                    
                    <!-- Pattern Categories -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card border-secondary">
                                <div class="card-header bg-secondary">
                                    <h6 class="mb-0">
                                        <i class="fas fa-id-card text-warning me-2"></i>
                                        Personal Identifiers
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="filter_ssn" 
                                               name="filter_ssn" {{ 'checked' if settings.filter_ssn else '' }}>
                                        <label class="form-check-label" for="filter_ssn">
                                            <strong>Social Security Numbers</strong>
                                            <br><small class="text-muted">Format: XXX-XX-XXXX</small>
                                        </label>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="filter_mrn" 
                                               name="filter_mrn" {{ 'checked' if settings.filter_mrn else '' }}>
                                        <label class="form-check-label" for="filter_mrn">
                                            <strong>Medical Record Numbers</strong>
                                            <br><small class="text-muted">MRN, Patient ID patterns</small>
                                        </label>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="filter_names" 
                                               name="filter_names" {{ 'checked' if settings.filter_names else '' }}>
                                        <label class="form-check-label" for="filter_names">
                                            <strong>Email Addresses</strong>
                                            <br><small class="text-muted">Personal email identifiers</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info">
                                    <h6 class="mb-0">
                                        <i class="fas fa-map-marker-alt text-warning me-2"></i>
                                        Contact Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="filter_phone" 
                                               name="filter_phone" {{ 'checked' if settings.filter_phone else '' }}>
                                        <label class="form-check-label" for="filter_phone">
                                            <strong>Phone Numbers</strong>
                                            <br><small class="text-muted">All phone number formats</small>
                                        </label>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="filter_addresses" 
                                               name="filter_addresses" {{ 'checked' if settings.filter_addresses else '' }}>
                                        <label class="form-check-label" for="filter_addresses">
                                            <strong>Addresses & ZIP Codes</strong>
                                            <br><small class="text-muted">Street addresses, postal codes</small>
                                        </label>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="filter_dates" 
                                               name="filter_dates" {{ 'checked' if settings.filter_dates else '' }}>
                                        <label class="form-check-label" for="filter_dates">
                                            <strong>Dates</strong>
                                            <br><small class="text-danger">⚠️ May filter medical dates</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if settings.updated_at %}
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    Last updated: {{ settings.updated_at.strftime('%m/%d/%Y %I:%M %p') }}
                                    {% if settings.updated_by_user %}
                                        by {{ settings.updated_by_user.username }}
                                    {% endif %}
                                </small>
                            {% endif %}
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save PHI Settings
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Statistics and Testing -->
    <div class="col-lg-4">
        <!-- Pattern Statistics -->
        {% if phi_stats and phi_stats.pattern_statistics %}
            <div class="admin-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-warning me-2"></i>
                        Detection Statistics
                    </h5>
                </div>
                <div class="card-body">
                    {% for pattern_type, count in phi_stats.pattern_statistics.items() %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-capitalize">{{ pattern_type.replace('_', ' ') }}:</span>
                            <span class="badge bg-primary">{{ count }}</span>
                        </div>
                    {% endfor %}
                    
                    <hr class="my-3">
                    
                    <div class="text-center">
                        <small class="text-muted">
                            Total patterns detected across all documents
                        </small>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- PHI Filter Testing -->
        <div class="admin-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-vial text-info me-2"></i>
                    Filter Testing
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('admin.phi_settings') }}">
                    <div class="mb-3">
                        <label for="test_text" class="form-label">Test Text</label>
                        <textarea class="form-control" id="test_text" name="test_text" rows="4" 
                                  placeholder="Enter text with PHI to test filtering...">{{ test_text }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-info w-100">
                        <i class="fas fa-test-tube me-1"></i>Test Filter
                    </button>
                </form>
                
                {% if test_result %}
                    <hr class="my-3">
                    
                    <div class="mb-3">
                        <label class="form-label">Original Text:</label>
                        <div class="bg-dark border rounded p-2">
                            <small class="font-monospace">{{ test_result.original_text }}</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Filtered Text:</label>
                        <div class="bg-success bg-opacity-10 border border-success rounded p-2">
                            <small class="font-monospace text-success">{{ test_result.filtered_text }}</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Results:</label>
                        <ul class="list-unstyled mb-0">
                            <li><small><strong>Redactions:</strong> {{ test_result.redactions_made }}</small></li>
                            <li><small><strong>Reduction:</strong> {{ test_result.preview.reduction_percentage }}%</small></li>
                            <li><small><strong>Patterns Found:</strong> {{ test_result.patterns_found|length }}</small></li>
                        </ul>
                    </div>
                    
                    {% if test_result.patterns_found %}
                        <div>
                            <label class="form-label">Detected Patterns:</label>
                            <div class="d-flex flex-wrap gap-1">
                                {% for pattern in test_result.patterns_found %}
                                    <span class="badge bg-warning text-dark">{{ pattern.type }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- HIPAA Compliance Information -->
<div class="row g-4 mt-2">
    <div class="col-12">
        <div class="admin-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    HIPAA Compliance Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <h6 class="text-primary">Protected Health Information (PHI)</h6>
                        <p class="text-muted mb-3">
                            PHI includes any individually identifiable health information that is transmitted or maintained in any form. 
                            This system automatically identifies and redacts common PHI patterns.
                        </p>
                        
                        <h6 class="text-primary">Filtering Patterns</h6>
                        <ul class="text-muted">
                            <li><strong>SSN:</strong> Social Security Numbers (XXX-XX-XXXX)</li>
                            <li><strong>Phone:</strong> Phone numbers in various formats</li>
                            <li><strong>MRN:</strong> Medical record numbers and patient IDs</li>
                            <li><strong>Address:</strong> Street addresses and ZIP codes</li>
                            <li><strong>Email:</strong> Email addresses containing personal information</li>
                            <li><strong>Dates:</strong> Birth dates and sensitive dates (use with caution)</li>
                        </ul>
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-warning">Important Considerations</h6>
                        <div class="alert alert-warning border-0">
                            <ul class="mb-0">
                                <li><strong>Date Filtering:</strong> Use carefully as it may remove medically relevant dates</li>
                                <li><strong>Medical Values:</strong> System preserves clinical values like lab results and vital signs</li>
                                <li><strong>Audit Trail:</strong> All PHI filtering activities are logged for compliance</li>
                                <li><strong>False Positives:</strong> Manual review recommended for critical documents</li>
                            </ul>
                        </div>
                        
                        <h6 class="text-success">Compliance Features</h6>
                        <ul class="text-muted">
                            <li>Real-time PHI detection and redaction</li>
                            <li>Comprehensive audit logging</li>
                            <li>Configurable pattern matching</li>
                            <li>Medical data preservation</li>
                            <li>Before/after comparison tracking</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% extends 'base_admin.html' %}

{% block title %}Document Inventory - HealthPrep{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="fas fa-folder-open me-2"></i>
                Document Inventory
            </h2>
            <p class="text-muted mb-0">Per-patient document overview for Epic authorization testing</p>
        </div>
        <div>
            <span class="badge bg-info fs-6">
                <i class="fas fa-building me-1"></i>
                {{ total_patients or 0 }} patients in organization
            </span>
        </div>
    </div>

    {% if not patient_data %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        No patients found in your organization. Documents will appear here once patients are added.
    </div>
    {% else %}

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ total_patients or 0 }}</h4>
                            <p class="card-text">Total Patients</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ patient_data | sum(attribute='total_documents') if patient_data else 0 }}</h4>
                            <p class="card-text">Total Documents</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ patient_data | sum(attribute='documents_with_ocr') if patient_data else 0 }}</h4>
                            <p class="card-text">OCR Processed</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-eye fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">{{ (patient_data | selectattr('conditions') | list) | length if patient_data else 0 }}</h4>
                            <p class="card-text">With Conditions</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-heartbeat fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Document Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>Per-Patient Document Inventory
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>Patient</th>
                            <th>Age/Gender</th>
                            <th>Medical Conditions</th>
                            <th>Total Docs</th>
                            <th>OCR Processed</th>
                            <th>Document Types</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for data in patient_data %}
                        <tr>
                            <td>
                                <strong>{{ data.patient.name }}</strong>
                                <br>
                                <small class="text-muted">ID: {{ data.patient.id }}</small>
                            </td>
                            <td>
                                {% if data.patient.date_of_birth %}
                                    {{ ((current_date - data.patient.date_of_birth).days // 365) }}y
                                {% else %}
                                    Unknown age
                                {% endif %}, 
                                {{ data.patient.gender | title }}
                            </td>
                            <td>
                                {% if data.conditions %}
                                    {% for condition in data.conditions %}
                                        <span class="badge bg-secondary me-1 mb-1">{{ condition }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">None recorded</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-primary fs-6">{{ data.total_documents }}</span>
                            </td>
                            <td>
                                {% if data.documents_with_ocr > 0 %}
                                    <span class="badge bg-success fs-6">{{ data.documents_with_ocr }}</span>
                                {% else %}
                                    <span class="badge bg-warning fs-6">0</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if data.document_counts %}
                                    {% for doc_type, count in data.document_counts.items() %}
                                        <span class="badge bg-info me-1 mb-1">{{ doc_type }}: {{ count }}</span>
                                    {% endfor %}
                                    <br>
                                    <small class="text-muted mt-1">
                                        Manual: {{ data.source_counts.get('Manual', 0) }} | 
                                        Epic FHIR: {{ data.source_counts.get('Epic FHIR', 0) }}
                                    </small>
                                {% else %}
                                    <span class="text-muted">No documents</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#documents-{{ data.patient.id }}" 
                                        aria-expanded="false">
                                    <i class="fas fa-eye"></i> View Docs
                                </button>
                            </td>
                        </tr>
                        <!-- Document Details Row (Collapsible) -->
                        <tr class="collapse" id="documents-{{ data.patient.id }}">
                            <td colspan="7">
                                <div class="card bg-dark border-secondary">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-file-alt me-2"></i>Documents for {{ data.patient.name }}
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {% if data.documents %}
                                            <div class="row">
                                                {% for doc in data.documents %}
                                                <div class="col-md-6 col-lg-4 mb-3">
                                                    <div class="card bg-secondary">
                                                        <div class="card-body">
                                                            <h6 class="card-title">
                                                                <i class="fas fa-file me-1"></i>{{ doc.title or 'Untitled Document' }}
                                                                <span class="badge bg-{{ doc.source_badge }} ms-2">{{ doc.source }}</span>
                                                            </h6>
                                                            <p class="card-text small">
                                                                <strong>Type:</strong> {{ doc.document_type or 'Unknown' }}<br>
                                                                <strong>Date:</strong> {{ doc.document_date.strftime('%Y-%m-%d') if doc.document_date else 'Not set' }}<br>
                                                                {% if doc.epic_id %}
                                                                    <strong>Epic ID:</strong> <code class="text-light">{{ doc.epic_id }}</code><br>
                                                                {% endif %}
                                                                <strong>Source:</strong> 
                                                                <span class="badge bg-{{ doc.source_badge }}">{{ doc.source }}</span>
                                                            </p>
                                                            
                                                            <!-- Active Screening Matches -->
                                                            {% if doc.active_matches %}
                                                                <div class="mb-2">
                                                                    <small class="text-info"><i class="fas fa-check-circle me-1"></i>Active Matches ({{ doc.active_matches|length }}):</small>
                                                                    <div class="mt-1">
                                                                        {% for match in doc.active_matches %}
                                                                        <div class="d-inline-block me-1 mb-1">
                                                                            <div class="badge bg-info" style="font-size: 0.75rem;">
                                                                                {{ match.screening_name }} 
                                                                                <span class="badge bg-light text-dark ms-1">{{ (match.confidence * 100)|round }}%</span>
                                                                                <button class="btn btn-xs btn-link text-white p-0 ms-1" 
                                                                                        onclick="dismissMatch({{ doc.id }}, {{ match.screening_id }}, '{{ doc.source }}', '{{ doc.title }}', '{{ match.screening_name }}')"
                                                                                        title="Dismiss this match (false positive)">
                                                                                    <i class="fas fa-times"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        {% endfor %}
                                                                    </div>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            <!-- Dismissed Matches (Collapsible) -->
                                                            {% if doc.dismissed_matches %}
                                                                <div class="mb-2">
                                                                    <button class="btn btn-sm btn-link text-muted p-0" 
                                                                            type="button" 
                                                                            data-bs-toggle="collapse" 
                                                                            data-bs-target="#dismissed-{{ data.patient.id }}-{{ loop.index }}" 
                                                                            aria-expanded="false">
                                                                        <i class="fas fa-ban me-1"></i>Dismissed Matches ({{ doc.dismissed_matches|length }}) - Click to view
                                                                    </button>
                                                                    <div class="collapse mt-1" id="dismissed-{{ data.patient.id }}-{{ loop.index }}">
                                                                        {% for match in doc.dismissed_matches %}
                                                                        <div class="d-inline-block me-1 mb-1">
                                                                            <div class="badge bg-secondary" style="font-size: 0.75rem; opacity: 0.7;">
                                                                                <i class="fas fa-ban me-1"></i>{{ match.screening_name }}
                                                                                {% if match.dismissal_reason %}
                                                                                <span class="badge bg-dark ms-1" title="{{ match.dismissal_reason }}">Reason</span>
                                                                                {% endif %}
                                                                                <button class="btn btn-xs btn-link text-white p-0 ms-1" 
                                                                                        onclick="restoreMatch({{ match.dismissal_id }}, '{{ doc.title }}', '{{ match.screening_name }}')"
                                                                                        title="Restore this match">
                                                                                    <i class="fas fa-undo"></i>
                                                                                </button>
                                                                            </div>
                                                                        </div>
                                                                        {% endfor %}
                                                                    </div>
                                                                </div>
                                                            {% endif %}
                                                            
                                                            <!-- OCR Status -->
                                                            {% if doc.ocr_text %}
                                                                <div class="mb-2">
                                                                    <span class="badge bg-success">
                                                                        <i class="fas fa-eye me-1"></i>OCR Processed
                                                                    </span>
                                                                </div>
                                                                
                                                                <!-- OCR Preview with Keyword Highlighting -->
                                                                <div class="mt-2">
                                                                    <small class="text-muted">OCR Preview:</small>
                                                                    <div class="bg-dark p-2 rounded mt-1" style="max-height: 100px; overflow-y: auto;">
                                                                        <small class="text-light">{{ doc.ocr_text[:200] }}{% if doc.ocr_text|length > 200 %}...{% endif %}</small>
                                                                    </div>
                                                                    
                                                                    {% if doc.ocr_text|length > 200 %}
                                                                    <!-- Full OCR Text with Keyword Highlighting (Collapsible) -->
                                                                    <div class="mt-2">
                                                                        <button class="btn btn-xs btn-outline-info" 
                                                                                type="button" 
                                                                                data-bs-toggle="collapse" 
                                                                                data-bs-target="#fullOcr-{{ data.patient.id }}-{{ loop.index }}" 
                                                                                aria-expanded="false">
                                                                            <i class="fas fa-search-plus me-1"></i>View Full OCR Text ({{ doc.ocr_text|length }} chars)
                                                                        </button>
                                                                        <div class="collapse mt-2" id="fullOcr-{{ data.patient.id }}-{{ loop.index }}">
                                                                            <div class="bg-dark p-3 rounded border border-info" style="max-height: 400px; overflow-y: auto;">
                                                                                <div class="d-flex justify-content-between mb-2">
                                                                                    <small class="text-info"><i class="fas fa-file-text me-1"></i>Complete OCR Text for {{ doc.title or 'Document' }}</small>
                                                                                    <small class="text-muted">{{ doc.ocr_text|length }} characters | Source: {{ doc.source }}</small>
                                                                                </div>
                                                                                {% if doc.active_matches or doc.dismissed_matches %}
                                                                                <div class="mb-2">
                                                                                    <small class="text-warning"><i class="fas fa-highlighter me-1"></i>Highlighted keywords:</small>
                                                                                    {% for match in doc.active_matches + doc.dismissed_matches %}
                                                                                        {% for keyword in match.matched_keywords %}
                                                                                        <span class="badge bg-warning text-dark me-1" style="font-size: 0.7rem;">{{ keyword }}</span>
                                                                                        {% endfor %}
                                                                                    {% endfor %}
                                                                                </div>
                                                                                {% endif %}
                                                                                <pre class="text-light mb-0 ocr-text-highlight" 
                                                                                     style="font-size: 0.8rem; white-space: pre-wrap; word-wrap: break-word;"
                                                                                     data-keywords='{{ (doc.active_matches + doc.dismissed_matches)|tojson|safe if (doc.active_matches or doc.dismissed_matches) else "[]" }}'>{{ doc.ocr_text }}</pre>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            {% else %}
                                                                <span class="badge bg-warning">
                                                                    <i class="fas fa-eye-slash me-1"></i>No OCR
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <p class="text-muted">No documents found for this patient.</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Testing Notes -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-flask me-2"></i>Fuzzy Detection Testing Notes
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <h6><i class="fas fa-lightbulb me-2"></i>Available Test Conditions</h6>
                <p class="mb-2">Based on your sandbox patients, you can test fuzzy detection with these medical conditions:</p>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><span class="badge bg-primary me-2">polycystic ovarian syndrome</span> - Test PCOS variations</li>
                            <li><span class="badge bg-primary me-2">risk factors</span> - Test risk-based screening triggers</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><span class="badge bg-primary me-2">asthma & bronchitis</span> - Test respiratory condition detection</li>
                            <li><span class="badge bg-primary me-2">heart disease</span> - Test cardiac condition synonyms</li>
                        </ul>
                    </div>
                </div>
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Look for documents containing medical terminology related to these conditions to verify fuzzy detection accuracy.
                </small>
            </div>
        </div>
    </div>

    {% endif %}
</div>

<script>
// Dismiss a document-screening match
function dismissMatch(docId, screeningId, source, docTitle, screeningName) {
    const reason = prompt(`Dismiss match: "${docTitle}" → "${screeningName}"?\n\nOptional: Enter reason for dismissal (or leave blank):`);
    
    // User cancelled
    if (reason === null) return;
    
    const formData = new FormData();
    if (source === 'Epic FHIR') {
        formData.append('fhir_document_id', docId);
    } else {
        formData.append('document_id', docId);
    }
    formData.append('screening_id', screeningId);
    if (reason.trim()) {
        formData.append('reason', reason.trim());
    }
    
    fetch('/admin/documents/dismiss-match', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Match dismissed successfully');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to dismiss match');
    });
}

// Restore a dismissed match
function restoreMatch(dismissalId, docTitle, screeningName) {
    if (!confirm(`Restore match: "${docTitle}" → "${screeningName}"?`)) {
        return;
    }
    
    const formData = new FormData();
    formData.append('dismissal_id', dismissalId);
    
    fetch('/admin/documents/restore-match', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Match restored successfully');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to restore match');
    });
}

// Keyword highlighting in OCR text
document.addEventListener('DOMContentLoaded', function() {
    // Find all OCR text elements with keywords
    const ocrElements = document.querySelectorAll('.ocr-text-highlight');
    
    ocrElements.forEach(element => {
        const keywordsData = element.getAttribute('data-keywords');
        if (!keywordsData || keywordsData === '[]') return;
        
        try {
            const matchDetails = JSON.parse(keywordsData);
            if (!matchDetails || matchDetails.length === 0) return;
            
            // Collect all unique keywords from all matches
            const allKeywords = new Set();
            matchDetails.forEach(match => {
                if (match.matched_keywords) {
                    match.matched_keywords.forEach(kw => allKeywords.add(kw));
                }
            });
            
            if (allKeywords.size === 0) return;
            
            // Get the original text
            let text = element.textContent;
            
            // Sort keywords by length (longest first) to avoid partial matches
            const sortedKeywords = Array.from(allKeywords).sort((a, b) => b.length - a.length);
            
            // Create highlighted text
            sortedKeywords.forEach(keyword => {
                // Handle multi-word keywords
                const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const pattern = new RegExp(`\\b(${escapedKeyword})\\b`, 'gi');
                
                // Replace with highlighted version
                text = text.replace(pattern, '<mark style="background-color: #ffc107; color: #000; padding: 1px 3px; border-radius: 2px;">$1</mark>');
            });
            
            // Update the element HTML
            element.innerHTML = text;
            
        } catch (e) {
            console.error('Error highlighting keywords:', e);
        }
    });
});
</script>
{% endblock %}
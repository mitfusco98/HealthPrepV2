{% extends 'base_admin.html' %}

{% block title %}Admin Logs - HealthPrep{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-list-ul me-2"></i>Activity Logs</h1>
    <div>
        <button class="btn btn-outline-success btn-sm me-2" onclick="exportLogs()">
            <i class="fas fa-download me-1"></i>Export
        </button>
        <button class="btn btn-outline-primary btn-sm" onclick="location.reload()">
            <i class="fas fa-sync me-1"></i>Refresh
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-filter me-2"></i>
            Filter Logs
        </h5>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin.logs') }}" class="row g-3">
            <div class="col-md-3">
                <label for="event_type" class="form-label">Event Type</label>
                <select class="form-select" id="event_type" name="event_type">
                    <option value="">All Events</option>
                    {% for event_type in event_types %}
                    <option value="{{ event_type }}" {{ 'selected' if filters.event_type == event_type }}>{{ event_type.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="user_id" class="form-label">User</label>
                <select class="form-select" id="user_id" name="user_id">
                    <option value="">All Users</option>
                    {% for user in users %}
                    <option value="{{ user.id }}" {{ 'selected' if filters.user_id == user.id }}>{{ user.username }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="start_date" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="start_date" name="start_date" value="{{ filters.start_date or '' }}">
            </div>
            <div class="col-md-3">
                <label for="end_date" class="form-label">End Date</label>
                <input type="date" class="form-control" id="end_date" name="end_date" value="{{ filters.end_date or '' }}">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-1"></i>Apply Filters
                </button>
                <a href="{{ url_for('admin.logs') }}" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-times me-1"></i>Clear Filters
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Logs Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Activity History</h5>
        <small class="text-muted">
            {% if pagination %}
            Page {{ pagination.page }} of {{ pagination.pages }} 
            ({{ pagination.total }} total entries)
            {% else %}
            {{ logs|length }} entries
            {% endif %}
        </small>
    </div>
    <div class="card-body p-0">
        {% if logs %}
            <div class="table-responsive">
                <table id="logsTable" class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Event Type</th>
                            <th>User</th>
                            <th>IP Address</th>
                            <th>Details</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td>
                                <div class="text-nowrap">
                                    <small class="text-muted">{{ log.timestamp.strftime('%Y-%m-%d') }}</small><br>
                                    <strong>{{ log.timestamp.strftime('%H:%M:%S') }}</strong>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-primary">
                                    {{ log.event_type.replace('_', ' ').title() if log.event_type else 'Unknown' }}
                                </span>
                            </td>
                            <td>
                                {% if log.user %}
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user me-1 text-muted"></i>
                                        {{ log.user.username }}
                                        {% if log.user.is_admin %}
                                            <i class="fas fa-crown text-warning ms-1" title="Admin"></i>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <span class="text-muted">System</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted font-monospace">{{ log.ip_address or 'N/A' }}</small>
                            </td>
                            <td>
                                {% if log.data %}
                                    <div class="text-truncate" style="max-width: 300px;" 
                                         title="{{ log.data.get('description', '') or log.data | tojsonpretty }}">
                                        {{ log.data.get('description', '') or 'View details' }}
                                    </div>
                                {% else %}
                                    <span class="text-muted">No details</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-outline-info btn-sm" 
                                        onclick="viewLogDetails({{ log.id }})"
                                        data-log="{{ log.data | tojsonpretty if log.data else '{}' }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center text-muted py-5">
                <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Log Entries Found</h5>
                <p class="text-muted">No administrative actions match the current filters</p>
                <a href="{{ url_for('admin.logs') }}" class="btn btn-outline-primary">
                    <i class="fas fa-times me-1"></i>Clear Filters
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Pagination -->
{% if logs.pages > 1 %}
<nav aria-label="Log pagination" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if logs.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin_logs', page=logs.prev_num, **current_filters) }}">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
            </li>
        {% endif %}
        
        {% for page_num in logs.iter_pages() %}
            {% if page_num %}
                {% if page_num != logs.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_logs', page=page_num, **current_filters) }}">
                            {{ page_num }}
                        </a>
                    </li>
                {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                {% endif %}
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if logs.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('admin_logs', page=logs.next_num, **current_filters) }}">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="logDetailsContent">
                    <!-- Details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- DataTables JavaScript -->
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTables
    var table = $('#logsTable').DataTable({
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
        order: [[0, 'desc']], // Sort by timestamp descending
        columnDefs: [
            { orderable: false, targets: [5] }, // Actions column
            { width: "15%", targets: [0] }, // Timestamp
            { width: "12%", targets: [1] }, // Event Type
            { width: "12%", targets: [2] }, // User
            { width: "12%", targets: [3] }, // IP
            { width: "40%", targets: [4] }, // Details
            { width: "9%", targets: [5] }   // Actions
        ],
        dom: 'Blfrtip',
        buttons: [
            {
                extend: 'excel',
                text: 'Export to Excel',
                className: 'btn btn-success btn-sm'
            },
            {
                extend: 'csv',
                text: 'Export to CSV',
                className: 'btn btn-info btn-sm'
            }
        ],
        responsive: true
    });
});

function exportLogs() {
    if (confirm('Export activity logs to JSON file?')) {
        window.location.href = "{{ url_for('admin.export_logs') }}";
    }
}

// Function to view log details
function viewLogDetails(logId) {
    var logData = event.target.closest('button').getAttribute('data-log');
    try {
        var details = JSON.parse(logData);
        var html = '<div class="table-responsive"><table class="table table-sm">';
        
        for (var key in details) {
            if (details.hasOwnProperty(key)) {
                html += '<tr><td><strong>' + key + ':</strong></td><td>' + details[key] + '</td></tr>';
            }
        }
        
        html += '</table></div>';
        
        if (Object.keys(details).length === 0) {
            html = '<p class="text-muted">No additional details available for this log entry.</p>';
        }
        
        $('#logDetailsContent').html(html);
        $('#logDetailsModal').modal('show');
    } catch (e) {
        $('#logDetailsContent').html('<p class="text-danger">Error parsing log details.</p>');
        $('#logDetailsModal').modal('show');
    }
}
</script>
{% endblock %}

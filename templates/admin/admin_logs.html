{% extends 'base_admin.html' %}

{% block title %}Admin Logs - HealthPrep{% endblock %}

{% block extra_css %}
<style>
.log-filters {
    background-color: rgba(0,0,0,0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.log-entry {
    border-left: 4px solid;
    padding-left: 1rem;
}

.log-entry.log-success {
    border-left-color: #28a745;
}

.log-entry.log-warning {
    border-left-color: #ffc107;
}

.log-entry.log-error {
    border-left-color: #dc3545;
}

.log-entry.log-info {
    border-left-color: #17a2b8;
}

.log-details {
    max-width: 300px;
    word-wrap: break-word;
}

.loading-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-history me-2"></i>
        Admin Audit Logs
    </h1>
    <div class="btn-group">
        <a href="{{ url_for('admin.export_logs') }}" class="btn btn-outline-success">
            <i class="fas fa-download me-1"></i>
            Export Logs
        </a>
        <button type="button" class="btn btn-outline-danger" onclick="showCleanupModal()">
            <i class="fas fa-trash me-1"></i>
            Cleanup Old Logs
        </button>
    </div>
</div>

<!-- Log Statistics -->
{% if log_stats %}
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4>{{ log_stats.total_logs or 0 }}</h4>
                <small>Total Logs</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4>{{ log_stats.recent_24h or 0 }}</h4>
                <small>Last 24 Hours</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4>{{ log_stats.top_users|length or 0 }}</h4>
                <small>Active Users</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center">
                <h4>{{ log_stats.action_breakdown|length or 0 }}</h4>
                <small>Action Types</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Filters -->
<div class="log-filters">
    <form method="GET" id="filterForm">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Event Type</label>
                <select name="event_type" class="form-select">
                    <option value="">All Event Types</option>
                    {% for event_type in event_types %}
                        <option value="{{ event_type }}" 
                                {{ 'selected' if filters.event_type == event_type else '' }}>
                            {{ event_type.replace('_', ' ').title() }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">User</label>
                <select name="user_id" class="form-select">
                    <option value="">All Users</option>
                    {% for user in users %}
                        <option value="{{ user.id }}" 
                                {{ 'selected' if filters.user_id == user.id else '' }}>
                            {{ user.username }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Date From</label>
                <input type="date" name="date_from" class="form-control" 
                       value="{{ filters.date_from.strftime('%Y-%m-%d') if filters.date_from else '' }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">Date To</label>
                <input type="date" name="date_to" class="form-control" 
                       value="{{ filters.date_to.strftime('%Y-%m-%d') if filters.date_to else '' }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>
                        Apply Filters
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Logs Table -->
<div class="card">
    <div class="card-body position-relative">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
        
        {% if logs and logs.items %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Action</th>
                            <th>Resource</th>
                            <th>Details</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs.items %}
                        <tr class="log-entry log-{{ 'error' if 'ERROR' in log.action else 'success' if 'CREATE' in log.action else 'warning' if 'UPDATE' in log.action or 'DELETE' in log.action else 'info' }}">
                            <td>
                                <small>{{ log.timestamp.strftime('%m/%d/%Y %H:%M:%S') }}</small>
                            </td>
                            <td>
                                {% if log.user %}
                                    <strong>{{ log.user.username }}</strong>
                                    {% if log.user.role == 'admin' %}
                                        <span class="badge bg-danger">Admin</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">System</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{% if 'ERROR' in log.action %}danger{% elif 'CREATE' in log.action %}success{% elif 'UPDATE' in log.action or 'DELETE' in log.action %}warning{% elif 'LOGIN' in log.action %}info{% else %}secondary{% endif %}">
                                    {{ log.action.replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td>
                                {% if log.resource_type %}
                                    {{ log.resource_type.replace('_', ' ').title() }}
                                    {% if log.resource_id %}
                                        <small class="text-muted">#{{ log.resource_id }}</small>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="log-details">
                                {% if log.details %}
                                    <small>{{ log.details[:100] }}{% if log.details|length > 100 %}...{% endif %}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.ip_address %}
                                    <small class="font-monospace">{{ log.ip_address }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if logs.pages > 1 %}
                <nav aria-label="Log pagination">
                    <ul class="pagination justify-content-center">
                        {% if logs.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.logs', page=logs.prev_num, **filters) }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in logs.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != logs.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('admin.logs', page=page_num, **filters) }}">{{ page_num }}</a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">…</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if logs.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.logs', page=logs.next_num, **filters) }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="alert alert-info">
                <h6 class="alert-heading">No Logs Found</h6>
                <p class="mb-0">
                    {% if filters.event_type or filters.user_id or filters.date_from or filters.date_to %}
                        No logs match your current filters. Try adjusting your search criteria.
                    {% else %}
                        No audit logs are available yet.
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Action Breakdown -->
{% if log_stats and log_stats.action_breakdown %}
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Action Breakdown</h6>
            </div>
            <div class="card-body">
                {% for action, count in log_stats.action_breakdown.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ action.replace('_', ' ').title() }}</span>
                        <span class="badge bg-secondary">{{ count }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Top Users</h6>
            </div>
            <div class="card-body">
                {% for user in log_stats.top_users %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ user.username }}</span>
                        <span class="badge bg-primary">{{ user.count }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Show loading overlay when filtering
document.getElementById('filterForm').addEventListener('submit', function() {
    document.getElementById('loadingOverlay').style.display = 'flex';
});

function showCleanupModal() {
    if (confirm('This will permanently delete audit logs older than 7 years. This action cannot be undone. Continue?')) {
        // Implement cleanup functionality
        alert('Log cleanup functionality would be implemented here.');
    }
}
</script>
{% endblock %}

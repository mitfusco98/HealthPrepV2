{% extends 'base_demo.html' %}

{% block title %}HealthPrep - Screening List{% endblock %}

{% block extra_css %}
<style>
/* Confidence-based color coding for document links */
.confidence-high {
    color: #155724 !important;
    background-color: #d4edda !important;
    border: 1px solid #c3e6cb !important;
}

.confidence-medium {
    color: #856404 !important;
    background-color: #fff3cd !important;
    border: 1px solid #ffeaa7 !important;
}

.confidence-low {
    color: #721c24 !important;
    background-color: #f8d7da !important;
    border: 1px solid #f5c6cb !important;
}

.confidence-high:hover, .confidence-medium:hover, .confidence-low:hover {
    opacity: 0.8;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

/* Document confidence legend */
.confidence-legend {
    font-size: 0.85em;
    margin-bottom: 10px;
}

.confidence-legend .badge {
    margin-right: 8px;
}

/* Tab content styling */
.tab-content {
    border: 1px solid var(--bs-border-color);
    border-top: none;
    border-radius: 0 0 8px 8px;
    padding: 1.5rem;
    background-color: var(--bs-body-bg);
}

/* Keywords display */
.keywords-badges-container {
    line-height: 1.5;
}

.keywords-badges-container .badge {
    font-size: 0.75rem;
    margin-bottom: 2px;
}

/* Screening status styling */
.status-due {
    background-color: var(--medical-red) !important;
    color: white !important;
}

.status-due-soon {
    background-color: var(--medical-amber) !important;
    color: white !important;
}

.status-complete {
    background-color: var(--medical-green) !important;
    color: white !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-list-check medical-icon"></i>
                Screening Management
            </h2>
            <p class="text-muted mb-0">Manage patient screenings, types, and settings</p>
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary" onclick="showUploadModal()">
                <i class="fas fa-upload me-2"></i>Upload Document
            </button>
            <button type="button" class="btn btn-medical refresh-screenings-btn" data-refresh-type="all">
                <i class="fas fa-sync-alt me-2"></i>Refresh All
            </button>
        </div>
    </div>

    <!-- Document Confidence Legend -->
    <div class="confidence-legend">
        <span class="badge confidence-high">High Confidence (90%+)</span>
        <span class="badge confidence-medium">Medium Confidence (70-89%)</span>
        <span class="badge confidence-low">Low Confidence (<70%)</span>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="screeningTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button" role="tab">
                <i class="fas fa-list me-2"></i>Screening List
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="types-tab" data-bs-toggle="tab" data-bs-target="#types-pane" type="button" role="tab">
                <i class="fas fa-cogs me-2"></i>Screening Types
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane" type="button" role="tab">
                <i class="fas fa-sliders-h me-2"></i>Settings
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="screeningTabContent">
        
        <!-- Screening List Tab -->
        <div class="tab-pane fade show active" id="list-pane" role="tabpanel">
            <!-- Filters -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label for="patientSearch" class="form-label">Patient Search</label>
                    <input type="text" class="form-control" id="patientSearch" placeholder="Search by patient name...">
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Status Filter</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="Due">Due</option>
                        <option value="Due Soon">Due Soon</option>
                        <option value="Complete">Complete</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="typeFilter" class="form-label">Type Filter</label>
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        {% for screening_type in screening_types %}
                        <option value="{{ screening_type.name }}">{{ screening_type.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-2"></i>Clear
                    </button>
                </div>
            </div>

            <!-- Screening Table -->
            <div class="table-responsive">
                <table class="table table-hover" id="screeningTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAll"></th>
                            <th>Patient</th>
                            <th>Screening Type</th>
                            <th>Status</th>
                            <th>Last Completed</th>
                            <th>Frequency</th>
                            <th>Next Due</th>
                            <th>Matched Documents</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for screening in screenings %}
                        <tr data-screening-id="{{ screening.id }}">
                            <td><input type="checkbox" class="screening-checkbox"></td>
                            <td class="patient-name">
                                {{ screening.patient.first_name }} {{ screening.patient.last_name }}
                                <small class="text-muted d-block">{{ screening.patient.mrn }}</small>
                            </td>
                            <td class="screening-type">{{ screening.screening_type.name }}</td>
                            <td>
                                <span class="badge status-{{ screening.status.lower().replace(' ', '-') }}">
                                    {{ screening.status }}
                                </span>
                            </td>
                            <td>
                                {% if screening.last_completed_date %}
                                    {{ screening.last_completed_date.strftime('%m/%d/%Y') }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                Every {{ screening.screening_type.frequency_value }} 
                                {{ screening.screening_type.frequency_unit }}
                            </td>
                            <td>
                                {% if screening.next_due_date %}
                                    {{ screening.next_due_date.strftime('%m/%d/%Y') }}
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if screening.matched_documents %}
                                    {% for doc_id in screening.matched_documents %}
                                        {% set doc = documents_by_id.get(doc_id) %}
                                        {% if doc %}
                                            <a href="#" class="document-link confidence-{{ 'high' if doc.confidence_score >= 0.9 else 'medium' if doc.confidence_score >= 0.7 else 'low' }}" 
                                               data-document-id="{{ doc.id }}" onclick="viewDocument({{ doc.id }})">
                                                {{ doc.filename }}
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">None</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary" onclick="generatePrepSheet({{ screening.patient.id }})">
                                        <i class="fas fa-file-medical"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary refresh-screenings-btn" 
                                            data-refresh-type="patient" data-patient-id="{{ screening.patient.id }}">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Batch Actions -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <button type="button" class="btn btn-outline-primary batch-action-btn" data-action="refresh" disabled>
                        <i class="fas fa-sync-alt me-2"></i>Refresh Selected
                    </button>
                    <button type="button" class="btn btn-outline-secondary batch-action-btn" data-action="export" disabled>
                        <i class="fas fa-download me-2"></i>Export Selected
                    </button>
                </div>
                <div id="resultsCount" class="text-muted small">
                    Showing {{ screenings|length }} screenings
                </div>
            </div>
        </div>

        <!-- Screening Types Tab -->
        <div class="tab-pane fade" id="types-pane" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>Screening Types Management</h4>
                <button type="button" class="btn btn-medical" data-bs-toggle="modal" data-bs-target="#addScreeningTypeModal">
                    <i class="fas fa-plus me-2"></i>Add Screening Type
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Keywords</th>
                            <th>Eligibility</th>
                            <th>Frequency</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for screening_type in screening_types %}
                        <tr>
                            <td>
                                <strong>{{ screening_type.name }}</strong>
                                {% if screening_type.trigger_conditions %}
                                    <br><small class="text-muted">
                                        Triggers: {{ screening_type.trigger_conditions|join(', ') }}
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="keywords-badges-container" id="keywords-display-{{ screening_type.id }}">
                                    <!-- Keywords will be loaded via JavaScript -->
                                </div>
                            </td>
                            <td>
                                <small>
                                    {% if screening_type.gender_requirements %}
                                        Gender: {{ screening_type.gender_requirements|join(', ') }}<br>
                                    {% endif %}
                                    {% if screening_type.age_min or screening_type.age_max %}
                                        Age: {{ screening_type.age_min or 'Any' }}-{{ screening_type.age_max or 'Any' }}
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                Every {{ screening_type.frequency_value }} 
                                {{ screening_type.frequency_unit }}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if screening_type.is_active else 'secondary' }}">
                                    {{ 'Active' if screening_type.is_active else 'Inactive' }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary edit-screening-btn" 
                                            data-screening-id="{{ screening_type.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary refresh-screenings-btn" 
                                            data-refresh-type="type" data-screening-type-id="{{ screening_type.id }}">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger delete-screening-btn" 
                                            data-screening-id="{{ screening_type.id }}" 
                                            data-screening-name="{{ screening_type.name }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Settings Tab -->
        <div class="tab-pane fade" id="settings-pane" role="tabpanel">
            <h4 class="mb-4">Screening Settings</h4>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-clock me-2"></i>Data Cutoff Settings
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">Configure how far back to look for medical data in prep sheets.</p>
                            
                            <a href="{{ url_for('prep_sheet.settings') }}" class="btn btn-outline-primary">
                                <i class="fas fa-cog me-2"></i>Configure Prep Sheet Settings
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-download me-2"></i>Import/Export
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small">Import screening presets or export current configuration.</p>
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-success" onclick="importPresets()">
                                    <i class="fas fa-upload me-2"></i>Import Presets
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="exportConfiguration()">
                                    <i class="fas fa-download me-2"></i>Export Configuration
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Screening Type Modal -->
<div class="modal fade" id="addScreeningTypeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add Screening Type
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('screening.add_type') }}" method="post" id="addScreeningTypeForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="screeningName" class="form-label">Screening Name *</label>
                                <input type="text" class="form-control medical-autocomplete" 
                                       id="screeningName" name="name" data-type="screeningTypes" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Gender Requirements</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="gender_requirements" value="Male" id="genderMale">
                                        <label class="form-check-label" for="genderMale">Male</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="gender_requirements" value="Female" id="genderFemale">
                                        <label class="form-check-label" for="genderFemale">Female</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="gender_requirements" value="All" id="genderAll" checked>
                                        <label class="form-check-label" for="genderAll">All</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ageMin" class="form-label">Minimum Age</label>
                                <input type="number" class="form-control" id="ageMin" name="age_min" min="0" max="150">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ageMax" class="form-label">Maximum Age</label>
                                <input type="number" class="form-control" id="ageMax" name="age_max" min="0" max="150">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="frequencyValue" class="form-label">Frequency Value *</label>
                                <input type="number" class="form-control" id="frequencyValue" name="frequency_value" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="frequencyUnit" class="form-label">Frequency Unit *</label>
                                <select class="form-select" id="frequencyUnit" name="frequency_unit" required>
                                    <option value="">Select unit...</option>
                                    <option value="months">Months</option>
                                    <option value="years">Years</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="keywords" class="form-label">Keywords</label>
                        <input type="text" class="form-control keywords-input medical-autocomplete" 
                               id="keywords" placeholder="Type keywords and press Enter" data-type="screeningTypes">
                        <div class="form-text">Enter keywords that identify this screening in documents. Press Enter or comma to add.</div>
                        <div class="keywords-badges mt-2"></div>
                        <input type="hidden" name="keywords">
                    </div>
                    
                    <div class="mb-3">
                        <label for="triggerConditions" class="form-label">Trigger Conditions</label>
                        <input type="text" class="form-control keywords-input medical-autocomplete" 
                               id="triggerConditions" placeholder="Type conditions and press Enter" data-type="conditions">
                        <div class="form-text">Medical conditions that trigger this screening. Press Enter or comma to add.</div>
                        <div class="keywords-badges mt-2"></div>
                        <input type="hidden" name="trigger_conditions">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-medical">
                        <span class="btn-text">Add Screening Type</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Document Upload Modal -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Upload Document
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('screening.upload_document') }}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="patientSelectUpload" class="form-label">Patient *</label>
                        <select class="form-select" id="patientSelectUpload" name="patient_id" required>
                            <option value="">Select patient...</option>
                            {% for patient in patients %}
                            <option value="{{ patient.id }}">
                                {{ patient.first_name }} {{ patient.last_name }} ({{ patient.mrn }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="documentFile" class="form-label">Document File *</label>
                        <input type="file" class="form-control" id="documentFile" name="document" 
                               accept=".pdf,.jpg,.jpeg,.png,.tiff,.txt" required>
                        <div class="form-text">Supported formats: PDF, Images (JPG, PNG, TIFF), Text files</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-medical">
                        <span class="btn-text">Upload & Process</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Document Viewer Modal -->
<div class="modal fade" id="viewDocumentModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Document Viewer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Action Modal -->
<div class="modal fade" id="confirmActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Action
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include screening modals JavaScript -->
<script src="{{ url_for('static', filename='js/screening_modals.js') }}"></script>

<!-- Include performance optimization JavaScript -->
<script src="{{ url_for('static', filename='js/screening_performance.js') }}"></script>

<script>
// Additional functionality specific to screening list page

function clearFilters() {
    document.getElementById('patientSearch').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('typeFilter').value = '';
    
    // Trigger filter application
    if (window.screeningPerformance) {
        window.screeningPerformance.applyFilters();
    }
}

function showUploadModal() {
    const modal = new bootstrap.Modal(document.getElementById('uploadDocumentModal'));
    modal.show();
}

function viewDocument(documentId) {
    if (window.screeningModals) {
        window.screeningModals.openDocumentViewer(documentId);
    }
}

function generatePrepSheet(patientId) {
    window.location.href = `/prep/generate/${patientId}`;
}

function importPresets() {
    // Create file input for importing presets
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';
    fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('presets_file', file);
            
            fetch('/screening/import-presets', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    HealthPrep.showToast('Presets imported successfully', 'success');
                    location.reload();
                } else {
                    HealthPrep.showToast(data.message || 'Error importing presets', 'error');
                }
            })
            .catch(error => {
                console.error('Import error:', error);
                HealthPrep.showToast('Error importing presets', 'error');
            });
        }
    };
    
    fileInput.click();
}

function exportConfiguration() {
    fetch('/screening/export-configuration')
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `screening_config_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        HealthPrep.showToast('Configuration exported successfully', 'success');
    })
    .catch(error => {
        console.error('Export error:', error);
        HealthPrep.showToast('Error exporting configuration', 'error');
    });
}

// Load keywords and display as badges
function loadKeywordsAsBadges() {
    const keywordContainers = document.querySelectorAll('.keywords-badges-container');
    console.log(`loadKeywordsAsBadges: Found ${keywordContainers.length} keyword containers to load`);
    
    keywordContainers.forEach(container => {
        const screeningTypeId = container.id.replace('keywords-display-', '');
        console.log(`loadKeywordsAsBadges: Loading keywords for screening ${screeningTypeId}`);
        
        fetch(`/screening/api/screening-keywords/${screeningTypeId}`)
        .then(response => {
            console.log(`loadKeywordsAsBadges: API response status for screening ${screeningTypeId}: ${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(`Received keywords data for screening ${screeningTypeId}:`, data);
            if (data.success && data.keywords && Array.isArray(data.keywords) && data.keywords.length > 0) {
                // Display keywords as badges
                const keywordsHtml = data.keywords.map(keyword => 
                    `<span class="badge bg-primary me-1 mb-1">${keyword}</span>`
                ).join('');
                container.innerHTML = keywordsHtml;
                console.log(`Successfully updated keywords display for screening ${screeningTypeId} with ${data.keywords.length} keywords`);
            } else {
                // Show no keywords message
                container.innerHTML = '<small class="text-muted">No keywords defined</small>';
                console.log(`No keywords found for screening ${screeningTypeId}`);
            }
        })
        .catch(error => {
            console.error(`Error loading keywords for screening ${screeningTypeId}:`, error);
            container.innerHTML = '<small class="text-danger">Error loading keywords</small>';
        });
    });
}

// Handle select all checkbox
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const screeningCheckboxes = document.querySelectorAll('.screening-checkbox');
    const batchActionButtons = document.querySelectorAll('.batch-action-btn');
    
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            screeningCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBatchActionButtons();
        });
    }
    
    screeningCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBatchActionButtons);
    });
    
    function updateBatchActionButtons() {
        const selectedCount = document.querySelectorAll('.screening-checkbox:checked').length;
        batchActionButtons.forEach(button => {
            button.disabled = selectedCount === 0;
        });
    }
    
    // Load keywords for display
    loadKeywordsAsBadges();
    
    // Also load after a delay to ensure DOM is fully ready
    setTimeout(() => {
        loadKeywordsAsBadges();
    }, 1000);
});
</script>
{% endblock %}

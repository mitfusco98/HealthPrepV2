INFO:routes.oauth_routes:OAuth redirect URI: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:routes.oauth_routes:Epic client ID: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:routes.oauth_routes:Epic auth URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize
INFO:emr.fhir_client:Epic OAuth Parameters:
INFO:emr.fhir_client:  response_type: code
INFO:emr.fhir_client:  client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:emr.fhir_client:  redirect_uri: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:emr.fhir_client:  scope: openid fhirUser patient/Patient.read patient/Condition.read patient/Observation.read patient/DocumentReference.read patient/Encounter.read user/Patient.read user/Condition.read user/Observation.read user/DocumentReference.read user/Encounter.read
INFO:emr.fhir_client:  aud: https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/
INFO:emr.fhir_client:  state: oq46lsgByhhax-4-E_4UW_QIfy56Pd2WJPf9KRU43hU
INFO:emr.fhir_client:Generated Epic authorization URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize?response_type=code&client_id=e57377e2-dfd5-4675-9659-58c33aa67b3f&redirect_uri=https%3A%2F%2F55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev%2Foauth%2Fepic-callback&scope=openid+fhirUser+patient%2FPatient.read+patient%2FCondition.read+patient%2FObservation.read+patient%2FDocumentReference.read+patient%2FEncounter.read+user%2FPatient.read+user%2FCondition.read+user%2FObservation.read+user%2FDocumentReference.read+user%2FEncounter.read&aud=https%3A%2F%2Ffhir.epic.com%2Finterconnect-fhir-oauth%2Fapi%2FFHIR%2FR4%2F&state=oq46lsgByhhax-4-E_4UW_QIfy56Pd2WJPf9KRU43hU
INFO:routes.oauth_routes:Starting Epic OAuth flow for organization 1
INFO:routes.oauth_routes:=== Epic OAuth Callback Debug ===
INFO:routes.oauth_routes:Request URL: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback?code=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00Njc1LTk2NTktNThjMzNhYTY3YjNmIiwiZXBpYy5lY2kiOiJ1cm46ZXBpYzpPcGVuLkVwaWMtY3VycmVudCIsImVwaWMubWV0YWRhdGEiOiJUUmxDbkxfRWJrc25nR19ONFJkX09oQXVxV0JLWWFEZFlBa2lIRnpMazZJR2NnWHpNQkdabjMzTS1vM1F4N0lxNUNWTjVyeGxQVFZlNW1BMkJVQ2xiS2ZNelhMS0s1Wm5SQzdvS29CLVJWb284RzNZUzNhUVZoUFd4anNNcFhfVCIsImVwaWMudG9rZW50eXBlIjoiY29kZSIsImV4cCI6MTc1NjQ4NDYyOSwiaWF0IjoxNzU2NDg0MzI5LCJpc3MiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwianRpIjoiMTQxYWM1MjItYTM2My00MGNhLTkzZmQtMmJmNWFkZTNhZWQxIiwibmJmIjoxNzU2NDg0MzI5LCJzdWIiOiJlNmF3Ni1SSnVLTzJtYnFqbGVLdmdWUTMifQ.rwQ94ZTnxEwIpS8vjhPye-wdqORBc1oeoLHjtMFpveJ-pwr95HGL32sBQtQf3g6Kp2LuJghxhPgL-siLIV-fbj5tJfRJJ_IPjz1wpolQSA76rKsOv3tq5wSZL-KNiEsRIx5N9ZxUWmJ7YfoXgW_45gc305pElSgiTLEPiFS1zGxLnU8-vQChQmrvINIXYxGMwa3QU1kIjmAVfwmQfQBq_1Plvwyeokjvtz1PYDljtTw1smvvPpLj6GvyU3ROwHg4ycBL6MQm3hC_lQ4HJNsUQBFwJYUzf5tGj8QFQCN85MUg1fdzSBtzIRpG3EH2GuILqCc_iuBFhZ9qv7uViHN3SA&state=oq46lsgByhhax-4-E_4UW_QIfy56Pd2WJPf9KRU43hU
INFO:routes.oauth_routes:Request method: GET
INFO:routes.oauth_routes:Request headers: {'Host': '55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev', 'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Replit/1.0.14 Chrome/124.0.6367.119 Electron/30.0.3 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Encoding': 'gzip, deflate, br', 'Accept-Language': 'en-US', 'Cookie': 'session=.eJztVtmyq7AR_JfzHJ-wY86bDQaDjYwxiyGVokAIsxkwi1lS-ffIvktycit_kAdRojU9mlGLLv7xESQt6tKPr74d0F8-giz--PogYUyzKBHoiKDhOiSSiIshT3IJyZMUG_ICycF1Ego0QTExy8Y0IZAkogSGpMKQTQREx3wkUCFBETEjCAQZ8UwEE34drtmYJYk1QYUcDyNeYEIq4fmYJ4mQiiAUEv612wcuZOhQ-7Ma_Aq7Ngn6ukAVBgRcXYISZs2SFE0jmk-EOKKYMIkFiqBihuVijkWQwzzUZDAIIURd95uOZi2NFJidMu1iLyoJMrVTK5OFosqpRXN1RE34fAXF7vkVRMI7w0VUWZzy3aBnDAOkzaBbO0Jf7PH4wix90EVmOuZw0GeGOkk35iSdMb4Z1WzMPGpqfJclrjiHmteZb9m0vkDat9TeV_wCXAgC5JA8WgUFrKIHVprrC0g9y6O9HNxfOfzrtvFmtvSo4ndNb2xpDKg4w7FwxtDVe492Znh3hljETd3f2BC5DuG5Zhoruxe39ix59kk589ym9l1niarUCW1ftIhUdAiHie79HDlC7VxNS7e08WyVrKUUjEc3BqAc5lzasy_JLbK9JdppbnTXTFSWh5MsPExLZsMqpsDOpyEtg1DxJtuNCyjJT_cKPI-Wa7fULHB3TI9MgeeSkj6TEpTN5FwIT1dhqKg0E1eWz_787x5iRWhfZ4iu2_J1hp4Lcv8Klh9nk44Ym8BiU1ibGY_lKGqNd8X65TsaWN5ysm6MLuk4X7nAGQtdOXOUN8_QPXP6hZmP-Y14aahb5wVYWN8Lns_MW18wM8sx95iXruAVI20ynP8RKy8tVAIooMAq0bpIzGAp86N1poC76z2c078Qk774-clVaW9RZ8-CL-7g3b0_a6sA6WW4trtNeVdIHR3tENu9od_JDLpN59s95ZO-qc_4gm5DTQVB5tvStGF4EFH64O4VazUvFBikNmZo4pHmbVvJB7UpFLQbu4fA23Zg67d4HKhsZL1rPO2k_LCuueSaAHhvdsMQj9LKuGnuk6nq4JFBdhrHu-gFh8g5zvpzLk95a6TsXtaKPmDb3F8RcxqwyEjgRn2ilZgBbU1zhXFQytaojCl4yjsGGukj2w8oRZOcM4c8OOrrRDh2QmSURdkZK8ewJYmVDPTYXd2isG6TyvKtpZ6HU5DKbJtMU6MM1XRDXe0PdB-VCJhXxSr0GrXnfbfLWT6bxNMlaPam6KWc_9gUIMl9R6T3hN_VdSmNi1WNvLAPi-OFXtHTyhW6pF8uvXFuZChqljv-toyhT4M-u6OuD-8NNg1sLOyKWK8owSK5L3L9RQqfJEsTNPGLUr85OL5HOL5-MFzZ3bZzmobTilntAsZ2g7OazCxnxJSrGYlwMG2GTu1fCZqwz1DVv02vGsryJ9yit0P_375-2JdKO1JMOqRm2osjxnuTC_PYD-Ut6161M7B8HUjqbFXayae0Ee5q1r_7o54716NL-kiRubCQC4dga8-WF3_n9cAROnsxtzbdPC1yK9q2Q52c8hkXZhaVDhNWW_JcOLLtbBObaCSLIKmzq4ELLSsenVohHQ_udTvg_EnsmGm0pJrt9sC__G_7wj3e8VjCd59livvldAuSINdZfP6jPo9Z-LI3HBtfteF0FxpfqrFG6oC1eek2AUknf-i2w_b0tiz6mOsDyF_63QiMj_o7f0OEF3w58g3r3U2s3405umcCW1IPJPOuzwSrKyA_YovSFYxLTonrWE5vLpv52Z-1QdrJftwFP40Xr7eLhrwQ6zlytSm8T-WF9iun3C1qRXyqk8Y4U9NeuzyV2mTDaFY_i_OygHIEx4OwmjlRYb0Vu3YizNqNSDhnSdFl01zN26co84BsTttzvfJWjZ-nwv60N-wLdPYTNyrTQw6zPX1gXcU4rVSZmSL_xpG9JBJydZXA8Xo79RLSNwPhmMW0t5NQj2nBr1Lc_9MbdPaxLfmcUE5rBhUwwrfYljyGxx_oNYfReIifVbIJBtYwNg__IppBVnCrNdOejok2Mcl2Zd66pDR5_XbibkZA5ALrHYXAOZPSVJMXslACItQaQTBlirY5XvTNC1s8yFLlArpSs8PxllPBGPNu2kQHJUkfRsOu5F153vZ6OO1vDF9Cd7KpVRgOzbPrGukhr8-_XONtCwGamgy7xH8a1doi-S-a_qLoT44SCIr-zuhg3bwIf_t4_Wn9dVOWqL3NatXXeBJWEH22KIwx5728zaqwnb9BYtgiowyr72BdxVmf1d9RKQtvVd31GTRRU7f998UaDnfseyZKUIv-e-NdBeuh6lH7DVXqsPwGHLPue9ZThJ_P8I9SjB8m-x1ra4jiof29c5JmrY1X8LROkjKr0M9_yBfQoAo79N__-S_vLMFx.aLHSyw.Wn0Bu6nAGKV7wInSpI40NGbDp_0', 'Referer': 'https://fhir.epic.com/', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'cross-site', 'Sec-Fetch-User': '?1', 'Upgrade-Insecure-Requests': '1', 'X-Forwarded-For': '69.207.59.155, 10.81.1.223', 'X-Forwarded-Proto': 'https', 'X-Replit-User-Bio': '', 'X-Replit-User-Id': '', 'X-Replit-User-Name': '', 'X-Replit-User-Profile-Image': '', 'X-Replit-User-Roles': '', 'X-Replit-User-Teams': '', 'X-Replit-User-Url': ''}
INFO:routes.oauth_routes:Query parameters received:
INFO:routes.oauth_routes:  - code: <present>
INFO:routes.oauth_routes:  - state: <present>
INFO:routes.oauth_routes:  - error: None
INFO:routes.oauth_routes:  - error_description: None
INFO:routes.oauth_routes:  - all query args: {'code': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00Njc1LTk2NTktNThjMzNhYTY3YjNmIiwiZXBpYy5lY2kiOiJ1cm46ZXBpYzpPcGVuLkVwaWMtY3VycmVudCIsImVwaWMubWV0YWRhdGEiOiJUUmxDbkxfRWJrc25nR19ONFJkX09oQXVxV0JLWWFEZFlBa2lIRnpMazZJR2NnWHpNQkdabjMzTS1vM1F4N0lxNUNWTjVyeGxQVFZlNW1BMkJVQ2xiS2ZNelhMS0s1Wm5SQzdvS29CLVJWb284RzNZUzNhUVZoUFd4anNNcFhfVCIsImVwaWMudG9rZW50eXBlIjoiY29kZSIsImV4cCI6MTc1NjQ4NDYyOSwiaWF0IjoxNzU2NDg0MzI5LCJpc3MiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwianRpIjoiMTQxYWM1MjItYTM2My00MGNhLTkzZmQtMmJmNWFkZTNhZWQxIiwibmJmIjoxNzU2NDg0MzI5LCJzdWIiOiJlNmF3Ni1SSnVLTzJtYnFqbGVLdmdWUTMifQ.rwQ94ZTnxEwIpS8vjhPye-wdqORBc1oeoLHjtMFpveJ-pwr95HGL32sBQtQf3g6Kp2LuJghxhPgL-siLIV-fbj5tJfRJJ_IPjz1wpolQSA76rKsOv3tq5wSZL-KNiEsRIx5N9ZxUWmJ7YfoXgW_45gc305pElSgiTLEPiFS1zGxLnU8-vQChQmrvINIXYxGMwa3QU1kIjmAVfwmQfQBq_1Plvwyeokjvtz1PYDljtTw1smvvPpLj6GvyU3ROwHg4ycBL6MQm3hC_lQ4HJNsUQBFwJYUzf5tGj8QFQCN85MUg1fdzSBtzIRpG3EH2GuILqCc_iuBFhZ9qv7uViHN3SA', 'state': 'oq46lsgByhhax-4-E_4UW_QIfy56Pd2WJPf9KRU43hU'}
INFO:routes.oauth_routes:Session state: oq46lsgByhhax-4-E_4UW_QIfy56Pd2WJPf9KRU43hU
INFO:routes.oauth_routes:Session user: True
INFO:routes.oauth_routes:================================
INFO:routes.oauth_routes:Token exchange - redirect URI: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:routes.oauth_routes:Token exchange - client ID: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:routes.oauth_routes:Token exchange - token URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/token
INFO:emr.fhir_client:Token exchange request:
INFO:emr.fhir_client:  - URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/token
INFO:emr.fhir_client:  - client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:emr.fhir_client:  - redirect_uri: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:emr.fhir_client:  - grant_type: authorization_code
INFO:emr.fhir_client:  - code: <present>
INFO:emr.fhir_client:Token exchange response:
INFO:emr.fhir_client:  - status_code: 200
INFO:emr.fhir_client:  - headers: {'Cache-Control': 'no-cache, no-store,no-store', 'Pragma': 'no-cache', 'Content-Type': 'application/json; charset=utf-8', 'Expires': '-1', 'Set-Cookie': 'ASP.NET_SessionId=ouqm1m5e5e0uy2ycdpnjdvow; path=/Interconnect-fhir-oauth; secure; HttpOnly; SameSite=Lax, EpicPersistenceCookie=!IwqQAgrVcHeIGUpc5iqg712Vrh0WW5rt3ds7SfohaEhp8soZ8eoDwfoomaxLR9nuZvATW1PgnC5ZLok=; path=/; Httponly; Secure', 'ServerMetrics': '{"BlockReads":58,"BlockWrites":5,"BlocksAllocated":0,"DBTime":36,"DatabaseCPUTime":30,"ECFNetworkTime":1,"ECFRequestCount":0,"ECFRequestTime":37,"GREF":2182,"JournalEntries":1,"LockWait":0.04,"LocksFailed":0,"LocksGranted":0,"MCommands":42523,"MemoryDifference":0,"NetworkCacheMisses":0,"NetworkUpdates":0,"WorkflowEventBlockReads":58,"WorkflowEventDBTime":36,"WorkflowEventECFNetworkTime":0,"WorkflowEventECFRequestCount":0,"WorkflowEventGREF":2182}', 'Strict-Transport-Security': 'max-age=31536000; includeSubDomains', 'X-Frame-Options': 'sameorigin', 'Access-Control-Allow-Headers': 'origin, authorization, accept, content-type, x-requested-with, prefer, Epic-User-ID, Epic-User-IDType, Epic-Client-ID, soapaction, Epic-MyChartUser-ID, Epic-MyChartUser-IDType', 'Access-Control-Allow-Methods': 'GET, HEAD, POST, PUT, DELETE, TRACE, OPTIONS', 'Access-Control-Allow-Origin': '*', 'Access-Control-Allow-Credentials': 'true', 'Date': 'Fri, 29 Aug 2025 16:18:49 GMT', 'Content-Length': '3386'}
INFO:emr.fhir_client:Successfully exchanged authorization code for Epic access token
INFO:routes.oauth_routes:Epic OAuth flow completed successfully for organization 1
ERROR:routes.oauth_routes:Error checking Epic OAuth status: 'EpicCredentials' object has no attribute 'token_scopes'
INFO:emr.fhir_client:Epic FHIR tokens set successfully
INFO:emr.fhir_client:Epic OAuth Parameters:
INFO:emr.fhir_client:  response_type: code
INFO:emr.fhir_client:  client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:emr.fhir_client:  redirect_uri: http://localhost:5000/oauth/epic-callback
INFO:emr.fhir_client:  scope: openid fhirUser patient/Patient.read patient/Condition.read patient/Observation.read patient/DocumentReference.read patient/Encounter.read user/Patient.read user/Condition.read user/Observation.read user/DocumentReference.read user/Encounter.read
INFO:emr.fhir_client:  aud: https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/
INFO:emr.fhir_client:  state: OxpCpkblYHpn36qBHvc3tcqXE-Bvw7L49X1ANlI-LeY
INFO:emr.fhir_client:Generated Epic authorization URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize?response_type=code&client_id=e57377e2-dfd5-4675-9659-58c33aa67b3f&redirect_uri=http%3A%2F%2Flocalhost%3A5000%2Foauth%2Fepic-callback&scope=openid+fhirUser+patient%2FPatient.read+patient%2FCondition.read+patient%2FObservation.read+patient%2FDocumentReference.read+patient%2FEncounter.read+user%2FPatient.read+user%2FCondition.read+user%2FObservation.read+user%2FDocumentReference.read+user%2FEncounter.read&aud=https%3A%2F%2Ffhir.epic.com%2Finterconnect-fhir-oauth%2Fapi%2FFHIR%2FR4%2F&state=OxpCpkblYHpn36qBHvc3tcqXE-Bvw7L49X1ANlI-LeY
INFO:routes.epic_registration_routes:Epic connection test successful for organization Default Organization

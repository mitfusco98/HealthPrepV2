Final sanity steps to prove Sandbox readiness
1) Re-confirm SMART discovery (fresh, right before testing)
ISS="https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4"
curl -sS "$ISS/.well-known/smart-configuration" | jq -r '.authorization_endpoint, .token_endpoint'
Copy the token endpoint value exactly (no edits, no extra slashes).
2) Build a client assertion using your nonprod client_id and kid 2025_08_A
CLIENT_ID="<YOUR_NONPROD_CLIENT_ID>"
TOKEN_URL="<PASTE_FROM_DISCOVERY>"
KID="2025_08_A"
PEM="./secrets/nonprod-current.key"   # your private key file

b64u() { openssl base64 -A | tr '+/' '-_' | tr -d '='; }
now=$(date +%s)
hdr='{"alg":"RS256","typ":"JWT","kid":"'"$KID"'"}'
pld='{"iss":"'"$CLIENT_ID"'","sub":"'"$CLIENT_ID"'","aud":"'"$TOKEN_URL"'","jti":"'"$(uuidgen)"'","iat":'"$now"',"exp":'"$((now+300))"'}'
h=$(printf %s "$hdr" | b64u); p=$(printf %s "$pld" | b64u)
sig=$(printf %s.%s "$h" "$p" | openssl dgst -sha256 -sign "$PEM" -binary | b64u)
ASSERTION="$h.$p.$sig"

echo "JWT header:" "$hdr"
echo "JWT payload:" "$pld"
Double-check: iss=sub=<NONPROD_CLIENT_ID>, aud=<exact TOKEN_URL>, kid=2025_08_A, and exp within 5 minutes.
3) Token request (pick your flow)
Backend service / client_credentials
curl -i "$TOKEN_URL" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data-urlencode "grant_type=client_credentials" \
  --data-urlencode "client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer" \
  --data-urlencode "client_assertion=$ASSERTION"
Authorization code (after an EHR launch)
curl -i "$TOKEN_URL" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  --data-urlencode "grant_type=authorization_code" \
  --data-urlencode "code=<AUTH_CODE_FROM_CALLBACK>" \
  --data-urlencode "redirect_uri=<YOUR_REDIRECT_URI_EXACTLY_AS_IN_EPIC>" \
  --data-urlencode "client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer" \
  --data-urlencode "client_assertion=$ASSERTION"
If you get invalid_client: it’s almost always one of these:
aud doesn’t equal the token URL byte-for-byte
iss/sub not the nonprod client_id
kid not found in nonprod JWKS (yours looks good: 2025_08_A)
iat/exp window off (system clock)
Sandbox hasn’t synced your last app save yet (wait ~60 min after the most recent “Ready for Sandbox”)
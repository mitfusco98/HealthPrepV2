ERROR:services.comprehensive_emr_sync:Error syncing patient appointments: (psycopg2.errors.UndefinedColumn) column appointment.org_id does not exist
LINE 1: ...appointment.patient_id AS appointment_patient_id, appointmen...
                                                             ^

[SQL: SELECT appointment.id AS appointment_id, appointment.patient_id AS appointment_patient_id, appointment.org_id AS appointment_org_id, appointment.appointment_date AS appointment_appointment_date, appointment.appointment_type AS appointment_appointment_type, appointment.provider AS appointment_provider, appointment.status AS appointment_status, appointment.notes AS appointment_notes, appointment.epic_appointment_id AS appointment_epic_appointment_id, appointment.fhir_appointment_resource AS appointment_fhir_appointment_resource, appointment.last_fhir_sync AS appointment_last_fhir_sync, appointment.created_at AS appointment_created_at, appointment.updated_at AS appointment_updated_at 
FROM appointment 
WHERE appointment.epic_appointment_id = %(epic_appointment_id_1)s AND appointment.org_id = %(org_id_1)s 
 LIMIT %(param_1)s]
[parameters: {'epic_appointment_id_1': 'eGFFFp0KKaZdjgF36sTfrjXaLjBH89aU3nWCXNCrJ4x03', 'org_id_1': 1, 'param_1': 1}]
(Background on this error at: https://sqlalche.me/e/20/f405)
INFO:services.comprehensive_emr_sync:Processing screening eligibility for patient erXuFYUfucBZaryVksYEcMg3
ERROR:services.comprehensive_emr_sync:Error processing screening eligibility: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: SELECT screening_type.id AS screening_type_id, screening_type.name AS screening_type_name, screening_type.org_id AS screening_type_org_id, screening_type.keywords AS screening_type_keywords, screening_type.eligible_genders AS screening_type_eligible_genders, screening_type.min_age AS screening_type_min_age, screening_type.max_age AS screening_type_max_age, screening_type.frequency_value AS screening_type_frequency_value, screening_type.frequency_unit AS screening_type_frequency_unit, screening_type.trigger_conditions AS screening_type_trigger_conditions, screening_type.is_active AS screening_type_is_active, screening_type.created_by AS screening_type_created_by, screening_type.created_at AS screening_type_created_at, screening_type.updated_at AS screening_type_updated_at, screening_type.fhir_search_params AS screening_type_fhir_search_params, screening_type.epic_query_context AS screening_type_epic_query_context, screening_type.fhir_condition_codes AS screening_type_fhir_condition_codes, screening_type.fhir_observation_codes AS screening_type_fhir_observation_codes, screening_type.fhir_document_types AS screening_type_fhir_document_types 
FROM screening_type 
WHERE screening_type.org_id = %(org_id_1)s]
[parameters: {'org_id_1': 1}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
ERROR:services.comprehensive_emr_sync:Error in comprehensive patient sync: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE patient SET last_fhir_sync=%(last_fhir_sync)s, updated_at=%(updated_at)s WHERE patient.id = %(patient_id)s]
[parameters: {'last_fhir_sync': datetime.datetime(2025, 10, 2, 18, 13, 32, 294388), 'updated_at': datetime.datetime(2025, 10, 2, 18, 13, 32, 295249), 'patient_id': 10}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/runner/workspace/services/comprehensive_emr_sync.py", line 138, in sync_patient_comprehensive
    db.session.commit()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py", line 599, in commit
    return self._proxied.commit()
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 85, in save_obj
    _emit_update_statements(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 912, in _emit_update_statements
    c = connection.execute(
        ^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1413, in execute
    return meth(
           ^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1635, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1840, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1980, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2349, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.InternalError: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE patient SET last_fhir_sync=%(last_fhir_sync)s, updated_at=%(updated_at)s WHERE patient.id = %(patient_id)s]
[parameters: {'last_fhir_sync': datetime.datetime(2025, 10, 2, 18, 13, 32, 294388), 'updated_at': datetime.datetime(2025, 10, 2, 18, 13, 32, 295249), 'patient_id': 10}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
INFO:services.comprehensive_emr_sync:Starting comprehensive sync for patient eq081-VQEgP8drUUqCWzHfw3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.comprehensive_emr_sync:Syncing patient demographics for eq081-VQEgP8drUUqCWzHfw3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.epic_fhir_service:Successfully synced patient eq081-VQEgP8drUUqCWzHfw3 from Epic
INFO:services.comprehensive_emr_sync:Successfully synced patient demographics: Derrick Lin
INFO:services.comprehensive_emr_sync:Syncing conditions for patient eq081-VQEgP8drUUqCWzHfw3
INFO:services.comprehensive_emr_sync:Syncing observations for patient eq081-VQEgP8drUUqCWzHfw3
INFO:services.comprehensive_emr_sync:Processed 0 screening-relevant observations
INFO:services.comprehensive_emr_sync:Syncing documents for patient eq081-VQEgP8drUUqCWzHfw3
INFO:services.comprehensive_emr_sync:Document has no date from Epic FHIR, using current date as fallback for sandbox testing
INFO:services.comprehensive_emr_sync:Processed 0 documents for screening analysis
INFO:services.comprehensive_emr_sync:Syncing encounters for patient eq081-VQEgP8drUUqCWzHfw3
INFO:services.comprehensive_emr_sync:Processed 0 encounters
INFO:services.comprehensive_emr_sync:Syncing appointments for patient eq081-VQEgP8drUUqCWzHfw3
ERROR:services.comprehensive_emr_sync:Error syncing patient appointments: (psycopg2.errors.UndefinedColumn) column appointment.org_id does not exist
LINE 1: ...appointment.patient_id AS appointment_patient_id, appointmen...
                                                             ^

[SQL: SELECT appointment.id AS appointment_id, appointment.patient_id AS appointment_patient_id, appointment.org_id AS appointment_org_id, appointment.appointment_date AS appointment_appointment_date, appointment.appointment_type AS appointment_appointment_type, appointment.provider AS appointment_provider, appointment.status AS appointment_status, appointment.notes AS appointment_notes, appointment.epic_appointment_id AS appointment_epic_appointment_id, appointment.fhir_appointment_resource AS appointment_fhir_appointment_resource, appointment.last_fhir_sync AS appointment_last_fhir_sync, appointment.created_at AS appointment_created_at, appointment.updated_at AS appointment_updated_at 
FROM appointment 
WHERE appointment.epic_appointment_id = %(epic_appointment_id_1)s AND appointment.org_id = %(org_id_1)s 
 LIMIT %(param_1)s]
[parameters: {'epic_appointment_id_1': 'evTiQA9oPDAS66tOkrTIbXVkgWPaOTrRcucSsvdoeNfI3', 'org_id_1': 1, 'param_1': 1}]
(Background on this error at: https://sqlalche.me/e/20/f405)
INFO:services.comprehensive_emr_sync:Processing screening eligibility for patient eq081-VQEgP8drUUqCWzHfw3
ERROR:services.comprehensive_emr_sync:Error processing screening eligibility: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: SELECT screening_type.id AS screening_type_id, screening_type.name AS screening_type_name, screening_type.org_id AS screening_type_org_id, screening_type.keywords AS screening_type_keywords, screening_type.eligible_genders AS screening_type_eligible_genders, screening_type.min_age AS screening_type_min_age, screening_type.max_age AS screening_type_max_age, screening_type.frequency_value AS screening_type_frequency_value, screening_type.frequency_unit AS screening_type_frequency_unit, screening_type.trigger_conditions AS screening_type_trigger_conditions, screening_type.is_active AS screening_type_is_active, screening_type.created_by AS screening_type_created_by, screening_type.created_at AS screening_type_created_at, screening_type.updated_at AS screening_type_updated_at, screening_type.fhir_search_params AS screening_type_fhir_search_params, screening_type.epic_query_context AS screening_type_epic_query_context, screening_type.fhir_condition_codes AS screening_type_fhir_condition_codes, screening_type.fhir_observation_codes AS screening_type_fhir_observation_codes, screening_type.fhir_document_types AS screening_type_fhir_document_types 
FROM screening_type 
WHERE screening_type.org_id = %(org_id_1)s]
[parameters: {'org_id_1': 1}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
ERROR:services.comprehensive_emr_sync:Error in comprehensive patient sync: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE patient SET last_fhir_sync=%(last_fhir_sync)s, updated_at=%(updated_at)s WHERE patient.id = %(patient_id)s]
[parameters: {'last_fhir_sync': datetime.datetime(2025, 10, 2, 18, 13, 34, 142557), 'updated_at': datetime.datetime(2025, 10, 2, 18, 13, 34, 143213), 'patient_id': 11}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/runner/workspace/services/comprehensive_emr_sync.py", line 138, in sync_patient_comprehensive
    db.session.commit()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py", line 599, in commit
    return self._proxied.commit()
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 85, in save_obj
    _emit_update_statements(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 912, in _emit_update_statements
    c = connection.execute(
        ^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1413, in execute
    return meth(
           ^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1635, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1840, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1980, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2349, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.InternalError: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE patient SET last_fhir_sync=%(last_fhir_sync)s, updated_at=%(updated_at)s WHERE patient.id = %(patient_id)s]
[parameters: {'last_fhir_sync': datetime.datetime(2025, 10, 2, 18, 13, 34, 142557), 'updated_at': datetime.datetime(2025, 10, 2, 18, 13, 34, 143213), 'patient_id': 11}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
INFO:services.comprehensive_emr_sync:Starting comprehensive sync for patient eAB3mDIBBcyUKviyzrxsnAw3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.comprehensive_emr_sync:Syncing patient demographics for eAB3mDIBBcyUKviyzrxsnAw3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.epic_fhir_service:Successfully synced patient eAB3mDIBBcyUKviyzrxsnAw3 from Epic
INFO:services.comprehensive_emr_sync:Successfully synced patient demographics: Desiree Caroline Powell
INFO:services.comprehensive_emr_sync:Syncing conditions for patient eAB3mDIBBcyUKviyzrxsnAw3
INFO:services.comprehensive_emr_sync:Syncing observations for patient eAB3mDIBBcyUKviyzrxsnAw3
INFO:services.comprehensive_emr_sync:Processed 0 screening-relevant observations
INFO:services.comprehensive_emr_sync:Syncing documents for patient eAB3mDIBBcyUKviyzrxsnAw3
INFO:services.comprehensive_emr_sync:Document has no date from Epic FHIR, using current date as fallback for sandbox testing
INFO:services.comprehensive_emr_sync:Processed 0 documents for screening analysis
INFO:services.comprehensive_emr_sync:Syncing encounters for patient eAB3mDIBBcyUKviyzrxsnAw3
INFO:services.comprehensive_emr_sync:Processed 0 encounters
INFO:services.comprehensive_emr_sync:Syncing appointments for patient eAB3mDIBBcyUKviyzrxsnAw3
ERROR:services.comprehensive_emr_sync:Error syncing patient appointments: (psycopg2.errors.UndefinedColumn) column appointment.org_id does not exist
LINE 1: ...appointment.patient_id AS appointment_patient_id, appointmen...
                                                             ^

[SQL: SELECT appointment.id AS appointment_id, appointment.patient_id AS appointment_patient_id, appointment.org_id AS appointment_org_id, appointment.appointment_date AS appointment_appointment_date, appointment.appointment_type AS appointment_appointment_type, appointment.provider AS appointment_provider, appointment.status AS appointment_status, appointment.notes AS appointment_notes, appointment.epic_appointment_id AS appointment_epic_appointment_id, appointment.fhir_appointment_resource AS appointment_fhir_appointment_resource, appointment.last_fhir_sync AS appointment_last_fhir_sync, appointment.created_at AS appointment_created_at, appointment.updated_at AS appointment_updated_at 
FROM appointment 
WHERE appointment.epic_appointment_id = %(epic_appointment_id_1)s AND appointment.org_id = %(org_id_1)s 
 LIMIT %(param_1)s]
[parameters: {'epic_appointment_id_1': 'epzVtRMYDrKx9yS1RmteOKnXnpmE1sqNcQf7OtVrXgkM3', 'org_id_1': 1, 'param_1': 1}]
(Background on this error at: https://sqlalche.me/e/20/f405)
INFO:services.comprehensive_emr_sync:Processing screening eligibility for patient eAB3mDIBBcyUKviyzrxsnAw3
ERROR:services.comprehensive_emr_sync:Error processing screening eligibility: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: SELECT screening_type.id AS screening_type_id, screening_type.name AS screening_type_name, screening_type.org_id AS screening_type_org_id, screening_type.keywords AS screening_type_keywords, screening_type.eligible_genders AS screening_type_eligible_genders, screening_type.min_age AS screening_type_min_age, screening_type.max_age AS screening_type_max_age, screening_type.frequency_value AS screening_type_frequency_value, screening_type.frequency_unit AS screening_type_frequency_unit, screening_type.trigger_conditions AS screening_type_trigger_conditions, screening_type.is_active AS screening_type_is_active, screening_type.created_by AS screening_type_created_by, screening_type.created_at AS screening_type_created_at, screening_type.updated_at AS screening_type_updated_at, screening_type.fhir_search_params AS screening_type_fhir_search_params, screening_type.epic_query_context AS screening_type_epic_query_context, screening_type.fhir_condition_codes AS screening_type_fhir_condition_codes, screening_type.fhir_observation_codes AS screening_type_fhir_observation_codes, screening_type.fhir_document_types AS screening_type_fhir_document_types 
FROM screening_type 
WHERE screening_type.org_id = %(org_id_1)s]
[parameters: {'org_id_1': 1}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
ERROR:services.comprehensive_emr_sync:Error in comprehensive patient sync: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE patient SET last_fhir_sync=%(last_fhir_sync)s, updated_at=%(updated_at)s WHERE patient.id = %(patient_id)s]
[parameters: {'last_fhir_sync': datetime.datetime(2025, 10, 2, 18, 13, 35, 776197), 'updated_at': datetime.datetime(2025, 10, 2, 18, 13, 35, 776795), 'patient_id': 12}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/runner/workspace/services/comprehensive_emr_sync.py", line 138, in sync_patient_comprehensive
    db.session.commit()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py", line 599, in commit
    return self._proxied.commit()
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 85, in save_obj
    _emit_update_statements(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 912, in _emit_update_statements
    c = connection.execute(
        ^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1413, in execute
    return meth(
           ^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1635, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1840, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1980, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2349, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.InternalError: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE patient SET last_fhir_sync=%(last_fhir_sync)s, updated_at=%(updated_at)s WHERE patient.id = %(patient_id)s]
[parameters: {'last_fhir_sync': datetime.datetime(2025, 10, 2, 18, 13, 35, 776197), 'updated_at': datetime.datetime(2025, 10, 2, 18, 13, 35, 776795), 'patient_id': 12}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
INFO:services.comprehensive_emr_sync:Starting comprehensive sync for patient egqBHVfQlt4Bw3XGXoxVxHg3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.comprehensive_emr_sync:Syncing patient demographics for egqBHVfQlt4Bw3XGXoxVxHg3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.epic_fhir_service:Successfully synced patient egqBHVfQlt4Bw3XGXoxVxHg3 from Epic
INFO:services.comprehensive_emr_sync:Successfully synced patient demographics: Elijah John Davis
INFO:services.comprehensive_emr_sync:Syncing conditions for patient egqBHVfQlt4Bw3XGXoxVxHg3
INFO:services.comprehensive_emr_sync:Syncing observations for patient egqBHVfQlt4Bw3XGXoxVxHg3
INFO:services.comprehensive_emr_sync:Processed 0 screening-relevant observations
INFO:services.comprehensive_emr_sync:Syncing documents for patient egqBHVfQlt4Bw3XGXoxVxHg3
INFO:services.comprehensive_emr_sync:Document has no date from Epic FHIR, using current date as fallback for sandbox testing
INFO:services.comprehensive_emr_sync:Processed 0 documents for screening analysis
INFO:services.comprehensive_emr_sync:Syncing encounters for patient egqBHVfQlt4Bw3XGXoxVxHg3
INFO:services.comprehensive_emr_sync:Patient egqBHVfQlt4Bw3XGXoxVxHg3 visit: Office Visit on 2019-05-24 00:00:00
INFO:services.comprehensive_emr_sync:Processed 1 encounters
INFO:services.comprehensive_emr_sync:Syncing appointments for patient egqBHVfQlt4Bw3XGXoxVxHg3
ERROR:services.comprehensive_emr_sync:Error syncing patient appointments: (psycopg2.errors.UndefinedColumn) column appointment.org_id does not exist
LINE 1: ...appointment.patient_id AS appointment_patient_id, appointmen...
                                                             ^

[SQL: SELECT appointment.id AS appointment_id, appointment.patient_id AS appointment_patient_id, appointment.org_id AS appointment_org_id, appointment.appointment_date AS appointment_appointment_date, appointment.appointment_type AS appointment_appointment_type, appointment.provider AS appointment_provider, appointment.status AS appointment_status, appointment.notes AS appointment_notes, appointment.epic_appointment_id AS appointment_epic_appointment_id, appointment.fhir_appointment_resource AS appointment_fhir_appointment_resource, appointment.last_fhir_sync AS appointment_last_fhir_sync, appointment.created_at AS appointment_created_at, appointment.updated_at AS appointment_updated_at 
FROM appointment 
WHERE appointment.epic_appointment_id = %(epic_appointment_id_1)s AND appointment.org_id = %(org_id_1)s 
 LIMIT %(param_1)s]
[parameters: {'epic_appointment_id_1': 'eBIwj8viFzhwmT9dRb-Y8PyY0n6WfglhV3mN3mI0ay303', 'org_id_1': 1, 'param_1': 1}]
(Background on this error at: https://sqlalche.me/e/20/f405)
INFO:services.comprehensive_emr_sync:Processing screening eligibility for patient egqBHVfQlt4Bw3XGXoxVxHg3
ERROR:services.comprehensive_emr_sync:Error processing screening eligibility: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: SELECT screening_type.id AS screening_type_id, screening_type.name AS screening_type_name, screening_type.org_id AS screening_type_org_id, screening_type.keywords AS screening_type_keywords, screening_type.eligible_genders AS screening_type_eligible_genders, screening_type.min_age AS screening_type_min_age, screening_type.max_age AS screening_type_max_age, screening_type.frequency_value AS screening_type_frequency_value, screening_type.frequency_unit AS screening_type_frequency_unit, screening_type.trigger_conditions AS screening_type_trigger_conditions, screening_type.is_active AS screening_type_is_active, screening_type.created_by AS screening_type_created_by, screening_type.created_at AS screening_type_created_at, screening_type.updated_at AS screening_type_updated_at, screening_type.fhir_search_params AS screening_type_fhir_search_params, screening_type.epic_query_context AS screening_type_epic_query_context, screening_type.fhir_condition_codes AS screening_type_fhir_condition_codes, screening_type.fhir_observation_codes AS screening_type_fhir_observation_codes, screening_type.fhir_document_types AS screening_type_fhir_document_types 
FROM screening_type 
WHERE screening_type.org_id = %(org_id_1)s]
[parameters: {'org_id_1': 1}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
ERROR:services.comprehensive_emr_sync:Error in comprehensive patient sync: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE patient SET last_fhir_sync=%(last_fhir_sync)s, updated_at=%(updated_at)s WHERE patient.id = %(patient_id)s]
[parameters: {'last_fhir_sync': datetime.datetime(2025, 10, 2, 18, 13, 37, 606472), 'updated_at': datetime.datetime(2025, 10, 2, 18, 13, 37, 607528), 'patient_id': 13}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/runner/workspace/services/comprehensive_emr_sync.py", line 138, in sync_patient_comprehensive
    db.session.commit()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py", line 599, in commit
    return self._proxied.commit()
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 85, in save_obj
    _emit_update_statements(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 912, in _emit_update_statements
    c = connection.execute(
        ^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1413, in execute
    return meth(
           ^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1635, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1840, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1980, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2349, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.InternalError: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE patient SET last_fhir_sync=%(last_fhir_sync)s, updated_at=%(updated_at)s WHERE patient.id = %(patient_id)s]
[parameters: {'last_fhir_sync': datetime.datetime(2025, 10, 2, 18, 13, 37, 606472), 'updated_at': datetime.datetime(2025, 10, 2, 18, 13, 37, 607528), 'patient_id': 13}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
INFO:services.comprehensive_emr_sync:Starting comprehensive sync for patient eIXesllypH3M9tAA5WdJftQ3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.comprehensive_emr_sync:Syncing patient demographics for eIXesllypH3M9tAA5WdJftQ3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.epic_fhir_service:Successfully synced patient eIXesllypH3M9tAA5WdJftQ3 from Epic
INFO:services.comprehensive_emr_sync:Successfully synced patient demographics: Linda Jane Ross
INFO:services.comprehensive_emr_sync:Syncing conditions for patient eIXesllypH3M9tAA5WdJftQ3
INFO:services.comprehensive_emr_sync:Syncing observations for patient eIXesllypH3M9tAA5WdJftQ3
INFO:services.comprehensive_emr_sync:Processed 0 screening-relevant observations
INFO:services.comprehensive_emr_sync:Syncing documents for patient eIXesllypH3M9tAA5WdJftQ3
INFO:services.comprehensive_emr_sync:Document has no date from Epic FHIR, using current date as fallback for sandbox testing
INFO:services.comprehensive_emr_sync:Processed 0 documents for screening analysis
INFO:services.comprehensive_emr_sync:Syncing encounters for patient eIXesllypH3M9tAA5WdJftQ3
INFO:services.comprehensive_emr_sync:Patient eIXesllypH3M9tAA5WdJftQ3 visit: Inpatient on 2019-05-24 20:32:25+00:00
INFO:services.comprehensive_emr_sync:Processed 1 encounters
INFO:services.comprehensive_emr_sync:Syncing appointments for patient eIXesllypH3M9tAA5WdJftQ3
INFO:services.comprehensive_emr_sync:Processed 0 appointments
INFO:services.comprehensive_emr_sync:Processing screening eligibility for patient eIXesllypH3M9tAA5WdJftQ3
INFO:services.comprehensive_emr_sync:Updating screening status for eIXesllypH3M9tAA5WdJftQ3: A1C Test - Due
INFO:services.comprehensive_emr_sync:Updating screening status for eIXesllypH3M9tAA5WdJftQ3: Lipid Panel - Due
INFO:services.comprehensive_emr_sync:Updating screening status for eIXesllypH3M9tAA5WdJftQ3: Electrocardiogram (ECG) - Due
INFO:services.comprehensive_emr_sync:Updating screening status for eIXesllypH3M9tAA5WdJftQ3: Cervical Cancer Screening - Due
INFO:services.comprehensive_emr_sync:Updating screening status for eIXesllypH3M9tAA5WdJftQ3: Colorectal Cancer Screening - Due
INFO:services.comprehensive_emr_sync:Updating screening status for eIXesllypH3M9tAA5WdJftQ3: Mammogram - Due
INFO:services.comprehensive_emr_sync:Updating screening status for eIXesllypH3M9tAA5WdJftQ3: Immunization Review - Due
INFO:services.comprehensive_emr_sync:Updated 7 screening statuses
INFO:services.comprehensive_emr_sync:Successfully completed comprehensive sync for patient eIXesllypH3M9tAA5WdJftQ3
INFO:services.comprehensive_emr_sync:Starting comprehensive sync for patient eh2xYHuzl9nkSFVvV3osUHg3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.comprehensive_emr_sync:Syncing patient demographics for eh2xYHuzl9nkSFVvV3osUHg3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.epic_fhir_service:Successfully synced patient eh2xYHuzl9nkSFVvV3osUHg3 from Epic
INFO:services.comprehensive_emr_sync:Successfully synced patient demographics: Olivia Anne Roberts
INFO:services.comprehensive_emr_sync:Syncing conditions for patient eh2xYHuzl9nkSFVvV3osUHg3
INFO:services.comprehensive_emr_sync:Syncing observations for patient eh2xYHuzl9nkSFVvV3osUHg3
INFO:services.comprehensive_emr_sync:Processed 0 screening-relevant observations
INFO:services.comprehensive_emr_sync:Syncing documents for patient eh2xYHuzl9nkSFVvV3osUHg3
INFO:services.comprehensive_emr_sync:Document has no date from Epic FHIR, using current date as fallback for sandbox testing
INFO:services.comprehensive_emr_sync:Processed 0 documents for screening analysis
INFO:services.comprehensive_emr_sync:Syncing encounters for patient eh2xYHuzl9nkSFVvV3osUHg3
INFO:services.comprehensive_emr_sync:Processed 0 encounters
INFO:services.comprehensive_emr_sync:Syncing appointments for patient eh2xYHuzl9nkSFVvV3osUHg3
INFO:services.comprehensive_emr_sync:Processed 0 appointments
INFO:services.comprehensive_emr_sync:Processing screening eligibility for patient eh2xYHuzl9nkSFVvV3osUHg3
INFO:services.comprehensive_emr_sync:Updating screening status for eh2xYHuzl9nkSFVvV3osUHg3: Cervical Cancer Screening - Due
INFO:services.comprehensive_emr_sync:Updating screening status for eh2xYHuzl9nkSFVvV3osUHg3: Immunization Review - Due
INFO:services.comprehensive_emr_sync:Updated 2 screening statuses
INFO:services.comprehensive_emr_sync:Successfully completed comprehensive sync for patient eh2xYHuzl9nkSFVvV3osUHg3
INFO:services.comprehensive_emr_sync:Starting comprehensive sync for patient e0w0LEDCYtfckT6N.CkJKCw3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.comprehensive_emr_sync:Syncing patient demographics for e0w0LEDCYtfckT6N.CkJKCw3
INFO:services.epic_fhir_service:Authentication verified for org 1
INFO:services.epic_fhir_service:Successfully synced patient e0w0LEDCYtfckT6N.CkJKCw3 from Epic
INFO:services.comprehensive_emr_sync:Successfully synced patient demographics: Warren James McGinnis
INFO:services.comprehensive_emr_sync:Syncing conditions for patient e0w0LEDCYtfckT6N.CkJKCw3
INFO:services.comprehensive_emr_sync:Syncing observations for patient e0w0LEDCYtfckT6N.CkJKCw3
INFO:services.comprehensive_emr_sync:Screening observation for e0w0LEDCYtfckT6N.CkJKCw3: 2093-3 = 187 mg/dL on 2019-05-28 15:59:00+00:00
INFO:services.comprehensive_emr_sync:Processed 1 screening-relevant observations
INFO:services.comprehensive_emr_sync:Syncing documents for patient e0w0LEDCYtfckT6N.CkJKCw3
INFO:services.comprehensive_emr_sync:Document has no date from Epic FHIR, using current date as fallback for sandbox testing
INFO:services.comprehensive_emr_sync:Processed 0 documents for screening analysis
INFO:services.comprehensive_emr_sync:Syncing encounters for patient e0w0LEDCYtfckT6N.CkJKCw3
INFO:services.comprehensive_emr_sync:Processed 0 encounters
INFO:services.comprehensive_emr_sync:Syncing appointments for patient e0w0LEDCYtfckT6N.CkJKCw3
ERROR:services.comprehensive_emr_sync:Error syncing patient appointments: (psycopg2.errors.UndefinedColumn) column appointment.org_id does not exist
LINE 1: ...appointment.patient_id AS appointment_patient_id, appointmen...
                                                             ^

[SQL: SELECT appointment.id AS appointment_id, appointment.patient_id AS appointment_patient_id, appointment.org_id AS appointment_org_id, appointment.appointment_date AS appointment_appointment_date, appointment.appointment_type AS appointment_appointment_type, appointment.provider AS appointment_provider, appointment.status AS appointment_status, appointment.notes AS appointment_notes, appointment.epic_appointment_id AS appointment_epic_appointment_id, appointment.fhir_appointment_resource AS appointment_fhir_appointment_resource, appointment.last_fhir_sync AS appointment_last_fhir_sync, appointment.created_at AS appointment_created_at, appointment.updated_at AS appointment_updated_at 
FROM appointment 
WHERE appointment.epic_appointment_id = %(epic_appointment_id_1)s AND appointment.org_id = %(org_id_1)s 
 LIMIT %(param_1)s]
[parameters: {'epic_appointment_id_1': 'eFIFqrdNNcaZqN8UsTYlUkM9JguzV4seQ-hO-443VxLA3', 'org_id_1': 1, 'param_1': 1}]
(Background on this error at: https://sqlalche.me/e/20/f405)
INFO:services.comprehensive_emr_sync:Processing screening eligibility for patient e0w0LEDCYtfckT6N.CkJKCw3
ERROR:services.comprehensive_emr_sync:Error processing screening eligibility: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: SELECT screening_type.id AS screening_type_id, screening_type.name AS screening_type_name, screening_type.org_id AS screening_type_org_id, screening_type.keywords AS screening_type_keywords, screening_type.eligible_genders AS screening_type_eligible_genders, screening_type.min_age AS screening_type_min_age, screening_type.max_age AS screening_type_max_age, screening_type.frequency_value AS screening_type_frequency_value, screening_type.frequency_unit AS screening_type_frequency_unit, screening_type.trigger_conditions AS screening_type_trigger_conditions, screening_type.is_active AS screening_type_is_active, screening_type.created_by AS screening_type_created_by, screening_type.created_at AS screening_type_created_at, screening_type.updated_at AS screening_type_updated_at, screening_type.fhir_search_params AS screening_type_fhir_search_params, screening_type.epic_query_context AS screening_type_epic_query_context, screening_type.fhir_condition_codes AS screening_type_fhir_condition_codes, screening_type.fhir_observation_codes AS screening_type_fhir_observation_codes, screening_type.fhir_document_types AS screening_type_fhir_document_types 
FROM screening_type 
WHERE screening_type.org_id = %(org_id_1)s]
[parameters: {'org_id_1': 1}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
ERROR:services.comprehensive_emr_sync:Error in comprehensive patient sync: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE patient SET last_fhir_sync=%(last_fhir_sync)s, updated_at=%(updated_at)s WHERE patient.id = %(patient_id)s]
[parameters: {'last_fhir_sync': datetime.datetime(2025, 10, 2, 18, 13, 44, 971265), 'updated_at': datetime.datetime(2025, 10, 2, 18, 13, 44, 971973), 'patient_id': 16}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/runner/workspace/services/comprehensive_emr_sync.py", line 138, in sync_patient_comprehensive
    db.session.commit()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py", line 599, in commit
    return self._proxied.commit()
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 85, in save_obj
    _emit_update_statements(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 912, in _emit_update_statements
    c = connection.execute(
        ^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1413, in execute
    return meth(
           ^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1635, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1840, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1980, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2349, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.InternalError: (psycopg2.errors.InFailedSqlTransaction) current transaction is aborted, commands ignored until end of transaction block

[SQL: UPDATE patient SET last_fhir_sync=%(last_fhir_sync)s, updated_at=%(updated_at)s WHERE patient.id = %(patient_id)s]
[parameters: {'last_fhir_sync': datetime.datetime(2025, 10, 2, 18, 13, 44, 971265), 'updated_at': datetime.datetime(2025, 10, 2, 18, 13, 44, 971973), 'patient_id': 16}]
(Background on this error at: https://sqlalche.me/e/20/2j85)
INFO:services.comprehensive_emr_sync:Discovery and sync completed: 2 patients synced, 9 screenings updated
INFO:werkzeug:10.81.5.79 - - [02/Oct/2025 18:13:45] "POST /api/refresh-screenings HTTP/1.1" 200 -
INFO:werkzeug:10.81.5.79 - - [02/Oct/2025 18:13:47] "GET / HTTP/1.1" 200 -
INFO:werkzeug:10.81.2.133 - - [02/Oct/2025 18:13:47] "GET /static/css/custom.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.4.220 - - [02/Oct/2025 18:13:47] "GET /static/css/loading-states.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.2.133 - - [02/Oct/2025 18:13:47] "GET /static/css/medical_terminology_ui.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.4.220 - - [02/Oct/2025 18:13:47] "GET /static/css/medical_styles.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.5.79 - - [02/Oct/2025 18:13:47] "GET /static/js/medical_terminology.js HTTP/1.1" 304 -
INFO:werkzeug:10.81.5.79 - - [02/Oct/2025 18:14:02] "GET /screening/list HTTP/1.1" 200 -
INFO:werkzeug:10.81.4.220 - - [02/Oct/2025 18:14:02] "GET /static/css/custom.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.2.133 - - [02/Oct/2025 18:14:02] "GET /static/css/medical_styles.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.2.133 - - [02/Oct/2025 18:14:02] "GET /static/css/loading-states.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.5.79 - - [02/Oct/2025 18:14:02] "GET /static/js/screening_modals.js HTTP/1.1" 304 -
INFO:werkzeug:10.81.2.133 - - [02/Oct/2025 18:14:02] "GET /static/js/screening_performance.js HTTP/1.1" 304 -
INFO:werkzeug:10.81.4.220 - - [02/Oct/2025 18:14:02] "GET /static/js/medical_terminology.js HTTP/1.1" 304 -
INFO:werkzeug:10.81.4.220 - - [02/Oct/2025 18:14:02] "GET /static/css/medical_terminology_ui.css HTTP/1.1" 304 -

HealthPrepV2 Multi-Tenancy Migration
====================================

This script will:
• Add organization tables and relationships
• Update existing models with org_id fields
• Create a default organization for existing data
• Migrate existing data to use the default organization

Are you sure you want to run this migration? (yes/no): yes
INFO:app:Database tables created successfully
Starting multi-tenancy migration...
4. Creating default organization...
   ✓ Default organization created
5. Migrating existing data to default organization...
   ✓ Migrated users to default organization

❌ Migration failed: (sqlite3.OperationalError) no such column: org_id
[SQL: UPDATE patient SET org_id = 1 WHERE org_id IS NULL;]
(Background on this error at: https://sqlalche.me/e/20/e3q8)

Troubleshooting:
- Check if the database file is locked
- Ensure no other processes are using the database
- Consider backing up your database before running migration
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
sqlite3.OperationalError: no such column: org_id

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/runner/workspace/migrate_multi_tenancy.py", line 198, in <module>
    run_migration()
  File "/home/runner/workspace/migrate_multi_tenancy.py", line 138, in run_migration
    db.session.execute(text("UPDATE patient SET org_id = 1 WHERE org_id IS NULL;"))
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py", line 779, in execute
    return self._proxied.execute(
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2365, in execute
    return self._execute_internal(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2260, in _execute_internal
    result = conn.execute(
             ^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1413, in execute
    return meth(
           ^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1635, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1840, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1980, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2349, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) no such column: org_id
[SQL: UPDATE patient SET org_id = 1 WHERE org_id IS NULL;]
(Background on this error at: https://sqlalche.me/e/20/e3q8)
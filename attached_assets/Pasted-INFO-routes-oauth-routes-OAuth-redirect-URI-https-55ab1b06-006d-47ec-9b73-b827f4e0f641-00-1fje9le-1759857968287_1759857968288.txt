INFO:routes.oauth_routes:OAuth redirect URI: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:routes.oauth_routes:Epic client ID: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:routes.oauth_routes:Epic auth URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize
INFO:services.epic_session_cleanup:Preparing for scope change - org: 1, scopes: ['openid', 'fhirUser', 'launch/patient', 'patient/Patient.read', 'patient/Observation.read', 'patient/Condition.read', 'patient/DocumentReference.read']
INFO:services.epic_session_cleanup:Scope changes detected for org 1:
INFO:services.epic_session_cleanup:  Added scopes: ['patient/Observation.read', 'patient/Condition.read', 'patient/Patient.read', 'launch/patient', 'patient/DocumentReference.read']
INFO:services.epic_session_cleanup:  Removed scopes: ['user/List.read', 'user/Encounter.read', 'user/Binary.read', 'user/Appointment.read', 'user/AllergyIntolerance.read', 'user/CarePlan.read', 'user/DocumentReference.read', 'user/Goal.read', 'user/DiagnosticReport.read', 'user/Observation.read', 'offline_access', 'user/Condition.read', 'user/Procedure.read', 'user/Patient.read']
INFO:services.epic_session_cleanup:Starting Epic session cleanup for org_id: 1
INFO:services.epic_session_cleanup:Epic session cleanup completed: {'session_keys_cleared': ['epic_access_token', 'epic_refresh_token', 'epic_token_expires', 'epic_token_scopes', 'epic_patient_id', 'epic_org_id', 'epic_scope_requested'], 'database_tokens_cleared': True, 'organization_status_reset': True, 'conflicts_resolved': 1, 'success': True, 'message': 'Epic sessions cleared successfully'}
INFO:routes.oauth_routes:Scope changes detected for org 1, session cleanup performed
INFO:emr.fhir_client:Epic OAuth Parameters:
INFO:emr.fhir_client:  response_type: code
INFO:emr.fhir_client:  client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:emr.fhir_client:  redirect_uri: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:emr.fhir_client:  scope: openid fhirUser patient/Patient.read patient/Condition.read patient/Observation.read patient/DocumentReference.read patient/Encounter.read patient/Appointment.read user/Patient.read user/Condition.read user/Observation.read user/DocumentReference.read user/Encounter.read
INFO:emr.fhir_client:  aud: https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/
INFO:emr.fhir_client:  state: R_sx4ZYa3l0b0ANs3zniayiA4bWvbdLgNLbgBTaCzeQ
INFO:emr.fhir_client:Generated Epic authorization URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize?response_type=code&client_id=e57377e2-dfd5-4675-9659-58c33aa67b3f&redirect_uri=https%3A%2F%2F55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev%2Foauth%2Fepic-callback&scope=openid+fhirUser+patient%2FPatient.read+patient%2FCondition.read+patient%2FObservation.read+patient%2FDocumentReference.read+patient%2FEncounter.read+patient%2FAppointment.read+user%2FPatient.read+user%2FCondition.read+user%2FObservation.read+user%2FDocumentReference.read+user%2FEncounter.read&aud=https%3A%2F%2Ffhir.epic.com%2Finterconnect-fhir-oauth%2Fapi%2FFHIR%2FR4%2F&state=R_sx4ZYa3l0b0ANs3zniayiA4bWvbdLgNLbgBTaCzeQ
INFO:routes.oauth_routes:Starting Epic OAuth flow for organization 1
INFO:werkzeug:10.81.4.85 - - [07/Oct/2025 17:18:03] "GET /oauth/epic-authorize HTTP/1.1" 302 -
INFO:routes.oauth_routes:=== Epic OAuth Callback Debug ===
INFO:routes.oauth_routes:Request URL: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback?code=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00Njc1LTk2NTktNThjMzNhYTY3YjNmIiwiZXBpYy5lY2kiOiJ1cm46ZXBpYzpPcGVuLkVwaWMtY3VycmVudCIsImVwaWMubWV0YWRhdGEiOiJZZDFwZ3BKTXI3Z004SmN1aEFmMG9XSWJhakYwdF9qcDRKNmFKUzNKMHp3R0o2S1NOWWhXbzdYaWxSWkZyemk1MFhMZEZlQldjWmZRZWllZlo3NFVEYWxXdFJIOHN2QVdXb2Rwd1dEa20xdi1ENnhEaDVIQ0JTMlJKZ0tnVHFkdiIsImVwaWMudG9rZW50eXBlIjoiY29kZSIsImV4cCI6MTc1OTg1Nzc5NCwiaWF0IjoxNzU5ODU3NDk0LCJpc3MiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwianRpIjoiNDNiYTYxOTMtMDFhNC00MGIyLTk3MTAtMTY2MzY0MzhiMGE1IiwibmJmIjoxNzU5ODU3NDk0LCJzdWIiOiJlNmF3Ni1SSnVLTzJtYnFqbGVLdmdWUTMifQ.e9zw9qFplAf5Zso-mNgghrTXVnsFifobzwmykZvqlTgkhU4LFTw_W-p2jSZCGEqk-RJUTpZwS-VplSEDGPRcUNR_tWXAuyGLsUuA9hjfMT5aMjFNBvmBwcicYvKFdEYpAxJ6HENaFECps-Jcit6lE_94lwnGQU906IY5naNY3t8wXinkFgJZCbRpS64FZq9yt6Qwkx3EHQQgEOK8gz3Zw81mBESI5xkTCF6hHxMvp0L74qWqsrErXuHuGoWgoz_iOf9H5ePOnTdhPD4WjP-iw9r8bJUUt019JIFT1P7hyQkQU0ZqVyprYq_qafauJwm-4fuP_904ZGYKFEAe1F2lZQ&state=R_sx4ZYa3l0b0ANs3zniayiA4bWvbdLgNLbgBTaCzeQ
INFO:routes.oauth_routes:Request method: GET
INFO:routes.oauth_routes:Request headers: {'Host': '55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev', 'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Replit/1.0.14 Chrome/124.0.6367.119 Electron/30.0.3 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Encoding': 'gzip, deflate, br', 'Accept-Language': 'en-US', 'Cookie': 'session=.eJyFUl1P3DAQ_CtRng-wHTu283aljwhaRFW1FYrW6_XF6p2T5gNREP-95noUUYF4Ws_uzO5qvPdlG7YwdTSVzY_7sphzKGMKfbkqL9bL3BUT9gMVdDtA8uSLuS9iwu3iqSkGmCOl-eTCTTTeZNCn45HAr_5VTvvk4yv5T3_jIbuFJWF3cig-sz72uOzy45ICjZSQ9vzy-uF6ldceaerKZh4Xyij6sik5-kpRsJVjFRpgwdUeNa8D11wo0JbXaALYignplfIVs5yTsJILABUsVV47K4AJ5qW1jDstHQZtwCivODNMQK3RaStBBK295gyEQ7RBP07LnrVLtuKwTYY4jaGd-5-UckLXTntnK1Qy74eBkCFzjksftEeQzlihvKSsoyFiC9n-do47mmbYDbmBYEIdcXbE9BXXDTcNE8fWSCX4k6TfazJ_psy_bKdb-f0bVFvm2Pp8qu5ShN9xLd3XG-fPNudnbvPhCk7v6PNTg_1vt9hB2tC7s421hpuX0pF-LVlEjw5knKIvQhfHL9mW__751WN486beOKn3buXhD3Od8u8.aOVLSg.ZrS4KdFYCAzEczpOwScu3JGsl08', 'Referer': 'https://fhir.epic.com/', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'cross-site', 'Sec-Fetch-User': '?1', 'Upgrade-Insecure-Requests': '1', 'X-Forwarded-For': '69.207.59.155, 10.81.4.85', 'X-Forwarded-Proto': 'https', 'X-Replit-User-Bio': '', 'X-Replit-User-Id': '', 'X-Replit-User-Name': '', 'X-Replit-User-Profile-Image': '', 'X-Replit-User-Roles': '', 'X-Replit-User-Teams': '', 'X-Replit-User-Url': ''}
INFO:routes.oauth_routes:Query parameters received:
INFO:routes.oauth_routes:  - code: <present>
INFO:routes.oauth_routes:  - state: <present>
INFO:routes.oauth_routes:  - error: None
INFO:routes.oauth_routes:  - error_description: None
INFO:routes.oauth_routes:  - all query args: {'code': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00Njc1LTk2NTktNThjMzNhYTY3YjNmIiwiZXBpYy5lY2kiOiJ1cm46ZXBpYzpPcGVuLkVwaWMtY3VycmVudCIsImVwaWMubWV0YWRhdGEiOiJZZDFwZ3BKTXI3Z004SmN1aEFmMG9XSWJhakYwdF9qcDRKNmFKUzNKMHp3R0o2S1NOWWhXbzdYaWxSWkZyemk1MFhMZEZlQldjWmZRZWllZlo3NFVEYWxXdFJIOHN2QVdXb2Rwd1dEa20xdi1ENnhEaDVIQ0JTMlJKZ0tnVHFkdiIsImVwaWMudG9rZW50eXBlIjoiY29kZSIsImV4cCI6MTc1OTg1Nzc5NCwiaWF0IjoxNzU5ODU3NDk0LCJpc3MiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwianRpIjoiNDNiYTYxOTMtMDFhNC00MGIyLTk3MTAtMTY2MzY0MzhiMGE1IiwibmJmIjoxNzU5ODU3NDk0LCJzdWIiOiJlNmF3Ni1SSnVLTzJtYnFqbGVLdmdWUTMifQ.e9zw9qFplAf5Zso-mNgghrTXVnsFifobzwmykZvqlTgkhU4LFTw_W-p2jSZCGEqk-RJUTpZwS-VplSEDGPRcUNR_tWXAuyGLsUuA9hjfMT5aMjFNBvmBwcicYvKFdEYpAxJ6HENaFECps-Jcit6lE_94lwnGQU906IY5naNY3t8wXinkFgJZCbRpS64FZq9yt6Qwkx3EHQQgEOK8gz3Zw81mBESI5xkTCF6hHxMvp0L74qWqsrErXuHuGoWgoz_iOf9H5ePOnTdhPD4WjP-iw9r8bJUUt019JIFT1P7hyQkQU0ZqVyprYq_qafauJwm-4fuP_904ZGYKFEAe1F2lZQ', 'state': 'R_sx4ZYa3l0b0ANs3zniayiA4bWvbdLgNLbgBTaCzeQ'}
INFO:routes.oauth_routes:Session state: R_sx4ZYa3l0b0ANs3zniayiA4bWvbdLgNLbgBTaCzeQ
INFO:routes.oauth_routes:Session user: True
INFO:routes.oauth_routes:================================
INFO:routes.oauth_routes:=== EPIC OAUTH CALLBACK USER DEBUG ===
INFO:routes.oauth_routes:Callback current user ID: 1
INFO:routes.oauth_routes:Callback current user username: admin
INFO:routes.oauth_routes:Callback current user org_id: 1
INFO:routes.oauth_routes:Callback current user organization object: <Organization Default Organization>
INFO:routes.oauth_routes:Callback Organization ID: 1
INFO:routes.oauth_routes:Callback Organization name: Default Organization
INFO:routes.oauth_routes:Callback Organization epic_client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:routes.oauth_routes:=======================================
INFO:routes.oauth_routes:Token exchange - redirect URI: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:routes.oauth_routes:Token exchange - client ID: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:routes.oauth_routes:Token exchange - token URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/token
INFO:emr.fhir_client:Token exchange request:
INFO:emr.fhir_client:  - URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/token
INFO:emr.fhir_client:  - client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:emr.fhir_client:  - redirect_uri: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:emr.fhir_client:  - grant_type: authorization_code
INFO:emr.fhir_client:  - code: <present>
INFO:emr.fhir_client:Token exchange response:
INFO:emr.fhir_client:  - status_code: 200
INFO:emr.fhir_client:  - headers: {'Cache-Control': 'no-cache, no-store,no-store', 'Pragma': 'no-cache', 'Content-Type': 'application/json; charset=utf-8', 'Expires': '-1', 'Set-Cookie': 'ASP.NET_SessionId=2dsgibw4cpa2lfbmwjo4ve1i; path=/Interconnect-fhir-oauth; secure; HttpOnly; SameSite=Lax, EpicPersistenceCookie=!Y/W7aZ9+pT+RuRNc5iqg712Vrh0WWw217LFnhIoCjXHLLGyymDthpXY/mGW6efYglmm8BvnIRRiTKAo=; path=/; Httponly; Secure', 'ServerMetrics': '{"BlockReads":13,"BlockWrites":9,"BlocksAllocated":3,"DBTime":36,"DatabaseCPUTime":31,"ECFNetworkTime":3,"ECFRequestCount":1,"ECFRequestTime":39,"GREF":2354,"JournalEntries":1,"LockWait":0.569,"LocksFailed":0,"LocksGranted":0,"MCommands":44620,"MemoryDifference":0,"NetworkCacheMisses":0,"NetworkUpdates":0,"WorkflowEventBlockReads":13,"WorkflowEventDBTime":36,"WorkflowEventECFNetworkTime":3,"WorkflowEventECFRequestCount":1,"WorkflowEventGREF":2354}', 'Strict-Transport-Security': 'max-age=31536000; includeSubDomains', 'X-Frame-Options': 'sameorigin', 'Access-Control-Allow-Headers': 'origin, authorization, accept, content-type, x-requested-with, prefer, Epic-User-ID, Epic-User-IDType, Epic-Client-ID, soapaction, Epic-MyChartUser-ID, Epic-MyChartUser-IDType', 'Access-Control-Allow-Methods': 'GET, HEAD, POST, PUT, DELETE, TRACE, OPTIONS', 'Access-Control-Allow-Origin': '*', 'Access-Control-Allow-Credentials': 'true', 'Date': 'Tue, 07 Oct 2025 17:18:15 GMT', 'Content-Length': '3408'}
INFO:emr.fhir_client:Successfully exchanged authorization code for Epic access token
INFO:routes.oauth_routes:Epic OAuth flow completed successfully for organization 1
INFO:werkzeug:10.81.4.85 - - [07/Oct/2025 17:18:15] "GET /oauth/epic-callback?code=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00Njc1LTk2NTktNThjMzNhYTY3YjNmIiwiZXBpYy5lY2kiOiJ1cm46ZXBpYzpPcGVuLkVwaWMtY3VycmVudCIsImVwaWMubWV0YWRhdGEiOiJZZDFwZ3BKTXI3Z004SmN1aEFmMG9XSWJhakYwdF9qcDRKNmFKUzNKMHp3R0o2S1NOWWhXbzdYaWxSWkZyemk1MFhMZEZlQldjWmZRZWllZlo3NFVEYWxXdFJIOHN2QVdXb2Rwd1dEa20xdi1ENnhEaDVIQ0JTMlJKZ0tnVHFkdiIsImVwaWMudG9rZW50eXBlIjoiY29kZSIsImV4cCI6MTc1OTg1Nzc5NCwiaWF0IjoxNzU5ODU3NDk0LCJpc3MiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwianRpIjoiNDNiYTYxOTMtMDFhNC00MGIyLTk3MTAtMTY2MzY0MzhiMGE1IiwibmJmIjoxNzU5ODU3NDk0LCJzdWIiOiJlNmF3Ni1SSnVLTzJtYnFqbGVLdmdWUTMifQ.e9zw9qFplAf5Zso-mNgghrTXVnsFifobzwmykZvqlTgkhU4LFTw_W-p2jSZCGEqk-RJUTpZwS-VplSEDGPRcUNR_tWXAuyGLsUuA9hjfMT5aMjFNBvmBwcicYvKFdEYpAxJ6HENaFECps-Jcit6lE_94lwnGQU906IY5naNY3t8wXinkFgJZCbRpS64FZq9yt6Qwkx3EHQQgEOK8gz3Zw81mBESI5xkTCF6hHxMvp0L74qWqsrErXuHuGoWgoz_iOf9H5ePOnTdhPD4WjP-iw9r8bJUUt019JIFT1P7hyQkQU0ZqVyprYq_qafauJwm-4fuP_904ZGYKFEAe1F2lZQ&state=R_sx4ZYa3l0b0ANs3zniayiA4bWvbdLgNLbgBTaCzeQ HTTP/1.1" 302 -
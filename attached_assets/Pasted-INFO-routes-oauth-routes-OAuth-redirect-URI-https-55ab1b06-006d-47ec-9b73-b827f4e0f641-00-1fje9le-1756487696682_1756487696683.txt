INFO:routes.oauth_routes:OAuth redirect URI: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:routes.oauth_routes:Epic client ID: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:routes.oauth_routes:Epic auth URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize
INFO:emr.fhir_client:Epic OAuth Parameters:
INFO:emr.fhir_client:  response_type: code
INFO:emr.fhir_client:  client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:emr.fhir_client:  redirect_uri: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:emr.fhir_client:  scope: openid fhirUser patient/Patient.read patient/Condition.read patient/Observation.read patient/DocumentReference.read patient/Encounter.read user/Patient.read user/Condition.read user/Observation.read user/DocumentReference.read user/Encounter.read
INFO:emr.fhir_client:  aud: https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/
INFO:emr.fhir_client:  state: Q1a72RvSJWVcl76OW9I804W8Ds0SbkEnFNkijqdZY-s
INFO:emr.fhir_client:Generated Epic authorization URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize?response_type=code&client_id=e57377e2-dfd5-4675-9659-58c33aa67b3f&redirect_uri=https%3A%2F%2F55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev%2Foauth%2Fepic-callback&scope=openid+fhirUser+patient%2FPatient.read+patient%2FCondition.read+patient%2FObservation.read+patient%2FDocumentReference.read+patient%2FEncounter.read+user%2FPatient.read+user%2FCondition.read+user%2FObservation.read+user%2FDocumentReference.read+user%2FEncounter.read&aud=https%3A%2F%2Ffhir.epic.com%2Finterconnect-fhir-oauth%2Fapi%2FFHIR%2FR4%2F&state=Q1a72RvSJWVcl76OW9I804W8Ds0SbkEnFNkijqdZY-s
INFO:routes.oauth_routes:Starting Epic OAuth flow for organization 1
INFO:werkzeug:10.81.1.223 - - [29/Aug/2025 17:09:12] "GET /oauth/epic-authorize HTTP/1.1" 302 -
INFO:werkzeug:10.81.1.223 - - [29/Aug/2025 17:09:17] "GET /oauth/epic-status HTTP/1.1" 200 -
INFO:werkzeug:10.81.1.223 - - [29/Aug/2025 17:09:17] "GET /oauth/epic-status HTTP/1.1" 200 -
INFO:emr.fhir_client:Epic OAuth Parameters:
INFO:emr.fhir_client:  response_type: code
INFO:emr.fhir_client:  client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:emr.fhir_client:  redirect_uri: http://localhost:5000/oauth/epic-callback
INFO:emr.fhir_client:  scope: openid fhirUser patient/Patient.read patient/Condition.read patient/Observation.read patient/DocumentReference.read patient/Encounter.read user/Patient.read user/Condition.read user/Observation.read user/DocumentReference.read user/Encounter.read
INFO:emr.fhir_client:  aud: https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/
INFO:emr.fhir_client:  state: nPpAwpPS9j1EuNArCsOJDSd5Ttw6sjnwlwYJuiOmeDM
INFO:emr.fhir_client:Generated Epic authorization URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize?response_type=code&client_id=e57377e2-dfd5-4675-9659-58c33aa67b3f&redirect_uri=http%3A%2F%2Flocalhost%3A5000%2Foauth%2Fepic-callback&scope=openid+fhirUser+patient%2FPatient.read+patient%2FCondition.read+patient%2FObservation.read+patient%2FDocumentReference.read+patient%2FEncounter.read+user%2FPatient.read+user%2FCondition.read+user%2FObservation.read+user%2FDocumentReference.read+user%2FEncounter.read&aud=https%3A%2F%2Ffhir.epic.com%2Finterconnect-fhir-oauth%2Fapi%2FFHIR%2FR4%2F&state=nPpAwpPS9j1EuNArCsOJDSd5Ttw6sjnwlwYJuiOmeDM
INFO:routes.epic_registration_routes:Epic connection test successful for organization Default Organization
INFO:werkzeug:10.81.1.223 - - [29/Aug/2025 17:10:39] "POST /admin/epic/registration/test-connection HTTP/1.1" 200 -
INFO:werkzeug:10.81.1.223 - - [29/Aug/2025 17:10:45] "GET /oauth/epic-status HTTP/1.1" 200 -
INFO:werkzeug:10.81.1.223 - - [29/Aug/2025 17:10:45] "GET /oauth/epic-status HTTP/1.1" 200 -
INFO:routes.oauth_routes:OAuth redirect URI: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:routes.oauth_routes:Epic client ID: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:routes.oauth_routes:Epic auth URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize
INFO:emr.fhir_client:Epic OAuth Parameters:
INFO:emr.fhir_client:  response_type: code
INFO:emr.fhir_client:  client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:emr.fhir_client:  redirect_uri: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:emr.fhir_client:  scope: openid fhirUser patient/Patient.read patient/Condition.read patient/Observation.read patient/DocumentReference.read patient/Encounter.read user/Patient.read user/Condition.read user/Observation.read user/DocumentReference.read user/Encounter.read
INFO:emr.fhir_client:  aud: https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/
INFO:emr.fhir_client:  state: hQu99Wlu0eO-W2CFtgEjP7bQQHW2qk45kFbgdWz1Kb4
INFO:emr.fhir_client:Generated Epic authorization URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize?response_type=code&client_id=e57377e2-dfd5-4675-9659-58c33aa67b3f&redirect_uri=https%3A%2F%2F55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev%2Foauth%2Fepic-callback&scope=openid+fhirUser+patient%2FPatient.read+patient%2FCondition.read+patient%2FObservation.read+patient%2FDocumentReference.read+patient%2FEncounter.read+user%2FPatient.read+user%2FCondition.read+user%2FObservation.read+user%2FDocumentReference.read+user%2FEncounter.read&aud=https%3A%2F%2Ffhir.epic.com%2Finterconnect-fhir-oauth%2Fapi%2FFHIR%2FR4%2F&state=hQu99Wlu0eO-W2CFtgEjP7bQQHW2qk45kFbgdWz1Kb4
INFO:routes.oauth_routes:Starting Epic OAuth flow for organization 1
INFO:werkzeug:10.81.1.223 - - [29/Aug/2025 17:11:20] "GET /oauth/epic-authorize HTTP/1.1" 302 -
INFO:routes.oauth_routes:=== Epic OAuth Callback Debug ===
INFO:routes.oauth_routes:Request URL: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback?code=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00Njc1LTk2NTktNThjMzNhYTY3YjNmIiwiZXBpYy5lY2kiOiJ1cm46ZXBpYzpPcGVuLkVwaWMtY3VycmVudCIsImVwaWMubWV0YWRhdGEiOiIySGF4VXE5czY4cE5Ic3VMZHQwdG5RWEpjWXZyaE1YR0RCdlZQa29heHNzQ0hQaExNRTBVS3VYLU1yQ09YbkVIVHJzMGJJNEN0TkhkWXFEZWQ4NlBPbEhfTmoyLXhhNkpmYUl6d3RuWTFuWmhOcVYxZUh2a3JOdnUxczk5U0xYRyIsImVwaWMudG9rZW50eXBlIjoiY29kZSIsImV4cCI6MTc1NjQ4Nzc5NSwiaWF0IjoxNzU2NDg3NDk1LCJpc3MiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwianRpIjoiZDg4NjdkNTUtMDkzZC00YjkxLWEwYTktOTFjOGUzYjI5Y2UwIiwibmJmIjoxNzU2NDg3NDk1LCJzdWIiOiJlNmF3Ni1SSnVLTzJtYnFqbGVLdmdWUTMifQ.J_hcrpigWa8Ppmd1u99haeXVX_uCv_Q0mp-LBVjtLvRsabk-K_g8K3fEPPpvHII3KKpNwtqKaC9aiYcMIPRcbXDpr7rSQ7IpIOhzNEFJswe3BtEUB1nKciY8bcVofruCPCgMbPeR03mArtBjj-enXNlXhAWlcK7NhtdR-jdBIIglfXzmnUM6-e3oUwOI7fc0gYZh4dFJkGH9UuxLGIBSOV0pwMbaEvNm3DhhJqDykyhF3gxnr8KYtyeteC49i3286FC-BbuZSo3PCq4a4BHiTmhZ9IcfjgrxlUgoKK6phr4cQV82cKz39c_KyJr1zdue8LRlUSKqLWrwPPAAHdUG5w&state=hQu99Wlu0eO-W2CFtgEjP7bQQHW2qk45kFbgdWz1Kb4
INFO:routes.oauth_routes:Request method: GET
INFO:routes.oauth_routes:Request headers: {'Host': '55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev', 'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Replit/1.0.14 Chrome/124.0.6367.119 Electron/30.0.3 Safari/537.36', 'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7', 'Accept-Encoding': 'gzip, deflate, br', 'Accept-Language': 'en-US', 'Cookie': 'session=.eJw1jstOAzEMRf9l1hTZTjIezxZRIbGASkizHCWO05ZSCvPYgPh3AoLlte7xPZ_NWCabD02_TKtdNeMxN32Dml2wIi6B0y5CSW1WxrYgI4XIgq12JYoD8jmE7EAQjcQjxRiKmMuchCIQZC8CmNgnLdzFLuSA0AHFljWx-EiFOTNCpKQqhX_Wmiqyzjb92dSo81TG5XKy13poNZlhUQZOWkWdi9mkU8OWjNAgx2SqvnL2dtQxrsthXI5nm5d4fqsPCChsoNuQPCH3iD3BtcMWAf-Ryy9T-4vV_mG3igwvK9jDZqCb7bK_fX7ktNvdDfR-8uG0Tfs8fOB98s3XN-1sY9M.aLHfOA.LoBgEate7osFTQfmDXXBWGItN9k', 'Referer': 'https://fhir.epic.com/', 'Sec-Fetch-Dest': 'document', 'Sec-Fetch-Mode': 'navigate', 'Sec-Fetch-Site': 'cross-site', 'Sec-Fetch-User': '?1', 'Upgrade-Insecure-Requests': '1', 'X-Forwarded-For': '69.207.59.155, 10.81.1.223', 'X-Forwarded-Proto': 'https', 'X-Replit-User-Bio': '', 'X-Replit-User-Id': '', 'X-Replit-User-Name': '', 'X-Replit-User-Profile-Image': '', 'X-Replit-User-Roles': '', 'X-Replit-User-Teams': '', 'X-Replit-User-Url': ''}
INFO:routes.oauth_routes:Query parameters received:
INFO:routes.oauth_routes:  - code: <present>
INFO:routes.oauth_routes:  - state: <present>
INFO:routes.oauth_routes:  - error: None
INFO:routes.oauth_routes:  - error_description: None
INFO:routes.oauth_routes:  - all query args: {'code': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00Njc1LTk2NTktNThjMzNhYTY3YjNmIiwiZXBpYy5lY2kiOiJ1cm46ZXBpYzpPcGVuLkVwaWMtY3VycmVudCIsImVwaWMubWV0YWRhdGEiOiIySGF4VXE5czY4cE5Ic3VMZHQwdG5RWEpjWXZyaE1YR0RCdlZQa29heHNzQ0hQaExNRTBVS3VYLU1yQ09YbkVIVHJzMGJJNEN0TkhkWXFEZWQ4NlBPbEhfTmoyLXhhNkpmYUl6d3RuWTFuWmhOcVYxZUh2a3JOdnUxczk5U0xYRyIsImVwaWMudG9rZW50eXBlIjoiY29kZSIsImV4cCI6MTc1NjQ4Nzc5NSwiaWF0IjoxNzU2NDg3NDk1LCJpc3MiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwianRpIjoiZDg4NjdkNTUtMDkzZC00YjkxLWEwYTktOTFjOGUzYjI5Y2UwIiwibmJmIjoxNzU2NDg3NDk1LCJzdWIiOiJlNmF3Ni1SSnVLTzJtYnFqbGVLdmdWUTMifQ.J_hcrpigWa8Ppmd1u99haeXVX_uCv_Q0mp-LBVjtLvRsabk-K_g8K3fEPPpvHII3KKpNwtqKaC9aiYcMIPRcbXDpr7rSQ7IpIOhzNEFJswe3BtEUB1nKciY8bcVofruCPCgMbPeR03mArtBjj-enXNlXhAWlcK7NhtdR-jdBIIglfXzmnUM6-e3oUwOI7fc0gYZh4dFJkGH9UuxLGIBSOV0pwMbaEvNm3DhhJqDykyhF3gxnr8KYtyeteC49i3286FC-BbuZSo3PCq4a4BHiTmhZ9IcfjgrxlUgoKK6phr4cQV82cKz39c_KyJr1zdue8LRlUSKqLWrwPPAAHdUG5w', 'state': 'hQu99Wlu0eO-W2CFtgEjP7bQQHW2qk45kFbgdWz1Kb4'}
INFO:routes.oauth_routes:Session state: hQu99Wlu0eO-W2CFtgEjP7bQQHW2qk45kFbgdWz1Kb4
INFO:routes.oauth_routes:Session user: True
INFO:routes.oauth_routes:================================
INFO:routes.oauth_routes:Token exchange - redirect URI: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:routes.oauth_routes:Token exchange - client ID: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:routes.oauth_routes:Token exchange - token URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/token
INFO:emr.fhir_client:Token exchange request:
INFO:emr.fhir_client:  - URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/token
INFO:emr.fhir_client:  - client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:emr.fhir_client:  - redirect_uri: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:emr.fhir_client:  - grant_type: authorization_code
INFO:emr.fhir_client:  - code: <present>
INFO:emr.fhir_client:Token exchange response:
INFO:emr.fhir_client:  - status_code: 200
INFO:emr.fhir_client:  - headers: {'Cache-Control': 'no-cache, no-store,no-store', 'Pragma': 'no-cache', 'Content-Type': 'application/json; charset=utf-8', 'Expires': '-1', 'Set-Cookie': 'ASP.NET_SessionId=cjzydo35xtjayuqvn4asg4t5; path=/Interconnect-fhir-oauth; secure; HttpOnly; SameSite=Lax, EpicPersistenceCookie=!jgOLOb2fPkviPx1c5iqg712Vrh0WW+afthaJKbds3xSiiCgiTjaJxyR0V9YMZky0uV9SdMdWz8RoLhg=; path=/; Httponly; Secure', 'ServerMetrics': '{"BlockReads":21,"BlockWrites":2,"BlocksAllocated":0,"DBTime":32,"DatabaseCPUTime":27,"ECFNetworkTime":0,"ECFRequestCount":0,"ECFRequestTime":32,"GREF":2175,"JournalEntries":1,"LockWait":0.043,"LocksFailed":0,"LocksGranted":0,"MCommands":42523,"MemoryDifference":0,"NetworkCacheMisses":0,"NetworkUpdates":0,"WorkflowEventBlockReads":21,"WorkflowEventDBTime":32,"WorkflowEventECFNetworkTime":0,"WorkflowEventECFRequestCount":0,"WorkflowEventGREF":2175}', 'Strict-Transport-Security': 'max-age=31536000; includeSubDomains', 'X-Frame-Options': 'sameorigin', 'Access-Control-Allow-Headers': 'origin, authorization, accept, content-type, x-requested-with, prefer, Epic-User-ID, Epic-User-IDType, Epic-Client-ID, soapaction, Epic-MyChartUser-ID, Epic-MyChartUser-IDType', 'Access-Control-Allow-Methods': 'GET, HEAD, POST, PUT, DELETE, TRACE, OPTIONS', 'Access-Control-Allow-Origin': '*', 'Access-Control-Allow-Credentials': 'true', 'Date': 'Fri, 29 Aug 2025 17:11:35 GMT', 'Content-Length': '3386'}
INFO:emr.fhir_client:Successfully exchanged authorization code for Epic access token
ERROR:routes.oauth_routes:Error handling Epic OAuth callback: (psycopg2.errors.StringDataRightTruncation) value too long for type character varying(255)

[SQL: UPDATE epic_credentials SET access_token=%(access_token)s, refresh_token=%(refresh_token)s, token_expires_at=%(token_expires_at)s, token_scope=%(token_scope)s, updated_at=%(updated_at)s WHERE epic_credentials.id = %(epic_credentials_id)s]
[parameters: {'access_token': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00 ... (754 characters truncated) ... NbEM-9wICb3FagWd5yq-mJn5I8GrS7B5WQALXuRPd8pyprjFJXWqVUZTfanao_zUDz9Khja2RZiynwPoh2fqTwxrT-koRipTfoOJv6z28wOio3CoemMgTa_WmePYiwPbVhZZWpg7ie7Rn0SQns6vg', 'refresh_token': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00 ... (733 characters truncated) ... MWV9T5xW_wDu9q9yIdb4gXjNAobg6oUDAm9XkihkIXFjTB8XTYyTCrji9Ccx85KjXXexRjoFqruF2mJwUhDXn8Qn1GSjrnCydYc50HxFe6DSBmr7hUrHohV1WODFDO20f69b7SK5FVXOc4bCSY-eg', 'token_expires_at': datetime.datetime(2025, 8, 29, 18, 11, 36, 99797), 'token_scope': 'user/AllergyIntolerance.read user/Binary.read user/CarePlan.read user/Condition.read user/DiagnosticReport.read user/DocumentReference.read user/Encounter.read user/Goal.read user/List.read user/Observation.read user/Patient.read user/Procedure.read fhirUser offline_access openid', 'updated_at': datetime.datetime(2025, 8, 29, 17, 11, 36, 122206), 'epic_credentials_id': 1}]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
Traceback (most recent call last):
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.StringDataRightTruncation: value too long for type character varying(255)


The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/home/runner/workspace/routes/oauth_routes.py", line 393, in epic_callback
    db.session.commit()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/scoping.py", line 599, in commit
    return self._proxied.commit()
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 2032, in commit
    trans.commit(_to_root=True)
  File "<string>", line 2, in commit
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1313, in commit
    self._prepare_impl()
  File "<string>", line 2, in _prepare_impl
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/state_changes.py", line 137, in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 1288, in _prepare_impl
    self.session.flush()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4345, in flush
    self._flush(objects)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4480, in _flush
    with util.safe_reraise():
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/util/langhelpers.py", line 224, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/session.py", line 4441, in _flush
    flush_context.execute()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 85, in save_obj
    _emit_update_statements(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/orm/persistence.py", line 912, in _emit_update_statements
    c = connection.execute(
        ^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1413, in execute
    return meth(
           ^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1635, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1840, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1980, in _exec_single_context
    self._handle_dbapi_exception(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2349, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1961, in _exec_single_context
    self.dialect.do_execute(
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 944, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.DataError: (psycopg2.errors.StringDataRightTruncation) value too long for type character varying(255)

[SQL: UPDATE epic_credentials SET access_token=%(access_token)s, refresh_token=%(refresh_token)s, token_expires_at=%(token_expires_at)s, token_scope=%(token_scope)s, updated_at=%(updated_at)s WHERE epic_credentials.id = %(epic_credentials_id)s]
[parameters: {'access_token': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00 ... (754 characters truncated) ... NbEM-9wICb3FagWd5yq-mJn5I8GrS7B5WQALXuRPd8pyprjFJXWqVUZTfanao_zUDz9Khja2RZiynwPoh2fqTwxrT-koRipTfoOJv6z28wOio3CoemMgTa_WmePYiwPbVhZZWpg7ie7Rn0SQns6vg', 'refresh_token': 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00 ... (733 characters truncated) ... MWV9T5xW_wDu9q9yIdb4gXjNAobg6oUDAm9XkihkIXFjTB8XTYyTCrji9Ccx85KjXXexRjoFqruF2mJwUhDXn8Qn1GSjrnCydYc50HxFe6DSBmr7hUrHohV1WODFDO20f69b7SK5FVXOc4bCSY-eg', 'token_expires_at': datetime.datetime(2025, 8, 29, 18, 11, 36, 99797), 'token_scope': 'user/AllergyIntolerance.read user/Binary.read user/CarePlan.read user/Condition.read user/DiagnosticReport.read user/DocumentReference.read user/Encounter.read user/Goal.read user/List.read user/Observation.read user/Patient.read user/Procedure.read fhirUser offline_access openid', 'updated_at': datetime.datetime(2025, 8, 29, 17, 11, 36, 122206), 'epic_credentials_id': 1}]
(Background on this error at: https://sqlalche.me/e/20/9h9h)
INFO:werkzeug:10.81.1.223 - - [29/Aug/2025 17:11:36] "GET /oauth/epic-callback?code=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJhdWQiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwiY2xpZW50X2lkIjoiZTU3Mzc3ZTItZGZkNS00Njc1LTk2NTktNThjMzNhYTY3YjNmIiwiZXBpYy5lY2kiOiJ1cm46ZXBpYzpPcGVuLkVwaWMtY3VycmVudCIsImVwaWMubWV0YWRhdGEiOiIySGF4VXE5czY4cE5Ic3VMZHQwdG5RWEpjWXZyaE1YR0RCdlZQa29heHNzQ0hQaExNRTBVS3VYLU1yQ09YbkVIVHJzMGJJNEN0TkhkWXFEZWQ4NlBPbEhfTmoyLXhhNkpmYUl6d3RuWTFuWmhOcVYxZUh2a3JOdnUxczk5U0xYRyIsImVwaWMudG9rZW50eXBlIjoiY29kZSIsImV4cCI6MTc1NjQ4Nzc5NSwiaWF0IjoxNzU2NDg3NDk1LCJpc3MiOiJ1cm46b2lkOjEuMi44NDAuMTE0MzUwLjEuMTMuMC4xLjcuMy42ODg4ODQuMTAwIiwianRpIjoiZDg4NjdkNTUtMDkzZC00YjkxLWEwYTktOTFjOGUzYjI5Y2UwIiwibmJmIjoxNzU2NDg3NDk1LCJzdWIiOiJlNmF3Ni1SSnVLTzJtYnFqbGVLdmdWUTMifQ.J_hcrpigWa8Ppmd1u99haeXVX_uCv_Q0mp-LBVjtLvRsabk-K_g8K3fEPPpvHII3KKpNwtqKaC9aiYcMIPRcbXDpr7rSQ7IpIOhzNEFJswe3BtEUB1nKciY8bcVofruCPCgMbPeR03mArtBjj-enXNlXhAWlcK7NhtdR-jdBIIglfXzmnUM6-e3oUwOI7fc0gYZh4dFJkGH9UuxLGIBSOV0pwMbaEvNm3DhhJqDykyhF3gxnr8KYtyeteC49i3286FC-BbuZSo3PCq4a4BHiTmhZ9IcfjgrxlUgoKK6phr4cQV82cKz39c_KyJr1zdue8LRlUSKqLWrwPPAAHdUG5w&state=hQu99Wlu0eO-W2CFtgEjP7bQQHW2qk45kFbgdWz1Kb4 HTTP/1.1" 302 -
INFO:werkzeug:10.81.1.223 - - [29/Aug/2025 17:11:36] "GET /admin/epic/registration HTTP/1.1" 200 -
INFO:werkzeug:10.81.4.99 - - [29/Aug/2025 17:11:36] "GET /static/css/custom.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.8.59 - - [29/Aug/2025 17:11:36] "GET /static/css/loading-states.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.8.59 - - [29/Aug/2025 17:11:38] "GET /oauth/epic-status HTTP/1.1" 200 -
INFO:werkzeug:10.81.1.223 - - [29/Aug/2025 17:11:38] "GET /admin/epic/registration HTTP/1.1" 200 -
INFO:werkzeug:10.81.4.99 - - [29/Aug/2025 17:11:38] "GET /static/css/custom.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.4.99 - - [29/Aug/2025 17:11:38] "GET /static/css/loading-states.css HTTP/1.1" 304 -
INFO:werkzeug:10.81.8.59 - - [29/Aug/2025 17:11:38] "GET /oauth/epic-status HTTP/1.1" 200 -
INFO:routes.oauth_routes:OAuth redirect URI: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:routes.oauth_routes:Epic client ID: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:routes.oauth_routes:Epic auth URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize
INFO:emr.fhir_client:Epic OAuth Parameters:
INFO:emr.fhir_client:  response_type: code
INFO:emr.fhir_client:  client_id: e57377e2-dfd5-4675-9659-58c33aa67b3f
INFO:emr.fhir_client:  redirect_uri: https://55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev/oauth/epic-callback
INFO:emr.fhir_client:  scope: openid fhirUser patient/Patient.read patient/Condition.read patient/Observation.read patient/DocumentReference.read patient/Encounter.read user/Patient.read user/Condition.read user/Observation.read user/DocumentReference.read user/Encounter.read
INFO:emr.fhir_client:  aud: https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4/
INFO:emr.fhir_client:  state: Z9vMqqdG73daHxggBrTdOl5eC4_8OKFQux1hkLCj2LE
INFO:emr.fhir_client:Generated Epic authorization URL: https://fhir.epic.com/interconnect-fhir-oauth/oauth2/authorize?response_type=code&client_id=e57377e2-dfd5-4675-9659-58c33aa67b3f&redirect_uri=https%3A%2F%2F55ab1b06-006d-47ec-9b73-b827f4e0f641-00-1fje9legmrd1y.riker.replit.dev%2Foauth%2Fepic-callback&scope=openid+fhirUser+patient%2FPatient.read+patient%2FCondition.read+patient%2FObservation.read+patient%2FDocumentReference.read+patient%2FEncounter.read+user%2FPatient.read+user%2FCondition.read+user%2FObservation.read+user%2FDocumentReference.read+user%2FEncounter.read&aud=https%3A%2F%2Ffhir.epic.com%2Finterconnect-fhir-oauth%2Fapi%2FFHIR%2FR4%2F&state=Z9vMqqdG73daHxggBrTdOl5eC4_8OKFQux1hkLCj2LE
INFO:routes.oauth_routes:Starting Epic OAuth flow for organization 1
INFO:werkzeug:10.81.4.99 - - [29/Aug/2025 17:11:45] "GET /oauth/epic-authorize HTTP/1.1" 302 -
INFO:werkzeug:10.81.4.99 - - [29/Aug/2025 17:11:56] "GET /oauth/epic-status HTTP/1.1" 200 -
INFO:werkzeug:10.81.4.99 - - [29/Aug/2025 17:11:56] "GET /oauth/epic-status HTTP/1.1" 200 -
